<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Varukorgen</title>
  <style>
    /* ===== Tema / grund ===== */
    :root{
      --bg:#fff8f8; --bg2:#fffdfd;
      --text:#262626; --text-soft:#474747; --text-invert:#ffffff;
      --accent:#e30613; --muted:#b3b3b3; --good:#1b8f4a; --bad:#cc1f1f;
      --card:#ffffff; --card-border:#efc9cc; --table-head:#c90f13;
      --card-text:#1f1f1f; --card-text-soft:#4a4a4a;
    }
    body{margin:0;background:
      radial-gradient(1200px 800px at 15% -10%, rgba(227,6,19,.08), transparent 60%),
      radial-gradient(1100px 900px at 110% 110%, rgba(185,0,12,.08), transparent 62%),
      radial-gradient(900px 700px at 50% 120%, rgba(214,20,28,.06), transparent 65%),
      linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text); font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px;position:relative}

    /* ===== Knappstrip ===== */
    .controls{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
    button{background:var(--card);color:var(--card-text);border:1px solid var(--card-border);padding:8px 10px;border-radius:10px;cursor:pointer;box-shadow:0 1px 1px rgba(0,0,0,.04);font-size:15px;min-height:40px}
    button.primary{background:var(--accent);color:#fff;border:0}
    button:hover{filter:brightness(.98)}
    .danger{background:#ffe5e6;border:1px solid #f3b4b8}

    /* ===== Kort / sm√•texter ===== */
    .small{font-size:13px;color:var(--text-soft);font-weight:800}
    .card{background:linear-gradient(180deg,#fff,#fff7f7);color:var(--card-text);border-radius:14px;padding:12px;border:1px solid var(--card-border);box-shadow:0 8px 24px rgba(0,0,0,.10);min-width:220px}
    .big{font-size:18px;font-weight:800}
    .good{color:var(--good)} .bad{color:var(--bad)}
    .salary-box{display:flex;gap:12px;align-items:center;margin:8px 0 14px}
    .salary-box input{font-size:16px;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;width:180px;min-height:44px}
    
    /* Veckov√§ljare */
    .week-selector{margin:8px 0 14px; padding:16px; background:linear-gradient(135deg, #f8f9fa, #e9ecef); border:1px solid var(--card-border); border-radius:12px;}
    .week-buttons{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0;}
    .week-btn{padding:10px 16px;border:2px solid var(--card-border);border-radius:8px;background:#fff;color:var(--text);font-weight:600;cursor:pointer;transition:all 0.2s ease;min-width:100px;text-align:center;}
    .week-btn:hover{background:#f8f9fa;transform:translateY(-1px);}
    .week-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 4px 12px rgba(227, 6, 19, 0.2);}
    .week-btn.active:hover{background:var(--accent);transform:translateY(-1px);}

    /* ===== Snabbknappar ===== */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);background:#fff;cursor:pointer}
    .chip .x{font-weight:900;opacity:.5;cursor:pointer}
    .chip .edit{font-weight:900;opacity:.7;cursor:pointer;margin-right:4px;}
    .chip .edit:hover{opacity:1;}
    
    /* L√§gg till snabbknapp knapp */
    #addChipBtn{background:var(--card); color:var(--card-text); border:1px solid var(--card-border); padding:6px 10px; border-radius:999px; font-size:13px; font-weight:500; cursor:pointer; transition:all 0.2s ease; box-shadow:0 1px 1px rgba(0,0,0,.04); display:inline-flex; align-items:center; gap:6px; margin-bottom:16px;}
    #addChipBtn:hover{filter:brightness(.98);}
    #addChipBtn.new-section{padding:4px 8px; font-size:11px; font-weight:400; background:#f8f9fa; color:#6c757d; border:1px solid #dee2e6; box-shadow:none; animation:pulse 2s infinite;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
    
    /* Sektioner */
    .section-header{display:flex; align-items:center; gap:8px; margin:16px 0 8px; padding:8px 12px; background:linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius:8px; border:1px solid var(--card-border);}
    .section-header h3{margin:0; font-size:16px; font-weight:700; color:var(--text);}
    .section-header .section-actions{display:flex; gap:4px; margin-left:auto;}
    .section-header button{background:transparent; border:1px solid var(--card-border); padding:4px 8px; border-radius:6px; font-size:12px; cursor:pointer; opacity:.7;}
    .section-header button:hover{opacity:1; background:var(--card);}
    .section-chips{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; min-height:40px; border:2px dashed transparent; border-radius:8px; padding:8px; transition:all 0.2s ease; width:100%;}
    .section-chips .chip{margin:0;}
    .section-chips.drag-over{border-color:#007bff; background-color:rgba(0,123,255,0.1);}
    .chip{cursor:grab; transition:all 0.2s ease;}
    .chip:active{cursor:grabbing;}
    .chip.dragging{opacity:0.5; transform:scale(1.05);}

    /* ===== Tabell ===== */
    .table-wrap{overflow:auto;background:var(--card);padding:8px;border-radius:12px;border:1px solid var(--card-border);margin-bottom:16px}
    table{width:100%;border-collapse:collapse;min-width:1300px;background:#fff;border-radius:10px;overflow:hidden}
    th,td{padding:10px 8px;border:1px solid #f1d3d5;text-align:left;vertical-align:middle}
    th{background:var(--table-head);color:#fff;font-weight:800;white-space:nowrap}
    .right{text-align:right}
    tr.done{background:#e9f8ee}
    tr.done td{border-color:#ccead3}

    /* Inputs i celler (grund) */
    td input[type="text"],
    td input[type="number"],
    td select{
      width:100%; box-sizing:border-box;
      border:1px solid var(--card-border);
      background:#fff; color:#1f1f1f;
      border-radius:10px; padding:10px 12px;
      font-size:16px; line-height:1.25; min-height:44px;
      appearance:none;
    }
    td input[readonly]{background:#fafafa}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }

    th.notes-col{min-width:220px}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .row-actions button{padding:8px 10px;min-height:40px}

    /* ======= NYTT: MER UTRYMME f√∂r Kategori/Typ/Betals√§tt ======= */
    th.category-col, td.category-col { min-width: 300px; }
    th.type-col,     td.type-col     { min-width: 180px; }
    th.pay-col,      td.pay-col      { min-width: 190px; }
    .category-col input,
    .type-col select,
    .pay-col select{
      min-height:64px;
      padding:14px 16px;
      font-size:18px;
      font-weight:600;
      line-height:1.3;
    }
    .type-col select option,
    .pay-col select option{ font-size:18px; }

    /* Summeringar */
    .sum-box{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px; margin-top:8px; }
    .card.salary{background:#fceef0;border-color:#f3c2c6}
    .card.income{background:#e9f8ee;border-color:#c2e9c9}
    .card.expense{background:#ffe8ea;border-color:#f3b4b8}
    .card.salaryLeft{background:#fff4e7;border-color:#f6d9b5}
    .card.balance,.card.buffer{background:#f6f7ff;border-color:#d7defa}

    /* Varukorgs-badge */
    .cart-fab{
      position:fixed; top:80px; right:16px; z-index:11;
      display:inline-flex; align-items:center; gap:8px;
      background:linear-gradient(135deg,#fff,#fff7f7);
      border:1px solid var(--card-border); border-radius:14px;
      padding:8px 10px; box-shadow:0 6px 18px rgba(0,0,0,.18); color:#1f1f1f;
    }
    .cart-fab .count{min-width:22px;height:22px;line-height:22px;text-align:center;border-radius:11px;padding:0 6px;font-weight:900;font-size:13px;background:var(--accent);color:#fff}

    /* Mobil */
    @media (max-width:600px){
      .wrap{ padding:14px }
      .salary-box{ flex-direction:column; align-items:stretch }
      .salary-box input{ width:90% }
      .sum-box{ grid-template-columns:repeat(2,minmax(0,1fr)) }
      table{ min-width:1100px }
      .cart-fab{ top:90px; right:12px }

      th.category-col, td.category-col { min-width: 320px; }
      th.type-col,     td.type-col     { min-width: 200px; }
      th.pay-col,      td.pay-col      { min-width: 210px; }
      .category-col input,
      .type-col select,
      .pay-col select{ min-height:60px; font-size:19px; }
    }
    @media (max-width:360px){
      .sum-box{ grid-template-columns:1fr; }
    }

    /* Modal (kvitto) */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:99998;}
    .modal{position:fixed; inset:0; display:none; place-items:center; z-index:99999;}
    .modal.open,.modal-backdrop.open{display:grid}
    .modal-card{width:min(92vw,720px); background:#fff; color:#1f1f1f; border-radius:16px; border:1px solid var(--card-border); box-shadow:0 20px 80px rgba(0,0,0,.35); overflow:hidden;}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(0,0,0,.08)}
    .modal-body{padding:12px 14px; display:grid; gap:10px}
    .modal-actions{display:flex; gap:8px; justify-content:flex-end; padding:12px 14px; border-top:1px solid rgba(0,0,0,.08)}
    .modal input[type="email"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--card-border); background:#fff; color:#1f1f1f; font-size:16px; min-height:44px}
    .receipt{font:14px/1.4 ui-sans-serif; background:#fff; color:#222; border:1px dashed #e5a3a8; border-radius:12px; padding:12px; max-height:46vh; overflow:auto;}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px; background:#f6f6f6}

    /* Rabattverktyg modal */
    .discount-modal .modal-card{width:min(92vw,600px);}
    .discount-type{display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:6px; margin:12px 0;}
    .discount-type button{background:#f8f9fa; border:2px solid var(--card-border); padding:10px 6px; border-radius:10px; cursor:pointer; transition:all 0.2s; font-size:13px; font-weight:600; text-align:center; line-height:1.2;}
    .discount-type button.active{background:var(--accent); color:#fff; border-color:var(--accent);}
    .discount-type button:hover{background:#e9ecef;}
    .discount-type button.active:hover{background:var(--accent);}
    .discount-inputs{display:grid; gap:12px; margin:16px 0;}
    .discount-inputs label{font-weight:600; color:var(--text); margin-bottom:4px; display:block;}
    .discount-inputs input, .discount-inputs select{width:100%; padding:10px 12px; border:1px solid var(--card-border); border-radius:10px; background:#fff; color:#1f1f1f; font-size:16px; min-height:44px;}
    .discount-inputs input[type="number"]{max-width:150px;}
    .discount-preview{background:#f8f9fa; border:1px solid var(--card-border); border-radius:12px; padding:12px; margin:12px 0; font-size:14px;}
    .discount-preview .preview-title{font-weight:600; margin-bottom:8px; color:var(--text);}
    .discount-preview .preview-details{color:var(--text-soft);}

    /* Snabbknappverktyg modal */
    .quick-tool-modal .modal-card{width:min(92vw,500px);}
    .quick-tool-type{display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:8px; margin:12px 0;}
    .quick-tool-type button{background:#f8f9fa; border:2px solid var(--card-border); padding:12px 8px; border-radius:12px; cursor:pointer; transition:all 0.2s; font-size:14px; font-weight:600;}
    .quick-tool-type button.active{background:var(--accent); color:#fff; border-color:var(--accent);}
    .quick-tool-type button:hover{background:#e9ecef;}
    .quick-tool-type button.active:hover{background:var(--accent);}
    .quick-tool-inputs{display:grid; gap:12px; margin:16px 0;}
    .quick-tool-inputs label{font-weight:600; color:var(--text); margin-bottom:4px; display:block;}
    .quick-tool-inputs input, .quick-tool-inputs select{width:100%; padding:10px 12px; border:1px solid var(--card-border); border-radius:10px; background:#fff; color:#1f1f1f; font-size:16px; min-height:44px;}
    .quick-tool-inputs input[type="number"]{max-width:150px;}
    .quick-tool-preview{background:#f8f9fa; border:1px solid var(--card-border); border-radius:12px; padding:12px; margin:12px 0; font-size:14px;}
    .quick-tool-preview .preview-title{font-weight:600; margin-bottom:8px; color:var(--text);}
    .quick-tool-preview .preview-details{color:var(--text-soft);}

    /* ===== Glasig vaktsk√§rm ===== */
    .gate{position:fixed; inset:0; display:grid; place-items:center; z-index:100000; backdrop-filter: blur(14px); background:rgba(23,19,20,.28);}
    .gate .panel{ width:clamp(300px, 92vw, 420px); border-radius:20px; padding:18px 16px 14px; background:linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.72)); border:1px solid rgba(255,255,255,.55); box-shadow:0 20px 80px rgba(0,0,0,.40); }
    .gate h1{margin:6px 0 12px; font-size:20px; text-align:center;}
    .pinbox{display:flex; gap:8px; justify-content:center; margin:6px 0 12px}
    .pinbox input{width:54px; height:54px; border-radius:12px; text-align:center; font-size:22px; letter-spacing:2px; border:1px solid #e8c5c7; background:#fff}
    .kbd{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin:8px 0}
    .kbd button{font-size:18px; min-height:52px; border-radius:14px}
    .gate .row{display:flex; justify-content:space-between; align-items:center}
    .gate .hint{font-size:12px; color:#777}
    .hidden{display:none !important}

    /* Stor tumv√§nlig checkruta */
    .checkcell{ display:inline-flex; align-items:center; justify-content:center; width:44px; height:44px; cursor:pointer; user-select:none; }
    .checkcell input{ position:absolute; opacity:0; width:0; height:0; }
    .checkcell .box{ position:relative; width:28px; height:28px; border-radius:8px; border:2px solid #d7a7aa; background:#fff; box-shadow: inset 0 1px 0 rgba(0,0,0,.03); }
    .checkcell input:focus-visible + .box{ box-shadow:0 0 0 3px rgba(227,6,19,.35); }
    .checkcell input:checked + .box{ background:linear-gradient(180deg,#e30613,#cc0d18); border-color:#a90b11; }
    .checkcell input:checked + .box::after{ content:""; position:absolute; left:8px; top:4px; width:8px; height:16px; border:3px solid #fff; border-top:0; border-left:0; transform:rotate(45deg); }
    th:first-child, td:first-child{ width:56px; }

    /* ===== M√∂rkt l√§ge ===== */
    :root {
      --bg-color: #ffffff;
      --card-bg: #ffffff;
      --text-color: #1f1f1f;
      --text-soft: #6c757d;
      --card-border: #e1e5e9;
      --table-head: #e30613;
    }

    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --text-color: #ffffff;
      --text-soft: #b0b0b0;
      --card-border: #404040;
      --table-head: #e30613;
    }

    html {
      background-color: var(--bg-color);
      transition: background-color 0.3s ease;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    .wrap {
      background-color: var(--bg-color);
      transition: background-color 0.3s ease;
    }

    .card {
      background: var(--card-bg);
      color: var(--text-color);
      border-color: var(--card-border);
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    .small {
      color: var(--text-soft);
    }

    th {
      background: var(--table-head);
    }

    td input[type="text"],
    td input[type="number"],
    td select {
      background: var(--card-bg);
      color: var(--text-color);
      border-color: var(--card-border);
    }

    .chip {
      background: var(--card-bg);
      color: var(--text-color);
      border-color: var(--card-border);
    }

    .gate .panel {
      background: var(--card-bg);
      color: var(--text-color);
    }

    .gate h1 {
      color: var(--text-color);
    }

    .table-wrap {
      background-color: var(--card-bg);
      border-color: var(--card-border);
    }

    table {
      background-color: var(--card-bg);
    }

    .sum-box {
      background-color: var(--bg-color);
    }

    .week-selector {
      background: var(--card-bg);
      border-color: var(--card-border);
    }

    .week-btn {
      background: var(--card-bg);
      color: var(--text-color);
      border-color: var(--card-border);
    }

    .week-btn:hover {
      background: var(--bg-color);
    }

    .logo {
      color: var(--accent);
    }

    [data-theme="dark"] .mobile-menu {
      background: rgba(45, 45, 45, 0.95);
      border-color: rgba(255, 255, 255, 0.1);
    }

    [data-theme="dark"] .mobile-menu-overlay {
      background: rgba(0, 0, 0, 0.6);
    }

    /* M√∂rk scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-color);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--card-border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-soft);
    }

    /* ===== Mobil hamburgermeny ===== */
    .mobile-only {
      display: none;
    }

    .desktop-only {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Hamburgermeny knapp - stor och touch-v√§nlig */
    #mobileMenuBtn {
      min-width: 60px !important;
      min-height: 60px !important;
      font-size: 24px !important;
      border-radius: 16px !important;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
      border: 2px solid var(--card-border) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
      transition: all 0.2s ease !important;
      display: none !important;
      align-items: center !important;
      justify-content: center !important;
    }

    #mobileMenuBtn:hover {
      transform: translateY(-2px) !important;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
      background: linear-gradient(135deg, #e9ecef, #dee2e6) !important;
    }

    #mobileMenuBtn:active {
      transform: translateY(0) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }

    .mobile-menu {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 1000;
      min-width: 280px;
      max-width: 90vw;
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .mobile-menu button {
      display: block;
      width: 100%;
      margin: 8px 0;
      text-align: left;
      min-height: 50px;
      font-size: 16px;
      padding: 12px 16px;
      border-radius: 12px;
    }

    .mobile-menu.show {
      display: block;
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .mobile-menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .mobile-menu-overlay.show {
      display: block;
      opacity: 1;
    }

    /* Mobil responsiv design */
    @media (max-width: 768px) {
      .mobile-only {
        display: inline-flex;
      }
      
      .desktop-only {
        display: none;
      }
      
      #mobileMenuBtn {
        display: flex !important;
      }
      
      .controls {
        justify-content: space-between;
      }
      
      /* Summary cards stapling p√• mobil */
      .sum-box {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
      }
    }
  </style>
</head>
<body>
  <!-- Varukorgs-badge -->
  <div class="cart-fab" id="cartFab" role="button" tabindex="0" title="Visa kvitto / skicka">
    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" style="width:22px;height:22px"><path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm10 0a2 2 0 1 0 .001 3.999A2 2 0 0 0 17 18ZM3 3h2l2.4 10.4A3 3 0 0 0 10.3 16h6.9a3 3 0 0 0 2.9-2.2L22 7H6.2" fill="currentColor"/></svg>
    <span id="cartCount" class="count">0</span>
  </div>

  <div class="wrap" aria-live="polite">
    <!-- Knapp-list -->
    <div class="controls">
      <button class="primary" id="addRowBtn">+ L√§gg till vara</button>
      <button id="sectionsBtn">Sektioner</button>
      <button id="darkModeBtn" title="V√§xla m√∂rkt/ljust l√§ge">üåô</button>
      
      <!-- Desktop knappar -->
      <div class="desktop-only">
        <button id="shareBtn">Dela l√§nk</button>
        <button id="copyBtn">Kopiera</button>
        <button id="clearChecksBtn">Rensa check</button>
        <button id="logoutBtn">Logga ut</button>
        <button id="resetBtn" class="danger" title="Nollst√§ll bara kategorier (beh√•ll snabbknappar och sektioner)">Nollst√§ll</button>
        <button id="resetMemBtn" title="Rensa lagrade kategorier">Nollst√§ll minne</button>
        <button id="deleteAllBtn" class="danger" title="Radera ALLT - kategorier, snabbknappar och sektioner">Delete All</button>
      </div>
      
      <!-- Mobil hamburgermeny - h√∂ger upp -->
      <button id="mobileMenuBtn" class="mobile-only" title="Meny">‚ò∞</button>
      <button id="clearChecksBtn" class="mobile-only">Rensa check</button>
    </div>
    
    <!-- Mobil dropdown meny -->
    <div id="mobileMenuOverlay" class="mobile-menu-overlay"></div>
    <div id="mobileMenu" class="mobile-menu">
      <button id="mobileShareBtn">Dela l√§nk</button>
      <button id="mobileCopyBtn">Kopiera</button>
      <button id="mobileLogoutBtn">Logga ut</button>
      <button id="mobileResetBtn">Nollst√§ll</button>
      <button id="mobileResetMemBtn">Nollst√§ll minne</button>
      <button id="mobileDeleteAllBtn" class="danger">Delete All</button>
    </div>

    <!-- L√§gg till snabbknapp - fast placerad -->
    <div style="margin-bottom: 16px;">
      <button id="addChipBtn" title="L√§gg till snabbknapp">+ L√§gg till snabbknapp</button>
    </div>

    <!-- Veckov√§ljare -->
    <div class="card week-selector">
      <div class="small">V√§lj vecka</div>
      <div class="week-buttons">
        <button class="week-btn active" data-week="1">Vecka 1</button>
        <button class="week-btn" data-week="2">Vecka 2</button>
        <button class="week-btn" data-week="3">Vecka 3</button>
        <button class="week-btn" data-week="4">Vecka 4</button>
        <button class="week-btn" data-week="quick">Snabbhandla</button>
      </div>
      <div class="small">Varje vecka har sin egen matlista och budget</div>
    </div>

    <!-- Snabbknappar -->
    <div class="chips" id="chips">
    </div>

    <!-- M√•nadsbudget -->
    <div class="card salary-box">
      <div>
        <div class="small">M√•nads netto</div>
        <input id="salaryInput" type="number" step="1" min="0" placeholder="t.ex. 3 500 (matbudget)" />
      </div>
      <div class="small">Anv√§nds i ber√§kningarna: <strong>M√•nads netto ‚àí (Totala varukorgen ‚àí Kampanjer)</strong></div>
    </div>

    <!-- Tabell -->
    <div class="table-wrap card">
      <table id="budgetTable" aria-label="Varukorg">
        <thead>
          <tr>
            <th>‚úì</th>
            <th class="category-col">Kategori</th>
            <th style="width:110px">Antal</th>
            <th style="width:110px">Enhet</th>
            <th style="width:140px">√†-pris (nu)</th>
            <th style="width:140px">Ord. √†-pris</th>
            <th style="width:120px">Belopp</th>
            <th class="type-col">Typ</th>
            <th class="pay-col">Betals√§tt</th>
            <th class="notes-col">Anteckningar</th>
            <th style="width:230px">√Ötg√§rd</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="11" class="empty-cell" style="padding:18px;color:#9b9b9b;text-align:center"><em>Inga rader √§nnu ‚Äî klicka <strong>+ L√§gg till vara</strong> eller anv√§nd en snabbknapp.</em></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Summering -->
    <div class="sum-box">
      <div class="card salary"><div class="small">Matkostnad</div><div id="salaryDisplay" class="big">0 kr</div></div>
      <div class="card salaryLeft"><div class="small">Kvar i matpengar</div><div id="salaryLeft" class="big">0 kr</div></div>
      <div class="card income"><div class="small">Kampanjer</div><div id="totalIncome" class="big good">0 kr</div></div>
      <div class="card expense"><div class="small">Totala varukorgen</div><div id="totalExpense" class="big bad">0 kr</div></div>
      <div class="card balance"><div class="small">Att betala i kassan</div><div id="balance" class="big">0 kr</div></div>
      <div class="card buffer"><div class="small">Sparat p√• maten</div><div id="buffer" class="big">0 kr</div></div>
    </div>
  </div>

  <!-- Kvitto-modal -->
  <div class="modal-backdrop" id="receiptBackdrop" aria-hidden="true"></div>
  <div class="modal" id="receiptModal" role="dialog" aria-modal="true" aria-labelledby="receiptTitle" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="receiptTitle" style="margin:0;font-size:18px;">Kvitto</h3>
        <span class="pill" id="receiptMeta">‚Äì</span>
        <button id="receiptCloseBtn" title="St√§ng">St√§ng</button>
      </div>
      <div class="modal-body">
        <label class="small" for="receiptEmail">Skicka till e-post</label>
        <input type="email" id="receiptEmail" placeholder="namn@exempel.se" />
        <div class="receipt" id="receiptPreview"><em>Inget att visa √§nnu.</em></div>
      </div>
      <div class="modal-actions">
        <button id="receiptCopyBtn">Kopiera HTML</button>
        <button id="receiptPdfBtn">Spara PDF</button>
        <button id="receiptPrintBtn">Skriv ut</button>
        <button class="primary" id="receiptSendBtn">Skicka</button>
      </div>
    </div>
  </div>

  <!-- Rabattverktyg modal -->
  <div class="modal-backdrop" id="discountBackdrop" aria-hidden="true"></div>
  <div class="modal discount-modal" id="discountModal" role="dialog" aria-modal="true" aria-labelledby="discountTitle" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="discountTitle" style="margin:0;font-size:18px;">Rabattverktyg</h3>
        <button id="discountCloseBtn" title="St√§ng">St√§ng</button>
      </div>
      <div class="modal-body">
        <div class="discount-type">
          <button type="button" data-type="percentage" class="active">Procent (%)</button>
          <button type="button" data-type="fixed">Fast belopp</button>
          <button type="button" data-type="campaign-price">Kampanjpris per produkt</button>
          <button type="button" data-type="2-for-1">Ta 2 betala f√∂r 1</button>
          <button type="button" data-type="3-for-2">3-f√∂r-2</button>
          <button type="button" data-type="4-for-2">Ta 4 betala f√∂r 2</button>
          <button type="button" data-type="5-for-3">Ta 5 betala f√∂r 3</button>
          <button type="button" data-type="x-for-n">Anpassad X f√∂r N</button>
          <button type="button" data-type="second-half">2:a till halvpris</button>
        </div>
        
        <div class="discount-inputs" id="discountInputs">
          <!-- Inputs kommer att genereras dynamiskt baserat p√• vald typ -->
        </div>
        
        <div class="discount-preview" id="discountPreview">
          <div class="preview-title">F√∂rhandsvisning</div>
          <div class="preview-details">V√§lj rabatttyp och fyll i v√§rden f√∂r att se resultatet</div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="discountCancelBtn">Avbryt</button>
        <button class="primary" id="discountApplyBtn">Till√§mpa rabatt</button>
      </div>
    </div>
  </div>

  <!-- Snabbknappverktyg modal -->
  <div class="modal-backdrop" id="quickToolBackdrop" aria-hidden="true"></div>
  <div class="modal quick-tool-modal" id="quickToolModal" role="dialog" aria-modal="true" aria-labelledby="quickToolTitle" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="quickToolTitle" style="margin:0;font-size:18px;">Snabbknappverktyg</h3>
        <button id="quickToolCloseBtn" title="St√§ng">St√§ng</button>
      </div>
      <div class="modal-body">
        <div class="quick-tool-type">
          <button type="button" data-type="simple" class="active">Enkel snabbknapp</button>
          <button type="button" data-type="with-price">Med pris</button>
          <button type="button" data-type="with-category">Med kategori</button>
          <button type="button" data-type="complete">Komplett</button>
        </div>
        
        <div class="quick-tool-inputs" id="quickToolInputs">
          <!-- Inputs kommer att genereras dynamiskt baserat p√• vald typ -->
        </div>
        
        <div class="quick-tool-preview" id="quickToolPreview">
          <div class="preview-title">F√∂rhandsvisning</div>
          <div class="preview-details">V√§lj typ och fyll i v√§rden f√∂r att se resultatet</div>
        </div>
      </div>
      <div class="modal-actions">
        <button id="quickToolCancelBtn">Avbryt</button>
        <button class="primary" id="quickToolApplyBtn">üöÄ Skapa & L√§gg till snabbknapp</button>
      </div>
    </div>
  </div>

  <!-- Sektionsverktyg modal -->
  <div class="modal-backdrop" id="sectionsBackdrop" aria-hidden="true"></div>
  <div class="modal" id="sectionsModal" role="dialog" aria-modal="true" aria-labelledby="sectionsTitle" aria-hidden="true">
    <div class="modal-card" style="width:min(92vw,700px);">
      <div class="modal-head">
        <h3 id="sectionsTitle" style="margin:0;font-size:18px;">Hantera Sektioner</h3>
        <button id="sectionsCloseBtn" title="St√§ng">St√§ng</button>
      </div>
      <div class="modal-body">
        <div style="display:flex; gap:8px; margin-bottom:16px;">
          <input type="text" id="newSectionName" placeholder="Ny sektion (t.ex. Frukost)" style="flex:1;">
          <button id="addSectionBtn" class="primary">L√§gg till sektion</button>
        </div>
        <div id="sectionsList">
          <!-- Sektioner kommer att genereras dynamiskt -->
        </div>
      </div>
      <div class="modal-actions">
        <button id="sectionsCancelBtn">St√§ng</button>
      </div>
    </div>
  </div>

  <!-- Glasig vaktsk√§rm -->
  <div class="gate hidden" id="gate">
    <div class="panel">
      <h1>Varukorgen</h1>
      <form id="pinForm" autocomplete="off">
        <div class="pinbox">
          <input id="pin" inputmode="numeric" type="tel" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" aria-label="PIN-kod" />
        </div>
        <div class="kbd">
          <button type="button" data-k="1">1</button><button type="button" data-k="2">2</button><button type="button" data-k="3">3</button>
          <button type="button" data-k="4">4</button><button type="button" data-k="5">5</button><button type="button" data-k="6">6</button>
          <button type="button" data-k="7">7</button><button type="button" data-k="8">8</button><button type="button" data-k="9">9</button>
          <button type="button" id="clearPin">C</button><button type="button" data-k="0">0</button><button type="submit" id="okPin">OK</button>
        </div>
      </form>
      <div class="row"><span class="hint">S√§ker session st√§ngs efter 60 min inaktivitet</span></div>
    </div>
  </div>

  <!-- NY: datalist f√∂r kategoriminnet (f√∂rslagsmeny) -->
  <datalist id="catMemList"></datalist>

<script>
(function(){
  const CLOUD = {
    endpoint: 'https://script.google.com/macros/s/AKfycbxG3zENX_dIBGbn1zzNWJo9UnZikx-TofN7VjqaYmkQv0ghaPXJ_xB5jhd_3WQOsQ_R/exec',
    secret: 'VarukrogenSecret123'
  };
  function cloudKey(){ const u = new URL(location.href); return (u.searchParams.get('key')||'').trim(); }
  function ensureKey(){ if (CLOUD.endpoint && !cloudKey()){ const k=(crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2,10)); const url=new URL(location.href); url.searchParams.set('key',k); history.replaceState(null,'',url);} }
  function cloudEnabled(){ return !!CLOUD.endpoint && !!cloudKey(); }
  function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),wait); }; }

  function payload(){
    return {
      rows,
      salary,
      quickItems: JSON.parse(localStorage.getItem('cart_quick_items')||'[]'),
      sections: JSON.parse(localStorage.getItem('cart_sections')||'[]'),
      updatedAt: Date.now()
    };
  }

  async function cloudSave(){
    if(!cloudEnabled()) return;
    try{
      const form = new URLSearchParams();
      form.set('op','save');
      form.set('key', cloudKey());
      form.set('secret', CLOUD.secret||'');
      form.set('data', JSON.stringify(payload()));
      const res = await fetch(CLOUD.endpoint, { method:'POST', body: form });
      await res.text();
      showCloudStatus('Autosparat ‚úîÔ∏é');
    }catch(err){
      showCloudStatus('Kunde inte autospara');
    }
  }

  async function cloudLoad(){
    if(!cloudEnabled()) return;
    try{
      const url = `${CLOUD.endpoint}?op=load&key=${encodeURIComponent(cloudKey())}&secret=${encodeURIComponent(CLOUD.secret||'')}`;
      const res = await fetch(url, { method:'GET' });
      const text = await res.text();
      let json; try{ json = JSON.parse(text); }catch(_){}
      const data = (json && json.ok && json.data) ? json.data : json;

      if(data && Array.isArray(data.rows)){
        rows = data.rows;
        salary = Number(data.salary)||0;
        salaryInput.value = salary || '';
        showCloudStatus('Moln laddat ‚úîÔ∏é');
      }

      // Ladda snabbknappar och sektioner fr√•n molnet
      if (data && Array.isArray(data.quickItems)) {
        localStorage.setItem('cart_quick_items', JSON.stringify(data.quickItems));
      }
      if (data && Array.isArray(data.sections)) {
        localStorage.setItem('cart_sections', JSON.stringify(data.sections));
      }

    }catch(err){
      console.warn('Moln load fel:', err);
      showCloudStatus('Molnfel vid laddning');
    }finally{
      render(); updateTotals(); loadChips();
    }
  }

  function showCloudStatus(message){
    // Skapa status-indikator om den inte finns
    let statusEl = document.getElementById('cloudStatus');
    if(!statusEl){
      statusEl = document.createElement('div');
      statusEl.id = 'cloudStatus';
      statusEl.style.cssText = 'text-align:center;margin:8px 0;color:var(--good);font-weight:600;font-size:14px;';
      document.querySelector('.wrap').insertBefore(statusEl, document.querySelector('.salary-box'));
    }
    statusEl.textContent = message;
    statusEl.style.color = message.includes('‚úîÔ∏é') ? 'var(--good)' : 'var(--bad)';
    
    // D√∂lj status efter 3 sekunder
    if(message.includes('‚úîÔ∏é')){
      setTimeout(() => {
        if(statusEl.textContent === message) statusEl.textContent = '';
      }, 3000);
    }
  }

  const cloudSaveDebounced = debounce(cloudSave, 1000);

  const tbody = document.getElementById('tbody');
  const addRowBtn = document.getElementById('addRowBtn');
  const shareBtn = document.getElementById('shareBtn');
  const copyBtn = document.getElementById('copyBtn');
  const resetBtn = document.getElementById('resetBtn');
  const deleteAllBtn = document.getElementById('deleteAllBtn');
  const resetMemBtn = document.getElementById('resetMemBtn'); // NY
  const clearChecksBtn = document.getElementById('clearChecksBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const darkModeBtn = document.getElementById('darkModeBtn');
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileMenu = document.getElementById('mobileMenu');
  const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
  const chipsWrap = document.getElementById('chips');
  const addChipBtn = document.getElementById('addChipBtn');

  const totalIncomeEl=document.getElementById('totalIncome'), totalExpenseEl=document.getElementById('totalExpense'), balanceEl=document.getElementById('balance');
  const salaryInput=document.getElementById('salaryInput'), salaryLeftEl=document.getElementById('salaryLeft'), salaryDisplayEl=document.getElementById('salaryDisplay'), bufferEl=document.getElementById('buffer');
  const cartCountEl=document.getElementById('cartCount'), cartFab=document.getElementById('cartFab');
  const catMemList = document.getElementById('catMemList');

  const fmtSEK0 = n => new Intl.NumberFormat('sv-SE', { style:'currency', currency:'SEK', maximumFractionDigits:0 }).format(Math.round(n||0));

  let rows = []; let salary = 0;
  let currentWeek = '1'; // Aktuell vecka
  function debounce(fn,wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),wait); }; }
  let isLoadingFromCloud=false;

  /* ===== Veckosystem ===== */
  function getWeekDataKey(week) { return `cart_week_${week}`; }
  function getWeekSalaryKey(week) { return `cart_salary_${week}`; }
  
  function loadWeekData(week) {
    try {
      const data = JSON.parse(localStorage.getItem(getWeekDataKey(week)) || '[]');
      return Array.isArray(data) ? data : [];
    } catch(_) { return []; }
  }
  
  function saveWeekData(week, data) {
    try {
      localStorage.setItem(getWeekDataKey(week), JSON.stringify(data));
    } catch(_) {}
  }
  
  function loadWeekSalary(week) {
    try {
      return Number(localStorage.getItem(getWeekSalaryKey(week)) || '0');
    } catch(_) { return 0; }
  }
  
  function saveWeekSalary(week, salary) {
    try {
      localStorage.setItem(getWeekSalaryKey(week), String(salary));
    } catch(_) {}
  }
  
  function switchToWeek(week) {
    // Spara aktuell veckas data
    saveWeekData(currentWeek, rows);
    saveWeekSalary(currentWeek, salary);
    
    // V√§xla till ny vecka
    currentWeek = week;
    rows = loadWeekData(week);
    salary = loadWeekSalary(week);
    
    // Uppdatera UI
    salaryInput.value = salary || '';
    render();
    updateTotals();
    loadChips();
    
    // Uppdatera veckoknappar
    document.querySelectorAll('.week-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.week === week);
    });
  }

  /* ===== Kategori-minne ===== */
  const CATMEM_KEY = 'cart_category_memory';
  function loadCatMem(){
    try{ const arr=JSON.parse(localStorage.getItem(CATMEM_KEY)||'[]'); return Array.isArray(arr)?arr.filter(Boolean):[]; }catch(_){ return []; }
  }
  function saveCatMem(list){
    try{ localStorage.setItem(CATMEM_KEY, JSON.stringify(list.slice(0,200))); }catch(_){}
    renderCatMemList();
  }
  function rememberCategory(val){
    const v=(val||'').trim();
    if(!v) return;
    const list=loadCatMem();
    const exists=list.findIndex(x=>String(x).toLowerCase()===v.toLowerCase());
    if(exists>-1){ // flytta upp
      list.splice(exists,1);
      list.unshift(v);
    } else {
      list.unshift(v);
    }
    saveCatMem(list);
  }
  function renderCatMemList(){
    const list=loadCatMem();
    catMemList.innerHTML = list.map(v=>`<option value="${escapeHtml(v)}"></option>`).join('');
  }

  /* ====== Moln Save/Load ====== */
  function payload(){ return { rows, salary:Number(salary)||0, updatedAt:Date.now() }; }
  async function cloudSave(){ if(!cloudEnabled()||isLoadingFromCloud) return; try{ const form=new URLSearchParams(); form.set('op','save'); form.set('key',cloudKey()); form.set('secret',CLOUD.secret||''); form.set('data',JSON.stringify(payload())); const res=await fetch(CLOUD.endpoint,{method:'POST',body:form}); await res.text(); }catch(e){ console.warn('Molnsave fel',e); } }
  async function cloudLoad(){
    if(!cloudEnabled()) return; isLoadingFromCloud=true;
    try{
      const form=new URLSearchParams(); form.set('op','load'); form.set('key',cloudKey()); form.set('secret',CLOUD.secret||'');
      const res=await fetch(CLOUD.endpoint,{method:'POST',body:form}); const text=await res.text(); let json; try{ json=JSON.parse(text); }catch(_){}
      const data=json&&(json.data||json);
      if(data && Array.isArray(data.rows)){
        rows=data.rows.map(r=>({category:r.category||'', qty:Number(r.qty??1)||1, unit:r.unit||'st', unitPrice:Number(r.unitPrice??0)||0, unitPriceOrd:Number(r.unitPriceOrd??0)||0, amount:Number(r.amount)||0, type:r.type==='Varukampanj'?'Varukampanj':'Butiksvara', pay:(typeof r.pay==='string')?r.pay:'', note:r.note||'', done:!!r.done}));
        rows.forEach((_,i)=>recalcRow(i,true));
      }
      if(typeof data?.salary!=='undefined'){ salary=Number(data.salary)||0; salaryInput.value=salary||''; }
    }catch(e){ console.warn('Molnload fel',e);
    }finally{ render(); updateTotals(); setTimeout(()=>{isLoadingFromCloud=false;},0); }
  }

  /* ====== Snabbknappar ====== */
  function loadChips(){
    const list=JSON.parse(localStorage.getItem('cart_quick_items')||'[]');
    const sections = loadSections();
    
    // Rensa befintliga sektioner
    chipsWrap.innerHTML = '';
    
    // Gruppera snabbknappar per sektion
    const chipsBySection = {};
    list.forEach((c, idx) => {
      const section = c.section || '√ñvrigt';
      if (!chipsBySection[section]) {
        chipsBySection[section] = [];
      }
      chipsBySection[section].push({...c, originalIndex: idx});
    });
    
    // Visa snabbknappar utan sektion f√∂rst (ovanf√∂r sektionerna) - alltid
    const unsortedDiv = document.createElement('div');
    unsortedDiv.style.cssText = 'margin-bottom: 16px; width: 100%; display: block;';
    
    if (chipsBySection['√ñvrigt'] && chipsBySection['√ñvrigt'].length > 0) {
      unsortedDiv.innerHTML = '<div style="font-size: 14px; font-weight: 600; color: var(--text-soft); margin-bottom: 8px;">Osorterade snabbknappar:</div>';
      
      chipsBySection['√ñvrigt'].forEach(chip => {
        const el = document.createElement('div');
        el.className = 'chip';
        el.draggable = true;
        el.innerHTML = `<span>${escapeHtml(chip.label)}</span><span class="edit" title="Redigera" data-i="${chip.originalIndex}">‚úèÔ∏è</span><span class="x" title="Ta bort" data-i="${chip.originalIndex}">√ó</span>`;
        el.addEventListener('click', (ev) => { if(ev.target.classList.contains('x') || ev.target.classList.contains('edit')) return; addRowFromChip(chip); });
        el.querySelector('.x').addEventListener('click', (ev) => { ev.stopPropagation(); const arr=JSON.parse(localStorage.getItem('cart_quick_items')||'[]'); arr.splice(chip.originalIndex,1); localStorage.setItem('cart_quick_items',JSON.stringify(arr)); loadChips(); if(cloudEnabled()) cloudSaveDebounced(); });
        el.querySelector('.edit').addEventListener('click', (ev) => { ev.stopPropagation(); editQuickChip(chip.originalIndex, chip); });
        unsortedDiv.appendChild(el);
      });
    } else {
      // Visa meddelande √§ven om det inte finns n√•gra osorterade snabbknappar
      unsortedDiv.innerHTML = '<div style="font-size: 14px; font-weight: 600; color: var(--text-soft); margin-bottom: 8px;">Osorterade snabbknappar:</div><div style="color:#999; font-style:italic; padding:8px; text-align:center;">Inga osorterade snabbknappar √§nnu</div>';
    }
    
    chipsWrap.appendChild(unsortedDiv);
    
    // Skapa sektioner (visa √§ven tomma sektioner) - efter osorterade snabbknappar
    sections.forEach(section => {
      const sectionChips = chipsBySection[section] || [];
      createSection(section, sectionChips);
    });
    
  }
  
  function createSection(sectionName, chips) {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section-item';
    sectionDiv.style.cssText = 'margin-bottom: 16px;';
    
    const headerDiv = document.createElement('div');
    headerDiv.className = 'section-header';
    headerDiv.innerHTML = `
      <h3>${escapeHtml(sectionName)}</h3>
      <div class="section-actions">
        <button onclick="openSectionsModal()" title="Hantera sektioner">Hantera</button>
        <button onclick="deleteSection('${sectionName.replace(/'/g, "\\'")}')" title="Ta bort sektion" style="background:#ffe5e6; border-color:#f3b4b8; color:#cc1f1f;">Ta bort</button>
      </div>
    `;
    
    const chipsDiv = document.createElement('div');
    chipsDiv.className = 'section-chips';
    
    if (chips.length > 0) {
      chips.forEach(chip => {
        const el = document.createElement('div');
        el.className = 'chip';
        el.draggable = true;
        el.innerHTML = `<span>${escapeHtml(chip.label)}</span><span class="edit" title="Redigera" data-i="${chip.originalIndex}">‚úèÔ∏è</span><span class="x" title="Ta bort" data-i="${chip.originalIndex}">√ó</span>`;
        el.addEventListener('click', (ev) => { if(ev.target.classList.contains('x') || ev.target.classList.contains('edit')) return; addRowFromChip(chip); });
        el.querySelector('.x').addEventListener('click', (ev) => { ev.stopPropagation(); const arr=JSON.parse(localStorage.getItem('cart_quick_items')||'[]'); arr.splice(chip.originalIndex,1); localStorage.setItem('cart_quick_items',JSON.stringify(arr)); loadChips(); if(cloudEnabled()) cloudSaveDebounced(); });
        el.querySelector('.edit').addEventListener('click', (ev) => { ev.stopPropagation(); editQuickChip(chip.originalIndex, chip); });
        chipsDiv.appendChild(el);
      });
    } else {
      // Visa meddelande f√∂r tomma sektioner
      const emptyMsg = document.createElement('div');
      emptyMsg.style.cssText = 'color:#999; font-style:italic; padding:8px; text-align:center;';
      emptyMsg.textContent = 'Inga snabbknappar √§nnu - skapa en snabbknapp och v√§lj denna sektion';
      chipsDiv.appendChild(emptyMsg);
    }
    
    sectionDiv.appendChild(headerDiv);
    sectionDiv.appendChild(chipsDiv);
    chipsWrap.insertBefore(sectionDiv, chipsWrap.querySelector('#addChipBtn'));
  }
  function addRowFromChip(c){
    const qty = Number(c.qty) || 1;
    const price = Number(c.price) || 0;
    const category = c.category || c.label || '';
    
    rows.push({ 
      category: category, 
      qty: qty, 
      unit:'st', 
      unitPrice: price, 
      unitPriceOrd: 0, 
      amount: price * qty, 
      type:'Butiksvara', 
      pay:'Kort', 
      note:'', 
      done:false 
    });
    rememberCategory(category); // NY: minnesinl√§rning √§ven via snabbknapp
    const i=rows.length-1; recalcRow(i,true); render(); updateTotals();
  }
  addChipBtn.addEventListener('click',()=>{
    openQuickToolModal();
  });

  /* ====== M√∂rkt l√§ge ====== */
  function initDarkMode() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateDarkModeButton(savedTheme);
  }

  function toggleDarkMode() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateDarkModeButton(newTheme);
  }

  function updateDarkModeButton(theme) {
    if (darkModeBtn) {
      darkModeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
  }

  /* ====== INIT ====== */
  function init(){
    renderCatMemList(); // NY
    initDarkMode(); // NY

    // Ladda aktuell veckas data
    rows = loadWeekData(currentWeek);
    salary = loadWeekSalary(currentWeek);
    salaryInput.value = salary || '';
    
    salaryInput.addEventListener('input', ()=>{
      salary = Number(salaryInput.value) || 0;
      saveWeekSalary(currentWeek, salary);
      updateTotals();
    });


    ensureKey();
    render(); updateTotals();
    setupReceiptModal();
    loadChips();
    secureGate.init();
    
    // Ladda molndata
    cloudLoad();

    addRowBtn.addEventListener('click', addEmptyRow);

    // Veckov√§ljare event listeners
    document.querySelectorAll('.week-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const week = btn.dataset.week;
        switchToWeek(week);
      });
    });

    // M√∂rkt l√§ge event listener
    if (darkModeBtn) {
      darkModeBtn.addEventListener('click', toggleDarkMode);
    }

    // Mobil hamburgermeny
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('show');
        mobileMenuOverlay.classList.toggle('show');
      });
    }

    // St√§ng mobil meny n√§r man klickar p√• overlay eller utanf√∂r
    if (mobileMenuOverlay) {
      mobileMenuOverlay.addEventListener('click', () => {
        mobileMenu.classList.remove('show');
        mobileMenuOverlay.classList.remove('show');
      });
    }

    document.addEventListener('click', (e) => {
      if (mobileMenu && !mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
        mobileMenu.classList.remove('show');
        mobileMenuOverlay.classList.remove('show');
      }
    });

    // Mobil meny knappar - koppla till samma funktioner som desktop
    const mobileButtons = [
      { mobile: 'mobileShareBtn', desktop: 'shareBtn' },
      { mobile: 'mobileCopyBtn', desktop: 'copyBtn' },
      { mobile: 'mobileLogoutBtn', desktop: 'logoutBtn' },
      { mobile: 'mobileResetBtn', desktop: 'resetBtn' },
      { mobile: 'mobileResetMemBtn', desktop: 'resetMemBtn' },
      { mobile: 'mobileDeleteAllBtn', desktop: 'deleteAllBtn' }
    ];

    mobileButtons.forEach(({ mobile, desktop }) => {
      const mobileBtn = document.getElementById(mobile);
      const desktopBtn = document.getElementById(desktop);
      if (mobileBtn && desktopBtn) {
        mobileBtn.addEventListener('click', () => {
          desktopBtn.click();
          mobileMenu.classList.remove('show');
          mobileMenuOverlay.classList.remove('show');
        });
      }
    });

    cloudLoad();

    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') cloudSave(); });

    ['click','keydown','pointerdown','touchstart'].forEach(ev=>document.addEventListener(ev, secureGate.bump));
    document.addEventListener('visibilitychange', secureGate.bump);

    // Delete All - radera ALLT (kategorier + snabbknappar + sektioner)
    deleteAllBtn.addEventListener('click', ()=>{
      if(!confirm('VARNING: Detta raderar ALLT - kategorier, snabbknappar och sektioner. √Ñr du s√§ker?')) return;
      
      // Rensa kategorier
      rows = [];
      salary = 0;
      salaryInput.value = '';
      saveWeekData(currentWeek, []);
      saveWeekSalary(currentWeek, 0);
      
      // Rensa snabbknappar
      localStorage.removeItem('cart_quick_items');
      
      // Rensa sektioner
      localStorage.removeItem('cart_sections');
      
      // Rensa kategori-minnet
      localStorage.removeItem(CATMEM_KEY);
      
      render();
      updateTotals();
      loadChips();
      renderCatMemList();
      alert('ALLT raderat - kategorier, snabbknappar, sektioner och kategori-minnet.');
    });

    // NY: rensa bara kategori-minnet
    resetMemBtn.addEventListener('click', ()=>{
      if(!confirm('Rensa sparade kategorier (minnet)? Detta p√•verkar inte varor eller budget.')) return;
      localStorage.removeItem(CATMEM_KEY);
      renderCatMemList();
      alert('Kategori-minnet √§r rensat.');
    });
  }

  // L√§gg till tom rad
  function addEmptyRow(){
    rows.push({ category:'', qty:1, unit:'st', unitPrice:0, unitPriceOrd:0, amount:0, type:'Butiksvara', pay:'Kort', note:'', done:false });
    const i=rows.length-1;
    recalcRow(i,true);
    render(); updateTotals();
    setTimeout(()=>{
      const lastInput=document.querySelector('#tbody tr:last-child td.category-col input');
      if(lastInput){ lastInput.setAttribute('list','catMemList'); lastInput.focus({preventScroll:false}); lastInput.scrollIntoView({block:'center',behavior:'smooth'}); }
    }, 0);
  }

  /* ====== Render & events ====== */
  function render(){
    tbody.innerHTML='';
    if(rows.length===0){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td colspan="11" class="empty-cell"><div class="empty-row">Inga rader √§nnu ‚Äî klicka <strong>+ L√§gg till vara</strong> eller anv√§nd en snabbknapp.</div></td>`;
      tbody.appendChild(tr);
      updateTotals(); save(); return;
    }
    rows.forEach((r,i)=>{
      if(r.type==='Utgift') r.type='Butiksvara';
      if(r.type==='Inkomst') r.type='Varukampanj';
      const tr=document.createElement('tr'); tr.dataset.index=i;
      if(r.done) tr.classList.add('done');

      tr.innerHTML = `
        <td>
          <label class="checkcell" title="Markera klar">
            <input type="checkbox" data-i="${i}" data-col="done" ${r.done?'checked':''} aria-label="Markera klar">
            <span class="box" aria-hidden="true"></span>
          </label>
        </td>
        <td class="category-col">
          <input type="text" data-i="${i}" data-col="category" value="${escapeHtml(r.category)}" placeholder="T.ex. √Ñgg" list="catMemList">
        </td>
        <td><input type="number" data-i="${i}" data-col="qty" value="${r.qty}" min="0" step="1" inputmode="numeric"></td>
        <td>
          <select data-i="${i}" data-col="unit">
            <option value="st" ${r.unit==='st'?'selected':''}>st</option>
            <option value="kg" ${r.unit==='kg'?'selected':''}>kg</option>
          </select>
        </td>
        <td><input type="number" data-i="${i}" data-col="unitPrice" value="${r.unitPrice}" step="0.01" inputmode="decimal" placeholder="0.00"></td>
        <td><input type="number" data-i="${i}" data-col="unitPriceOrd" value="${r.unitPriceOrd||0}" step="0.01" inputmode="decimal" placeholder="0.00"></td>
        <td class="right"><input type="number" data-i="${i}" data-col="amount" value="${Math.round(r.amount)}" readonly></td>
        <td class="type-col">
          <select data-i="${i}" data-col="type">
            <option ${r.type==='Butiksvara'?'selected':''}>Butiksvara</option>
            <option ${r.type==='Varukampanj'?'selected':''}>Varukampanj</option>
          </select>
        </td>
        <td class="pay-col">
          <select data-i="${i}" data-col="pay">
            <option value="" ${(!r.pay||r.pay==='')?'selected':''}>-</option>
            <option value="Kort" ${r.pay==='Kort'?'selected':''}>Kort</option>
            <option value="Mastercard" ${r.pay==='Mastercard'?'selected':''}>Mastercard</option>
            <option value="Visa" ${r.pay==='Visa'?'selected':''}>Visa</option>
            <option value="Swish" ${r.pay==='Swish'?'selected':''}>Swish</option>
            <option value="Klarna" ${r.pay==='Klarna'?'selected':''}>Klarna</option>
            <option value="Kontant" ${r.pay==='Kontant'?'selected':''}>Kontant</option>
            <option value="Faktura" ${r.pay==='Faktura'?'selected':''}>Faktura</option>
          </select>
        </td>
        <td class="notes-col"><input type="text" data-i="${i}" data-col="note" value="${escapeHtml(r.note||'')}" placeholder="Anteckningar (valfritt)"></td>
        <td class="row-actions">
          <button data-action="rabatt" data-i="${i}" title="L√§gg/√§ndra rabatt">Rabatt</button>
          <button data-action="up" data-i="${i}" title="Flytta upp">‚Üë</button>
          <button data-action="down" data-i="${i}" title="Flytta ner">‚Üì</button>
          <button data-action="neg" data-i="${i}" title="V√§xla ¬±">¬±</button>
          <button data-action="del" data-i="${i}" title="Ta bort" style="background:#ffe5e6">Ta bort</button>
        </td>`;
      tbody.appendChild(tr);
    });
    attachEvents(); updateTotals(); save();
  }

  function attachEvents(){
    tbody.querySelectorAll('input[data-col], select[data-col]').forEach(el=>{
      const handler=()=>{
        const i=+el.dataset.i, col=el.dataset.col;
        if(!rows[i]) return;
        if(col==='done'){ rows[i].done=!!el.checked; el.closest('tr')?.classList.toggle('done', rows[i].done); save(); return; }

        if(col==='qty'||col==='unitPrice'||col==='unitPriceOrd'||col==='unit'){
          if(col==='qty') rows[i].qty=Math.max(0, Math.round(Number(el.value)||0));
          else if(col==='unit') rows[i].unit=el.value;
          else rows[i][col]=Number(el.value)||0;
          recalcRow(i);
        } else if(col==='category' || col==='note' || col==='pay' || col==='type'){
          rows[i][col]=el.value;
          if(col==='type') recalcRow(i);
        }
        updateTotals(); save();
      };
      el.addEventListener('input', handler);
      el.addEventListener('change', handler);

      // NY: l√§r in kategori n√§r man l√§mnar f√§ltet (eller v√§ljer f√∂rslag)
      if(el.dataset.col === 'category'){
        el.addEventListener('blur', ()=>{ rememberCategory(el.value); });
      }

      if(el.dataset.col==='unitPrice'||el.dataset.col==='unitPriceOrd'){
        el.onfocus = ()=>{ if(el.value==='0' || el.value==='') el.value=''; };
        el.onblur  = ()=>{ if(el.value==='' || isNaN(Number(el.value))){ el.value='0'; handler(); } };
      }
      if(el.dataset.col==='qty'){
        el.onblur  = ()=>{ if(el.value==='' || isNaN(Number(el.value))){ el.value='1'; handler(); } };
      }
    });

    // Radknappar
    tbody.querySelectorAll('button[data-action]').forEach(btn=>{
      btn.onclick=()=>{
        const i=+btn.dataset.i, act=btn.dataset.action;
        if(act==='del'){ rows.splice(i,1); render(); }
        else if(act==='neg'){ rows[i].amount=-Math.abs(rows[i].amount||0); rows[i].type=(rows[i].amount<0?'Varukampanj':'Butiksvara'); render(); }
        else if(act==='up'){ if(i>0) moveRow(i,i-1); }
        else if(act==='down'){ if(i<rows.length-1) moveRow(i,i+1); }
        else if(act==='rabatt'){ promptDiscount(i); }
      };
    });
  }

  function moveRow(from,to){ if(from<0||to<0||from>=rows.length||to>=rows.length) return; const item=rows.splice(from,1)[0]; rows.splice(to,0,item); render(); }

  /* ===== Rabattlogik & ber√§kning ===== */
  function recalcRow(i, silent=false){
    const r=rows[i]; if(!r) return;
    const qty=Math.max(0, Number(r.qty)||0);
    const now=Number(r.unitPrice)||0;
    const ord=Number(r.unitPriceOrd)||0;
    r.amount=Math.round(qty * now);
    const discount=Math.max(0, Math.round((ord - now) * qty));
    ensureDiscountRowFor(i, discount, true);

    if(!silent){
      const amountInput=tbody.querySelector(`input[data-col="amount"][data-i="${i}"]`);
      if(amountInput) amountInput.value=String(r.amount);
    }
  }
  function promptDiscount(i){
    openDiscountModal(i);
  }
  function findDiscountRowIndex(i){
    const base=rows[i]; if(!base) return -1;
    const j=i+1, r=rows[j];
    if(!r || r.type!=='Varukampanj') return -1;
    const baseCat=(base.category||'').trim().toLowerCase();
    const note=(r.note||'').trim().toLowerCase();
    const cat=(r.category||'').trim().toLowerCase();
    const looksLinked=(note.startsWith('rabatt p√• ') && (baseCat ? note.includes(baseCat) : true)) || (cat==='rabatt/kupong');
    return looksLinked ? j : -1;
  }
  function ensureDiscountRowFor(i, amount){
    const base=rows[i]; if(!base) return;
    const amt=Math.max(0, Math.round(Number(amount)||0));
    const label=String(base.category||'').trim();
    const note=`Rabatt p√• ${label || 'vara'}`;
    const j=findDiscountRowIndex(i);

    if(amt<=0){ if(j>-1){ rows.splice(j,1); } return; }
    if(j>-1){
      rows[j].amount=amt; rows[j].note=note; rows[j].category='Rabatt/Kupong';
    } else {
      rows.splice(i+1,0,{ category:'Rabatt/Kupong', amount:amt, type:'Varukampanj', pay:'Kort', note, qty:1, unit:'st', unitPrice:amt, unitPriceOrd:0, done:false });
    }
  }

  /* ------- Summering ------- */
  function updateTotals(){
    let sumIncome=0, sumExpense=0;
    rows.forEach(r=>{
      const amt=Number(r.amount)||0;
      if(r.type==='Varukampanj') sumIncome += amt;
      else sumExpense += amt;
    });

    totalExpenseEl.textContent = fmtSEK0(sumExpense);
    totalIncomeEl.textContent  = fmtSEK0(sumIncome);

    const toPay = Math.max(0, Math.round(sumExpense - sumIncome));
    balanceEl.textContent = fmtSEK0(toPay);
    salaryDisplayEl.textContent = fmtSEK0(toPay);

    const s=Number(salary)||0;
    const kvar=Math.round(s - toPay);
    salaryLeftEl.textContent = fmtSEK0(kvar);
    bufferEl.textContent     = fmtSEK0(kvar);

    salaryLeftEl.classList.toggle('bad', kvar < 0);
    salaryLeftEl.classList.toggle('good', kvar >= 0);
    bufferEl.classList.toggle('bad', kvar < 0);
    bufferEl.classList.toggle('good', kvar >= 0);

    const itemCount=rows.reduce((acc,r)=> acc + (r.type==='Butiksvara' && (r.category||'').trim()!=='' ? (Number(r.qty)||1) : 0), 0);
    if(cartCountEl) cartCountEl.textContent = String(itemCount);

    save();
  }

  /* ------- Helpers ------- */
  function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
  function save(){ 
    saveWeekData(currentWeek, rows);
    saveWeekSalary(currentWeek, salary);
    if(cloudEnabled()) cloudSaveDebounced();
  }

  /* ------- Reset / Checkar ------- */
  resetBtn.onclick = ()=>{
    if(!confirm(`Nollst√§ll bara kategorier f√∂r ${currentWeek === 'quick' ? 'Snabbhandla' : 'Vecka ' + currentWeek}? (Snabbknappar och sektioner beh√•lls)`)) return;
    rows = [];
    salary = 0;
    salaryInput.value = '';
    saveWeekData(currentWeek, []);
    saveWeekSalary(currentWeek, 0);
    render();
    updateTotals();
    // INTE loadChips() - beh√•ll snabbknappar och sektioner
    alert(`Kategorier nollst√§llda f√∂r ${currentWeek === 'quick' ? 'Snabbhandla' : 'Vecka ' + currentWeek}. Snabbknappar och sektioner √§r kvar.`);
  };
  clearChecksBtn.onclick = ()=>{ rows.forEach(r=> r.done=false); render(); updateTotals(); };

  /* ------- Delning ------- */
  shareBtn.onclick = copyBtn.onclick = ()=>{
    const link = location.href;
    (navigator.clipboard ? navigator.clipboard.writeText(link) : Promise.reject())
      .then(()=> alert('L√§nk kopierad.'))
      .catch(()=> prompt('Kopiera manuellt:', link));
  };

  /* ======= Kvitto ======= */
  const receiptModal   = document.getElementById('receiptModal');
  const receiptBackdrop= document.getElementById('receiptBackdrop');
  const receiptPreview = document.getElementById('receiptPreview');
  const receiptEmail   = document.getElementById('receiptEmail');
  const btnReceiptSend = document.getElementById('receiptSendBtn');
  const btnReceiptClose= document.getElementById('receiptCloseBtn');
  const btnReceiptCopy = document.getElementById('receiptCopyBtn');
  const btnReceiptPrint= document.getElementById('receiptPrintBtn');
  const btnReceiptPdf  = document.getElementById('receiptPdfBtn');

  function setupReceiptModal(){
    function openFromFab(){ buildAndShowReceipt(); }
    cartFab.addEventListener('click', openFromFab);
    cartFab.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openFromFab(); } });

    btnReceiptClose.onclick = closeReceipt;
    receiptBackdrop.onclick = closeReceipt;

    btnReceiptCopy.onclick = async ()=>{
      try{ await navigator.clipboard.writeText(buildReceiptHtml()); alert('Kvitto (HTML) kopierat.'); }
      catch(_){ alert('Kunde inte kopiera.'); }
    };
    const printNow = ()=>{
      const html = buildReceiptHtml();
      const w = window.open('', '_blank', 'noopener');
      if(!w) return alert('Popup blockerad. Till√•t popups eller prova igen.');
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Kvitto</title>
        <style>body{font:14px/1.5 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial;padding:16px}</style>
      </head><body>${html}</body></html>`);
      w.document.close(); w.focus(); w.print();
    };
    btnReceiptPrint.onclick = printNow;
    btnReceiptPdf.onclick = printNow;

    btnReceiptSend.onclick = ()=> alert('E-post kan kopplas h√§r (t.ex. via Apps Script).');
  }
  function openReceipt(){ receiptModal.classList.add('open'); receiptBackdrop.classList.add('open'); receiptModal.setAttribute('aria-hidden','false'); setTimeout(()=> receiptEmail.focus(), 0); }
  function closeReceipt(){ receiptModal.classList.remove('open'); receiptBackdrop.classList.remove('open'); receiptModal.setAttribute('aria-hidden','true'); }
  function buildAndShowReceipt(){
    const items = rows.filter(r => r.type==='Butiksvara' && (r.category||'').trim()!=='');
    if(items.length===0){ alert('L√§gg till minst en vara f√∂rst.'); return; }
    receiptPreview.innerHTML = buildReceiptHtml();
    document.getElementById('receiptMeta').textContent = new Date().toLocaleString('sv-SE');
    openReceipt();
  }
  function buildReceiptHtml(){
    const items = rows.filter(r => r.type==='Butiksvara' && (r.category||'').trim()!=='');
    const promos= rows.filter(r => r.type==='Varukampanj' && (Number(r.amount)||0)>0);
    const sumItems = items.reduce((a,b)=> a + (Number(b.amount)||0), 0);
    const sumPromos= promos.reduce((a,b)=> a + (Number(b.amount)||0), 0);
    const toPay = Math.max(0, Math.round(sumItems - sumPromos));
    const fmt = n => new Intl.NumberFormat('sv-SE',{style:'currency',currency:'SEK',maximumFractionDigits:0}).format(Math.round(n));

    const rowsHtml = items.map(it=>`
      <tr>
        <td>${escapeHtml(it.category)}</td>
        <td style="text-align:right">${it.qty||1} ${escapeHtml(it.unit||'st')}</td>
        <td style="text-align:right">${fmt(it.unitPrice||0)}</td>
        <td style="text-align:right">${fmt(it.amount||0)}</td>
        <td>${escapeHtml(it.note||'')}</td>
      </tr>`).join('');
    const promoHtml = promos.length ? `
      <tr>
        <td style="font-weight:700">Kampanjer</td>
        <td></td><td></td>
        <td style="text-align:right; color:#1b8f4a; font-weight:700">‚àí${fmt(sumPromos)}</td>
        <td></td>
      </tr>` : '';
    return `
<div style="max-width:760px;margin:0 auto">
  <div style="font-weight:900;letter-spacing:.2px;margin:0 0 6px">Varukorgen</div>
  <table style="width:100%;border-collapse:collapse">
    <thead>
      <tr>
        <th style="text-align:left;border-bottom:1px solid #eee;padding:6px">Vara</th>
        <th style="text-align:right;border-bottom:1px solid #eee;padding:6px">Antal</th>
        <th style="text-align:right;border-bottom:1px solid #eee;padding:6px">√†-pris</th>
        <th style="text-align:right;border-bottom:1px solid #eee;padding:6px">Radpris</th>
        <th style="text-align:left;border-bottom:1px solid #eee;padding:6px">Anteckning</th>
      </tr>
    </thead>
    <tbody>
      ${rowsHtml || `<tr><td colspan="5" style="padding:8px;color:#888">Inga varor</td></tr>`}
    </tbody>
    <tfoot>
      ${promoHtml}
      <tr>
        <td colspan="3" style="font-weight:700">Att betala</td>
        <td style="text-align:right;font-weight:900">${fmt(toPay)}</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>`;
  }

  /* ======== Rabattverktyg ======== */
  const discountModal = document.getElementById('discountModal');
  const discountBackdrop = document.getElementById('discountBackdrop');
  const discountCloseBtn = document.getElementById('discountCloseBtn');
  const discountCancelBtn = document.getElementById('discountCancelBtn');
  const discountApplyBtn = document.getElementById('discountApplyBtn');
  const discountInputs = document.getElementById('discountInputs');
  const discountPreview = document.getElementById('discountPreview');
  
  let currentDiscountRowIndex = -1;
  let currentDiscountType = 'percentage';
  
  function openDiscountModal(rowIndex) {
    currentDiscountRowIndex = rowIndex;
    const row = rows[rowIndex];
    if (!row) return;
    
    // S√§tt standardv√§rden baserat p√• befintlig data
    currentDiscountType = 'percentage';
    updateDiscountTypeButtons();
    updateDiscountInputs();
    updateDiscountPreview();
    
    discountModal.classList.add('open');
    discountBackdrop.classList.add('open');
    discountModal.setAttribute('aria-hidden', 'false');
  }
  
  function closeDiscountModal() {
    discountModal.classList.remove('open');
    discountBackdrop.classList.remove('open');
    discountModal.setAttribute('aria-hidden', 'true');
    currentDiscountRowIndex = -1;
  }
  
  function updateDiscountTypeButtons() {
    document.querySelectorAll('.discount-type button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.type === currentDiscountType);
    });
  }
  
  function updateDiscountInputs() {
    const row = rows[currentDiscountRowIndex];
    if (!row) return;
    
    let html = '';
    
    switch (currentDiscountType) {
      case 'percentage':
        html = `
          <label for="discountPercent">Rabatt i procent (%)</label>
          <input type="number" id="discountPercent" min="0" max="100" step="0.1" value="0" placeholder="t.ex. 15">
        `;
        break;
        
      case 'fixed':
        html = `
          <label for="discountAmount">Rabatt i kronor (kr)</label>
          <input type="number" id="discountAmount" min="0" step="0.01" value="0" placeholder="t.ex. 25">
        `;
        break;
        
      case 'campaign-price':
        html = `
          <label for="campaignPrice">Kampanjpris per produkt (kr)</label>
          <div style="width: 120px;">
            <input type="number" id="campaignPrice" min="0" step="0.01" value="0" placeholder="t.ex. 20" style="width: 100%;">
          </div>
          <div style="padding:8px; background:#f0f8ff; border-radius:6px; color:#666; font-size:13px; margin-top:8px;">
            <strong>Exempel:</strong> Mj√∂lk kostar 24 kr, men k√∂per du 2+ f√•r du betala 20 kr per styck ist√§llet.
          </div>
        `;
        break;
        
      case '2-for-1':
        html = `
          <div style="padding:12px; background:#f8f9fa; border-radius:8px; color:#666;">
            <strong>Ta 2 betala f√∂r 1:</strong> K√∂p 2 varor, betala f√∂r 1. Automatiskt ber√§knat baserat p√• antal i varukorgen.
          </div>
        `;
        break;
        
      case '3-for-2':
        html = `
          <div style="padding:12px; background:#f8f9fa; border-radius:8px; color:#666;">
            <strong>3-f√∂r-2:</strong> K√∂p 3 varor, betala f√∂r 2. Automatiskt ber√§knat baserat p√• antal i varukorgen.
          </div>
        `;
        break;
        
      case '4-for-2':
        html = `
          <div style="padding:12px; background:#f8f9fa; border-radius:8px; color:#666;">
            <strong>Ta 4 betala f√∂r 2:</strong> K√∂p 4 varor, betala f√∂r 2. Automatiskt ber√§knat baserat p√• antal i varukorgen.
          </div>
        `;
        break;
        
      case '5-for-3':
        html = `
          <div style="padding:12px; background:#f8f9fa; border-radius:8px; color:#666;">
            <strong>Ta 5 betala f√∂r 3:</strong> K√∂p 5 varor, betala f√∂r 3. Automatiskt ber√§knat baserat p√• antal i varukorgen.
          </div>
        `;
        break;
        
      case 'x-for-n':
        html = `
          <label for="discountX">Antal varor (X)</label>
          <input type="number" id="discountX" min="1" value="3" placeholder="t.ex. 3">
          <label for="discountN">F√∂r priset av (N)</label>
          <input type="number" id="discountN" min="1" value="2" placeholder="t.ex. 2">
        `;
        break;
        
      case 'second-half':
        html = `
          <div style="padding:12px; background:#f8f9fa; border-radius:8px; color:#666;">
            <strong>2:a till halvpris:</strong> Andra varan kostar h√§lften. Automatiskt ber√§knat baserat p√• antal i varukorgen.
          </div>
        `;
        break;
    }
    
    discountInputs.innerHTML = html;
    
    // L√§gg till event listeners f√∂r nya inputs
    discountInputs.querySelectorAll('input').forEach(input => {
      input.addEventListener('input', updateDiscountPreview);
      input.addEventListener('change', updateDiscountPreview);
    });
  }
  
  function updateDiscountPreview() {
    const row = rows[currentDiscountRowIndex];
    if (!row) return;
    
    const qty = Number(row.qty) || 1;
    const unitPrice = Number(row.unitPrice) || 0;
    const originalTotal = qty * unitPrice;
    
    let discountAmount = 0;
    let description = '';
    
    switch (currentDiscountType) {
      case 'percentage':
        const percent = Number(document.getElementById('discountPercent')?.value) || 0;
        discountAmount = Math.round(originalTotal * percent / 100);
        description = `${percent}% rabatt`;
        break;
        
      case 'fixed':
        discountAmount = Math.round(Number(document.getElementById('discountAmount')?.value) || 0);
        description = `${discountAmount} kr rabatt`;
        break;
        
      case 'campaign-price':
        const campaignPrice = Number(document.getElementById('campaignPrice')?.value) || 0;
        if (campaignPrice > 0 && campaignPrice < unitPrice) {
          const priceDiff = unitPrice - campaignPrice;
          discountAmount = Math.round(priceDiff * qty);
          description = `Kampanjpris ${campaignPrice} kr/st (sparar ${priceDiff} kr per styck)`;
        }
        break;
        
      case '2-for-1':
        if (qty >= 2) {
          const sets = Math.floor(qty / 2);
          const freeItems = sets;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `Ta 2 betala f√∂r 1 (${freeItems} gratis)`;
        }
        break;
        
      case '4-for-2':
        if (qty >= 4) {
          const sets = Math.floor(qty / 4);
          const freeItems = sets * 2;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `Ta 4 betala f√∂r 2 (${freeItems} gratis)`;
        }
        break;
        
      case '5-for-3':
        if (qty >= 5) {
          const sets = Math.floor(qty / 5);
          const freeItems = sets * 2;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `Ta 5 betala f√∂r 3 (${freeItems} gratis)`;
        }
        break;
        
      case 'x-for-n':
        const x = Number(document.getElementById('discountX')?.value) || 3;
        const n = Number(document.getElementById('discountN')?.value) || 2;
        if (qty >= x) {
          const sets = Math.floor(qty / x);
          const freeItems = sets * (x - n);
          discountAmount = Math.round(freeItems * unitPrice);
          description = `${x} f√∂r ${n} (${freeItems} gratis)`;
        }
        break;
        
      case '3-for-2':
        if (qty >= 3) {
          const sets = Math.floor(qty / 3);
          const freeItems = sets;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `3-f√∂r-2 (${freeItems} gratis)`;
        }
        break;
        
      case 'second-half':
        if (qty >= 2) {
          const halfPriceItems = Math.floor(qty / 2);
          discountAmount = Math.round(halfPriceItems * unitPrice / 2);
          description = `2:a till halvpris (${halfPriceItems} till halvpris)`;
        }
        break;
    }
    
    const newTotal = Math.max(0, originalTotal - discountAmount);
    const savings = originalTotal - newTotal;
    
    discountPreview.innerHTML = `
      <div class="preview-title">F√∂rhandsvisning</div>
      <div class="preview-details">
        <div><strong>Originalpris:</strong> ${fmtSEK0(originalTotal)}</div>
        <div><strong>Rabatt:</strong> ${fmtSEK0(discountAmount)} (${description})</div>
        <div><strong>Nytt pris:</strong> ${fmtSEK0(newTotal)}</div>
        <div><strong>Du sparar:</strong> ${fmtSEK0(savings)}</div>
      </div>
    `;
  }
  
  function applyDiscount() {
    const row = rows[currentDiscountRowIndex];
    if (!row) return;
    
    const qty = Number(row.qty) || 1;
    const unitPrice = Number(row.unitPrice) || 0;
    const originalTotal = qty * unitPrice;
    
    let discountAmount = 0;
    let description = '';
    
    switch (currentDiscountType) {
      case 'percentage':
        const percent = Number(document.getElementById('discountPercent')?.value) || 0;
        discountAmount = Math.round(originalTotal * percent / 100);
        description = `${percent}% rabatt`;
        break;
        
      case 'fixed':
        discountAmount = Math.round(Number(document.getElementById('discountAmount')?.value) || 0);
        description = `${discountAmount} kr rabatt`;
        break;
        
      case 'campaign-price':
        const campaignPrice = Number(document.getElementById('campaignPrice')?.value) || 0;
        if (campaignPrice > 0 && campaignPrice < unitPrice) {
          const priceDiff = unitPrice - campaignPrice;
          discountAmount = Math.round(priceDiff * qty);
          description = `Kampanjpris ${campaignPrice} kr/st (sparar ${priceDiff} kr per styck)`;
        }
        break;
        
      case '2-for-1':
        if (qty >= 2) {
          const sets = Math.floor(qty / 2);
          const freeItems = sets;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `Ta 2 betala f√∂r 1 (${freeItems} gratis)`;
        }
        break;
        
      case '4-for-2':
        if (qty >= 4) {
          const sets = Math.floor(qty / 4);
          const freeItems = sets * 2;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `Ta 4 betala f√∂r 2 (${freeItems} gratis)`;
        }
        break;
        
      case '5-for-3':
        if (qty >= 5) {
          const sets = Math.floor(qty / 5);
          const freeItems = sets * 2;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `Ta 5 betala f√∂r 3 (${freeItems} gratis)`;
        }
        break;
        
      case 'x-for-n':
        const x = Number(document.getElementById('discountX')?.value) || 3;
        const n = Number(document.getElementById('discountN')?.value) || 2;
        if (qty >= x) {
          const sets = Math.floor(qty / x);
          const freeItems = sets * (x - n);
          discountAmount = Math.round(freeItems * unitPrice);
          description = `${x} f√∂r ${n} (${freeItems} gratis)`;
        }
        break;
        
      case '3-for-2':
        if (qty >= 3) {
          const sets = Math.floor(qty / 3);
          const freeItems = sets;
          discountAmount = Math.round(freeItems * unitPrice);
          description = `3-f√∂r-2 (${freeItems} gratis)`;
        }
        break;
        
      case 'second-half':
        if (qty >= 2) {
          const halfPriceItems = Math.floor(qty / 2);
          discountAmount = Math.round(halfPriceItems * unitPrice / 2);
          description = `2:a till halvpris (${halfPriceItems} till halvpris)`;
        }
        break;
    }
    
    if (discountAmount > 0) {
      // S√§tt ordinarie pris till nuvarande pris
      row.unitPriceOrd = unitPrice;
      // Ber√§kna nytt pris
      const newTotal = Math.max(0, originalTotal - discountAmount);
      row.unitPrice = Math.round(newTotal / qty * 100) / 100; // Avrunda till 2 decimaler
      
      // Skapa rabattrad
      ensureDiscountRowFor(currentDiscountRowIndex, discountAmount);
    }
    
    recalcRow(currentDiscountRowIndex);
    render();
    updateTotals();
    closeDiscountModal();
  }
  
  // Event listeners f√∂r rabattverktyget
  document.querySelectorAll('.discount-type button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentDiscountType = btn.dataset.type;
      updateDiscountTypeButtons();
      updateDiscountInputs();
      updateDiscountPreview();
    });
  });
  
  discountCloseBtn.addEventListener('click', closeDiscountModal);
  discountCancelBtn.addEventListener('click', closeDiscountModal);
  discountBackdrop.addEventListener('click', closeDiscountModal);
  discountApplyBtn.addEventListener('click', applyDiscount);

  /* ======== Snabbknappverktyg ======== */
  const quickToolModal = document.getElementById('quickToolModal');
  const quickToolBackdrop = document.getElementById('quickToolBackdrop');
  const quickToolCloseBtn = document.getElementById('quickToolCloseBtn');
  const quickToolCancelBtn = document.getElementById('quickToolCancelBtn');
  const quickToolApplyBtn = document.getElementById('quickToolApplyBtn');
  const quickToolInputs = document.getElementById('quickToolInputs');
  const quickToolPreview = document.getElementById('quickToolPreview');
  
  let currentQuickToolType = 'simple';
  let editingChipIndex = -1;
  
  function getCategoryOptions() {
    const categories = loadCatMem();
    return categories.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
  }
  
  function editQuickChip(index, chipData) {
    editingChipIndex = index;
    
    // Best√§m typ baserat p√• vilka f√§lt som finns
    if (chipData.price && chipData.category && chipData.qty) {
      currentQuickToolType = 'complete';
    } else if (chipData.price && chipData.category) {
      currentQuickToolType = 'with-category';
    } else if (chipData.price) {
      currentQuickToolType = 'with-price';
    } else {
      currentQuickToolType = 'simple';
    }
    
    updateQuickToolTypeButtons();
    updateQuickToolInputs();
    
    // Uppdatera knapptext
    quickToolApplyBtn.textContent = 'üîÑ Uppdatera snabbknapp';
    
    // Fyll i befintliga v√§rden
    setTimeout(() => {
      const labelInput = document.getElementById('quickToolLabel');
      const priceInput = document.getElementById('quickToolPrice');
      const categorySelect = document.getElementById('quickToolCategory');
      const qtyInput = document.getElementById('quickToolQty');
      
      if (labelInput) labelInput.value = chipData.label || '';
      if (priceInput) priceInput.value = chipData.price || 0;
      if (categorySelect) categorySelect.value = chipData.category || '';
      if (qtyInput) qtyInput.value = chipData.qty || 1;
      
      updateQuickToolPreview();
    }, 0);
    
    quickToolModal.classList.add('open');
    quickToolBackdrop.classList.add('open');
    quickToolModal.setAttribute('aria-hidden', 'false');
  }
  
  function openQuickToolModal() {
    editingChipIndex = -1;
    currentQuickToolType = 'simple';
    updateQuickToolTypeButtons();
    updateQuickToolInputs();
    updateQuickToolPreview();
    
    // √Öterst√§ll knapptext
    quickToolApplyBtn.textContent = 'üöÄ Skapa & L√§gg till snabbknapp';
    
    quickToolModal.classList.add('open');
    quickToolBackdrop.classList.add('open');
    quickToolModal.setAttribute('aria-hidden', 'false');
  }
  
  function closeQuickToolModal() {
    quickToolModal.classList.remove('open');
    quickToolBackdrop.classList.remove('open');
    quickToolModal.setAttribute('aria-hidden', 'true');
  }
  
  function updateQuickToolTypeButtons() {
    document.querySelectorAll('.quick-tool-type button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.type === currentQuickToolType);
    });
  }
  
  function updateQuickToolInputs() {
    let html = '';
    
    switch (currentQuickToolType) {
      case 'simple':
        html = `
          <label for="quickToolLabel">Namn p√• snabbknapp</label>
          <input type="text" id="quickToolLabel" placeholder="t.ex. Mj√∂lk" value="">
        `;
        break;
        
      case 'with-price':
        html = `
          <label for="quickToolLabel">Namn p√• snabbknapp</label>
          <input type="text" id="quickToolLabel" placeholder="t.ex. Mj√∂lk" value="">
          <label for="quickToolPrice">Pris (kr)</label>
          <input type="number" id="quickToolPrice" min="0" step="0.01" placeholder="t.ex. 18.90" value="0">
        `;
        break;
        
      case 'with-category':
        html = `
          <label for="quickToolLabel">Namn p√• snabbknapp</label>
          <input type="text" id="quickToolLabel" placeholder="t.ex. Mj√∂lk" value="">
          <label for="quickToolCategory">Kategori</label>
          <select id="quickToolCategory">
            <option value="">V√§lj kategori...</option>
            ${getCategoryOptions()}
          </select>
        `;
        break;
        
      case 'complete':
        html = `
          <label for="quickToolLabel">Namn p√• snabbknapp</label>
          <input type="text" id="quickToolLabel" placeholder="t.ex. Mj√∂lk" value="">
          <label for="quickToolPrice">Pris (kr)</label>
          <input type="number" id="quickToolPrice" min="0" step="0.01" placeholder="t.ex. 18.90" value="0">
          <label for="quickToolCategory">Kategori</label>
          <select id="quickToolCategory">
            <option value="">V√§lj kategori...</option>
            ${getCategoryOptions()}
          </select>
          <label for="quickToolSection">Sektion</label>
          <select id="quickToolSection">
            <option value="">V√§lj sektion...</option>
            ${getSectionOptions()}
          </select>
          <label for="quickToolQty">Antal</label>
          <input type="number" id="quickToolQty" min="1" step="1" placeholder="t.ex. 2" value="1">
        `;
        break;
    }
    
    quickToolInputs.innerHTML = html;
    
    // L√§gg till event listeners f√∂r nya inputs
    quickToolInputs.querySelectorAll('input, select').forEach(input => {
      input.addEventListener('input', updateQuickToolPreview);
      input.addEventListener('change', updateQuickToolPreview);
    });
  }
  
  function updateQuickToolPreview() {
    const label = document.getElementById('quickToolLabel')?.value || '';
    const price = Number(document.getElementById('quickToolPrice')?.value) || 0;
    const category = document.getElementById('quickToolCategory')?.value || '';
    const qty = Number(document.getElementById('quickToolQty')?.value) || 1;
    
    let previewHtml = '<div class="preview-title">F√∂rhandsvisning</div><div class="preview-details">';
    
    if (label) {
      previewHtml += `<div><strong>Namn:</strong> ${escapeHtml(label)}</div>`;
    }
    
    if (price > 0) {
      previewHtml += `<div><strong>Pris:</strong> ${fmtSEK0(price)} per styck</div>`;
    }
    
    if (category) {
      previewHtml += `<div><strong>Kategori:</strong> ${escapeHtml(category)}</div>`;
    }
    
    if (qty > 1) {
      previewHtml += `<div><strong>Antal:</strong> ${qty} st</div>`;
    }
    
    if (price > 0 && qty > 0) {
      const total = price * qty;
      previewHtml += `<div><strong>Totalt:</strong> ${fmtSEK0(total)}</div>`;
    }
    
    if (!label) {
      previewHtml += '<div style="color:#999;">Fyll i namn f√∂r att se f√∂rhandsvisning</div>';
    }
    
    previewHtml += '</div>';
    quickToolPreview.innerHTML = previewHtml;
  }
  
  function applyQuickTool() {
    const label = document.getElementById('quickToolLabel')?.value?.trim();
    if (!label) {
      alert('Ange ett namn f√∂r snabbknappen');
      return;
    }
    
    const price = Number(document.getElementById('quickToolPrice')?.value) || 0;
    const category = document.getElementById('quickToolCategory')?.value?.trim() || '';
    const section = document.getElementById('quickToolSection')?.value?.trim() || '';
    const qty = Number(document.getElementById('quickToolQty')?.value) || 1;
    
    const list = JSON.parse(localStorage.getItem('cart_quick_items') || '[]');
    
    if (editingChipIndex >= 0) {
      // Redigera befintlig snabbknapp
      list[editingChipIndex] = {
        label: label,
        price: price,
        category: category,
        section: section,
        qty: qty
      };
    } else {
      // Skapa ny snabbknapp
      list.push({
        label: label,
        price: price,
        category: category,
        section: section,
        qty: qty
      });
    }
    
    localStorage.setItem('cart_quick_items', JSON.stringify(list));
    loadChips();
    closeQuickToolModal();
    if(cloudEnabled()) cloudSaveDebounced();
  }
  
  // Event listeners f√∂r snabbknappverktyget
  document.querySelectorAll('.quick-tool-type button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentQuickToolType = btn.dataset.type;
      updateQuickToolTypeButtons();
      updateQuickToolInputs();
      updateQuickToolPreview();
    });
  });
  
  quickToolCloseBtn.addEventListener('click', closeQuickToolModal);
  quickToolCancelBtn.addEventListener('click', closeQuickToolModal);
  quickToolBackdrop.addEventListener('click', closeQuickToolModal);
  quickToolApplyBtn.addEventListener('click', applyQuickTool);

  /* ======== Sektioner ======== */
  const sectionsModal = document.getElementById('sectionsModal');
  const sectionsBackdrop = document.getElementById('sectionsBackdrop');
  const sectionsCloseBtn = document.getElementById('sectionsCloseBtn');
  const sectionsCancelBtn = document.getElementById('sectionsCancelBtn');
  const sectionsBtn = document.getElementById('sectionsBtn');
  const newSectionName = document.getElementById('newSectionName');
  const addSectionBtn = document.getElementById('addSectionBtn');
  const sectionsList = document.getElementById('sectionsList');
  
  function getSectionOptions() {
    const sections = loadSections();
    return sections.map(section => `<option value="${escapeHtml(section)}">${escapeHtml(section)}</option>`).join('');
  }
  
  function loadSections() {
    try {
      const sections = JSON.parse(localStorage.getItem('cart_sections') || '[]');
      return Array.isArray(sections) ? sections : [];
    } catch (_) {
      return [];
    }
  }
  
  function saveSections(sections) {
    try {
      localStorage.setItem('cart_sections', JSON.stringify(sections));
      if(cloudEnabled()) cloudSaveDebounced();
    } catch (_) {}
  }
  
  window.openSectionsModal = function() {
    sectionsModal.classList.add('open');
    sectionsBackdrop.classList.add('open');
    sectionsModal.setAttribute('aria-hidden', 'false');
    renderSectionsList();
  };
  
  function closeSectionsModal() {
    sectionsModal.classList.remove('open');
    sectionsBackdrop.classList.remove('open');
    sectionsModal.setAttribute('aria-hidden', 'true');
  }
  
  function renderSectionsList() {
    const sections = loadSections();
    const chips = JSON.parse(localStorage.getItem('cart_quick_items') || '[]');
    
    let html = '';
    sections.forEach(section => {
      const sectionChips = chips.filter(chip => chip.section === section);
      html += `
        <div class="section-item" style="border:1px solid var(--card-border); border-radius:8px; padding:12px; margin-bottom:12px;">
          <div class="section-header">
            <h3>${escapeHtml(section)}</h3>
            <div class="section-actions">
              <button onclick="editSectionName('${escapeHtml(section)}')" title="Redigera sektionsnamn" style="background:#e3f2fd; border-color:#90caf9; color:#1976d2;">Redigera</button>
              <button onclick="deleteSection('${escapeHtml(section)}')" title="Ta bort sektion">Ta bort</button>
            </div>
          </div>
          <div class="section-chips">
            ${sectionChips.length > 0 ? 
              sectionChips.map(chip => `
                <div class="chip">
                  <span>${escapeHtml(chip.label)}</span>
                  <span class="edit" onclick="editQuickChip(${chips.indexOf(chip)}, ${JSON.stringify(chip).replace(/"/g, '&quot;')})" title="Redigera">‚úèÔ∏è</span>
                  <span class="x" onclick="removeChipFromSection('${escapeHtml(section)}', ${chips.indexOf(chip)})" title="Ta bort fr√•n sektion">√ó</span>
                </div>
              `).join('') : 
              '<div style="color:#999; font-style:italic;">Inga snabbknappar i denna sektion</div>'
            }
          </div>
        </div>
      `;
    });
    
    if (sections.length === 0) {
      html = '<div style="text-align:center; color:#999; padding:20px;">Inga sektioner √§nnu. Skapa din f√∂rsta sektion!</div>';
    }
    
    sectionsList.innerHTML = html;
  }
  
  function addSection() {
    const name = newSectionName.value.trim();
    if (!name) {
      alert('Ange ett namn f√∂r sektionen');
      return;
    }
    
    const sections = loadSections();
    if (sections.includes(name)) {
      alert('En sektion med detta namn finns redan');
      return;
    }
    
    sections.push(name);
    saveSections(sections);
    newSectionName.value = '';
    renderSectionsList();
    
    
    loadChips(); // Uppdatera snabbknappar p√• huvudsidan
  }
  
  window.editSectionName = function(oldName) {
    const newName = prompt(`Redigera sektionsnamn:`, oldName);
    if (!newName || newName.trim() === '') {
      return;
    }
    
    const trimmedName = newName.trim();
    if (trimmedName === oldName) {
      return; // Inget √§ndrat
    }
    
    const sections = loadSections();
    if (sections.includes(trimmedName)) {
      alert('En sektion med detta namn finns redan');
      return;
    }
    
    // Uppdatera sektionsnamnet
    const updatedSections = sections.map(s => s === oldName ? trimmedName : s);
    saveSections(updatedSections);
    
    // Uppdatera snabbknappar som tillh√∂r denna sektion
    const chips = JSON.parse(localStorage.getItem('cart_quick_items') || '[]');
    chips.forEach(chip => {
      if (chip.section === oldName) {
        chip.section = trimmedName;
      }
    });
    localStorage.setItem('cart_quick_items', JSON.stringify(chips));
    
    renderSectionsList();
    loadChips(); // Uppdatera snabbknappar
  };

  window.deleteSection = function(sectionName) {
    if (!confirm(`Ta bort sektionen "${sectionName}"? Alla snabbknappar i sektionen kommer att flyttas till "Ingen sektion".`)) {
      return;
    }
    
    const sections = loadSections();
    const filteredSections = sections.filter(s => s !== sectionName);
    saveSections(filteredSections);
    
    // Flytta snabbknappar fr√•n denna sektion
    const chips = JSON.parse(localStorage.getItem('cart_quick_items') || '[]');
    chips.forEach(chip => {
      if (chip.section === sectionName) {
        delete chip.section;
      }
    });
    localStorage.setItem('cart_quick_items', JSON.stringify(chips));
    
    renderSectionsList();
    loadChips(); // Uppdatera snabbknappar
    if(cloudEnabled()) cloudSaveDebounced();
  };
  
  function removeChipFromSection(sectionName, chipIndex) {
    const chips = JSON.parse(localStorage.getItem('cart_quick_items') || '[]');
    if (chips[chipIndex]) {
      delete chips[chipIndex].section;
      localStorage.setItem('cart_quick_items', JSON.stringify(chips));
      renderSectionsList();
      loadChips();
      if(cloudEnabled()) cloudSaveDebounced();
    }
  }
  
  // Event listeners f√∂r sektioner
  sectionsBtn.addEventListener('click', openSectionsModal);
  sectionsCloseBtn.addEventListener('click', closeSectionsModal);
  sectionsCancelBtn.addEventListener('click', closeSectionsModal);
  sectionsBackdrop.addEventListener('click', closeSectionsModal);
  addSectionBtn.addEventListener('click', addSection);
  newSectionName.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addSection();
  });

  /* ======== Vaktsk√§rm / PIN ======== */
  const secureGate=(function(){
    const PIN_OK='8987';
    const MAX_IDLE=60*60*1000; // 60 min
    const gate=document.getElementById('gate');
    const pinForm=document.getElementById('pinForm');
    const pinInput=document.getElementById('pin');
    const clearPinBtn=document.getElementById('clearPin');

    function show(){ gate.classList.remove('hidden'); setTimeout(()=>pinInput.focus(), 0); }
    function hide(){ gate.classList.add('hidden'); }
    function now(){ return Date.now(); }

    function isAuth(){
      try{
        const raw=sessionStorage.getItem('AUTH_OK');
        if(!raw) return false;
        const obj=JSON.parse(raw);
        return obj && obj.expireAt && obj.expireAt > now();
      }catch(_){ return false; }
    }
    function setAuth(){ const expireAt=now()+MAX_IDLE; sessionStorage.setItem('AUTH_OK', JSON.stringify({expireAt})); }
    function clearAuth(){ sessionStorage.removeItem('AUTH_OK'); }

    function checkPin(s){ return String(s||'').trim() === PIN_OK; }

    function onSubmit(ev){
      ev.preventDefault();
      if(checkPin(pinInput.value)){ setAuth(); hide(); }
      else { pinInput.value=''; alert('Fel PIN'); }
    }
    function onKeyBtn(ev){
      const k=ev.target.getAttribute('data-k'); if(!k) return;
      if(pinInput.value.length < 4){ pinInput.value += k; }
      if(pinInput.value.length === 4){
        if(checkPin(pinInput.value)){ setAuth(); hide(); }
        else { pinInput.value=''; alert('Fel PIN'); }
      }
    }
    function bump(){ if(!isAuth()) return; setAuth(); }
    function tick(){ if(!isAuth()){ show(); } setTimeout(tick, 15000); }

    function init(){
      pinForm.querySelectorAll('[data-k]').forEach(b=> b.addEventListener('click', onKeyBtn));
      clearPinBtn.addEventListener('click', ()=> pinInput.value='');
      pinInput.addEventListener('input', ()=>{
        if(pinInput.value.replace(/\D/g,'').length === 4){
          if(checkPin(pinInput.value)){ setAuth(); hide(); }
          else { pinInput.value=''; alert('Fel PIN'); }
        }
      });
      pinForm.addEventListener('submit', onSubmit);
      if(isAuth()) hide(); else show();
      tick();
    }

    logoutBtn.addEventListener('click', ()=>{ clearAuth(); show(); });

    return { init, bump, logout: ()=>{ clearAuth(); show(); } };
  })();

  /* ===== DRAG & DROP FUNKTIONALITET ===== */
  let draggedChip = null;
  let draggedChipData = null;

  function setupDragAndDrop() {
    // L√§gg till drag event listeners p√• alla chips
    document.addEventListener('dragstart', (e) => {
      if (e.target.classList.contains('chip')) {
        draggedChip = e.target;
        draggedChipData = {
          originalIndex: parseInt(e.target.querySelector('.edit').dataset.i),
          section: e.target.closest('.section-item')?.querySelector('h3')?.textContent || null
        };
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.outerHTML);
      }
    });

    document.addEventListener('dragend', (e) => {
      if (e.target.classList.contains('chip')) {
        e.target.classList.remove('dragging');
        draggedChip = null;
        draggedChipData = null;
      }
    });

    // Hantera drop zones f√∂r sektioner
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      const sectionChips = e.target.closest('.section-chips');
      if (sectionChips) {
        sectionChips.classList.add('drag-over');
      }
    });

    document.addEventListener('dragleave', (e) => {
      const sectionChips = e.target.closest('.section-chips');
      if (sectionChips && !sectionChips.contains(e.relatedTarget)) {
        sectionChips.classList.remove('drag-over');
      }
    });

    document.addEventListener('drop', (e) => {
      e.preventDefault();
      const sectionChips = e.target.closest('.section-chips');
      if (sectionChips && draggedChipData) {
        sectionChips.classList.remove('drag-over');
        
        // Hitta sektionens namn
        const sectionName = sectionChips.closest('.section-item').querySelector('h3').textContent;
        
        // Uppdatera snabbknappens sektion i localStorage
        updateChipSection(draggedChipData.originalIndex, sectionName);
        
        // Ladda om snabbknapparna
        loadChips();
      }
    });
  }

  function updateChipSection(chipIndex, newSection) {
    const quickItems = JSON.parse(localStorage.getItem('cart_quick_items') || '[]');
    if (quickItems[chipIndex]) {
      quickItems[chipIndex].section = newSection;
      localStorage.setItem('cart_quick_items', JSON.stringify(quickItems));
      if(cloudEnabled()) cloudSaveDebounced();
    }
  }

  // L√§gg till drag & drop setup n√§r sidan laddas
  document.addEventListener('DOMContentLoaded', setupDragAndDrop);



  /* ======== DELNING ======== */
  function updateShareLink(){ 
    return location.href;
  }

  function copyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        alert('L√§nk kopierad!');
      });
    } else {
      // Fallback f√∂r √§ldre webbl√§sare
      const textArea = document.createElement('textarea');
      textArea.value = text;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('L√§nk kopierad!');
    }
  }

  // Event listeners f√∂r delning
  shareBtn.addEventListener('click', () => {
    const link = updateShareLink();
    copyToClipboard(link);
  });

  copyBtn.addEventListener('click', () => {
    const link = updateShareLink();
    copyToClipboard(link);
  });

  // Mobil delning
  const mobileShareBtn = document.getElementById('mobileShareBtn');
  const mobileCopyBtn = document.getElementById('mobileCopyBtn');
  
  if (mobileShareBtn) {
    mobileShareBtn.addEventListener('click', () => {
      const link = updateShareLink();
      copyToClipboard(link);
    });
  }
  
  if (mobileCopyBtn) {
    mobileCopyBtn.addEventListener('click', () => {
      const link = updateShareLink();
      copyToClipboard(link);
    });
  }

  /* GO */
  init();

})();
</script>
</body>
</html>
