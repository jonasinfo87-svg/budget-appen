<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budgetmall</title>
  <style>
    :root{
      --bg:#f5fbfd; --bg2:#e9f4f7;
      --text:#073642; --text-soft:#1c4a53; --text-invert:#f3fcff;
      --accent:#0d6c77; --muted:#88a8ad; --good:#1b8f4a; --bad:#d23b3b;
      --card:#ffffff; --card-border:#d6e9eb; --table-head:#0b5a64;
      --card-text:#073642; --card-text-soft:#24515a;
    }
    body{
      margin:0; color:var(--text);
      font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(8, 90, 100,.10), transparent 60%),
        radial-gradient(1100px 900px at 110% 110%, rgba(5, 55, 70,.10), transparent 62%),
        radial-gradient(900px 700px at 50% 120%, rgba(19, 60, 70,.09), transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
    button{
      background:var(--card); color:var(--card-text);
      border:1px solid var(--card-border);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      box-shadow:0 1px 1px rgba(0,0,0,.04); min-height:44px; font-size:16px
    }
    button.primary{background:var(--accent);color:#fff;border:0}
    .danger{background:#ffd7d7;border:1px solid #f1bcbc}

    /* Toolbar + chips */
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px;align-items:center}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);
      background:#fff;cursor:pointer; user-select:none;
    }
    .chip .x{font-weight:900;opacity:.55;cursor:pointer}
    .chip .label small{opacity:.65}
    .chip .edit, .chip .handle, .chip .mv{
      font-weight:700; opacity:.7; cursor:pointer; padding:0 4px; border-radius:6px;
    }
    .chip .handle{ cursor:grab }
    .chip.dragging{ opacity:.35 }
    .chip.placeholder{ border:2px dashed var(--card-border); background:transparent; cursor:default; padding:6px 12px }

    /* Sortläge: visa pilar i både toolbar (framtidssäkrat) och sektionerna */
    .chips.sort-mode .mv{ display:inline-block }
    .chip-sections.sort-mode .mv{ display:inline-block }
    .mv{ display:none }
    #sortChipsBtn.active{ background:#e7f6f8; border-color:#bfe5ea }

    /* Sektioner */
    .chip-sections{ display:grid; gap:12px; }
    .chip-section{
      background:#fff; border:1px solid var(--card-border); border-radius:12px;
      padding:10px;
    }
    .chip-section .sec-head{
      display:flex; align-items:center; gap:8px; margin-bottom:8px;
    }
    .chip-section .sec-head h4{
      margin:0; font-size:14px; font-weight:800; color:#24515a;
    }
    .chip-section .sec-head .sec-tools{ margin-left:auto; display:flex; gap:6px; }
    .chip-bin{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; min-height:40px;
    }
    .chip-bin.empty::after{
      content:'Släpp snabbknappar här'; color:#86a6ab; font-size:13px;
    }

    .salary-box{display:flex;gap:12px;align-items:center;margin:8px 0 14px}
    .salary-box input{font-size:16px;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;width:220px;min-height:44px;background:#fff;color:var(--card-text)}

    .table-wrap{overflow:auto;background:var(--card);padding:8px;border-radius:12px;border:1px solid var(--card-border)}
    table{width:100%;border-collapse:collapse;min-width:1180px;background:#fff;border-radius:10px;overflow:hidden;color:var(--card-text)}
    th,td{padding:10px 8px;border:1px solid #cfe6e9;text-align:left;vertical-align:middle}
    th{background:var(--table-head);color:#fff;font-weight:800;white-space:nowrap}
    .right{text-align:right}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .row-actions button{padding:8px 10px;min-height:40px}

    th.col-note{width:520px}
    td.col-note textarea.note-input{
      width:100%; min-height:48px; max-height:200px; resize:vertical;
      box-sizing:border-box; border:1px solid var(--card-border); border-radius:10px;
      padding:10px 12px; font-size:16px; line-height:1.35; background:#fff; color:var(--card-text);
      overflow:auto; white-space:pre-wrap
    }

    td input[type="text"],
    td input[type="number"],
    td select{
      width:100%; box-sizing:border-box;
      border:1px solid var(--card-border);
      background:#fff; color:#073642;
      border-radius:10px; padding:10px 12px;
      font-size:16px; line-height:1.25; min-height:44px;
      appearance:none;
    }
    td input::placeholder{color:#86a6ab}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }

    .sum-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:10px}
    .card{
      background:linear-gradient(180deg,#fff,#f7ffff);
      color:var(--card-text); border-radius:16px; padding:14px;
      border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(0,0,0,.10)
    }
    .card .small{font-size:14px;font-weight:700;color:var(--card-text-soft);margin-bottom:4px}
    .big{font-size:22px;font-weight:900;letter-spacing:.2px}
    .good{color:var(--good)} .bad{color:var(--bad)}
    .c-salary{background:#ffeef0;border-color:#f3c2c6}
    .c-left{background:#fff5e7;border-color:#f6d9b5}
    .c-income{background:#e9f8ee;border-color:#c2e9c9}
    .c-expense{background:#ffe8ea;border-color:#f3b4b8}
    .c-balance{background:#f6f7ff;border-color:#d7defa}
    .c-buffer{background:#f1f7ff;border-color:#cfe3ff}

    .lock{position:fixed;inset:0;display:none;place-items:center;z-index:100000;
      backdrop-filter:blur(8px);background:rgba(10,25,30,.78)}
    .lock.open{display:grid}
    .lock-card{width:min(92vw,560px);background:#fff;color:#0b3b4c;border:1px solid rgba(214,233,235,.9);
      border-radius:22px;padding:22px;box-shadow:0 18px 60px rgba(0,0,0,.24)}
    .pinbox{display:flex;gap:8px;justify-content:center;margin:6px 0 12px}
    .pinbox input{width:54px;height:54px;border-radius:12px;text-align:center;font-size:22px;letter-spacing:2px;border:2px solid #cfe3e6;background:#fff}
    .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0}
    .kbd button{font-size:18px;min-height:52px;border-radius:14px}
    .hint{font-size:12px;color:#777}

    .live-link{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .live-link input{flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;background:#fff;color:#073642;min-height:44px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:100001}
    .modal.open{display:flex}
    .modal-card{width:min(92vw,560px);background:#fff;border:1px solid var(--card-border);border-radius:16px;padding:16px 16px 12px}
    .modal h3{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid .full{grid-column:1/-1}
    .modal input, .modal select, .modal textarea{
      width:100%;box-sizing:border-box;border:1px solid var(--card-border);border-radius:10px;padding:10px 12px;font-size:16px;min-height:44px
    }
    .modal textarea{min-height:72px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .modal label{font-size:13px;color:#586e75;display:block;margin:4px 0}
    .modal .row{display:flex;align-items:center;gap:8px;margin-top:4px}

    @media (max-width:600px){ .wrap{padding:14px} .sum-grid{grid-template-columns:1fr} table{min-width:980px} }
  </style>
</head>
<body>
  <div class="wrap" aria-live="polite">
    <div class="controls">
      <button class="primary" id="addRowBtn">+ Lägg till rad</button>
      <button id="shareBtn">Dela länk</button>
      <button id="shareImageBtn">Dela bild</button>
      <button id="copyBtn">Kopiera</button>
      <button id="lockBtn">Lås</button>
      <button id="resetBtn" class="danger">Nollställ</button>
      <button id="clearMemBtn">Nollställ minne</button>
    </div>

    <!-- Snabbknappar: toolbar -->
    <div class="chips" id="chips">
      <button id="addChipBtn" title="Lägg till snabbknapp">+ Lägg till snabbknapp</button>
      <button id="sortChipsBtn" title="Aktivera sortering (pilar)">Sortera</button>
      <button id="addSectionBtn" title="Skapa ny sektion för snabbknappar">+ Ny sektion</button>
    </div>
    <!-- Sektioner för placering -->
    <div class="chip-sections" id="chipSections"></div>

    <!-- Delningslänk -->
    <div class="live-link">
      <span class="small">Delningslänk:</span>
      <input id="liveLink" type="text" readonly />
      <button id="copyLiveLinkBtn">Kopiera länk</button>
      <span class="small" id="cloudInfo"></span>
    </div>

    <!-- Lön -->
    <div class="card salary-box">
      <div>
        <div class="small">Månadslön (netto)</div>
        <input id="salaryInput" type="number" step="1" min="0" placeholder="t.ex. 36 000" />
      </div>
      <div class="small">Saldot = <strong>(lön + övriga inkomster) − utgifter</strong></div>
    </div>

    <!-- Tabell -->
    <div class="table-wrap card">
      <table id="budgetTable" aria-label="Budgettabell">
        <thead>
          <tr>
            <th style="width:260px">Kategori</th>
            <th style="width:140px">Belopp</th>
            <th style="width:140px">Typ</th>
            <th style="width:170px">Betalsätt</th>
            <th class="col-note">Anteckningar</th>
            <th style="width:220px">Åtgärd</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" style="padding:18px;color:#6b8a90;text-align:center"><em>Inga rader ännu — klicka <strong>+ Lägg till rad</strong> eller använd en snabbknapp.</em></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Kategori-minne -->
    <datalist id="categoryMemory"></datalist>

    <!-- Sumboxar -->
    <div class="sum-grid">
      <div class="card c-salary">
        <div class="small">Månadslön</div>
        <div id="salaryDisplay" class="big">0 kr</div>
      </div>
      <div class="card c-left">
        <div class="small">Kvar av lönen (utan övriga inkomster)</div>
        <div id="salaryLeft" class="big">0 kr</div>
      </div>
      <div class="card c-income">
        <div class="small">Totala inkomster (övriga)</div>
        <div id="totalIncome" class="big good">0 kr</div>
      </div>
      <div class="card c-expense">
        <div class="small">Totala utgifter</div>
        <div id="totalExpense" class="big bad">0 kr</div>
      </div>
      <div class="card c-balance">
        <div class="small">Saldo (inkl. lön + övriga inkomster)</div>
        <div id="balance" class="big">0 kr</div>
      </div>
      <div class="card c-buffer">
        <div class="small">Buffert (möjlig att spara)</div>
        <div id="buffer" class="big">0 kr</div>
      </div>
    </div>
  </div>

  <!-- Lås -->
  <div class="lock" id="lock">
    <div class="lock-card">
      <h3 style="margin:0 0 6px">Skyddad budget</h3>
      <div class="small" style="margin-bottom:10px">Skriv PIN för att öppna (session: 60 min)</div>
      <div class="pinbox">
        <input id="pin1" inputmode="numeric" maxlength="1" />
        <input id="pin2" inputmode="numeric" maxlength="1" />
        <input id="pin3" inputmode="numeric" maxlength="1" />
        <input id="pin4" inputmode="numeric" maxlength="1" />
      </div>
      <div class="kbd">
        <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
        <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
        <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
        <button id="pinClear">C</button><button data-k="0">0</button><button id="pinOk">OK</button>
      </div>
      <div class="hint">Du blir automatiskt utloggad efter inaktivitet.</div>
    </div>
  </div>

  <!-- Modal: skapa/redigera snabbknapp -->
  <div class="modal" id="chipModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="chipTitle">
      <h3 id="chipTitle">Ny snabbknapp</h3>
      <div class="grid">
        <div class="full">
          <label>Kategori (t.ex. “Hyra” eller “Eon”)</label>
          <input id="mLabel" type="text" placeholder="Kategori" />
        </div>
        <div>
          <label>Belopp (kr)</label>
          <input id="mAmount" type="number" inputmode="decimal" placeholder="0" />
        </div>
        <div>
          <label>Typ</label>
          <select id="mType">
            <option>Utgift</option>
            <option>Inkomst</option>
          </select>
        </div>
        <div>
          <label>Betalsätt</label>
          <select id="mPay">
            <option value="">-</option>
            <option>Autogiro</option>
            <option>E-faktura</option>
            <option>Pappersfaktura</option>
            <option>Annat</option>
          </select>
        </div>
        <div>
          <label>Sektion</label>
          <select id="mSection"></select>
        </div>
        <div class="full">
          <div class="row">
            <label style="margin:0">Anteckningar</label>
            <label style="margin-left:auto"><input id="mMirror" type="checkbox" /> Använd betalsätt som anteckning</label>
          </div>
          <textarea id="mNote" placeholder="Valfritt: t.ex. kundnummer, månad, etc."></textarea>
        </div>
      </div>
      <div class="actions">
        <button id="mCancel">Avbryt</button>
        <button class="primary" id="mSave">Spara</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    /* ====== KONFIG ====== */
    const CLOUD = {
      endpoint: 'https://script.google.com/macros/s/AKfycbzgA6bjMpMr8OF-YTdSHKGkfhBj_JNg0RgBD8gxrFozUMbOT2-dLz4zYq3Wp2ZO7fyz-Q/exec',
      secret:   'BudgetSecret123'
    };

    /* ====== HJÄLPARE ====== */
    function getKey(){
      const u = new URL(location.href);
      let k = (u.searchParams.get('key')||'').trim();
      if(!k){
        k = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2,10));
        u.searchParams.set('key', k);
        history.replaceState(null,'',u);
      }
      return k;
    }
    function cloudKey(){ return 'budget_' + getKey(); }
    const LS_ROWS    = ()=>`budget_rows_v2_${getKey()}`;
    const LS_SALARY  = ()=>`budget_salary_v2_${getKey()}`;
    const LS_MEMCAT  = ()=>`budget_cat_memory_v2_${getKey()}`;
    const LS_QUICK   = ()=>`budget_quick_items_v2_${getKey()}`;      // snabbknappar
    const LS_SECTS   = ()=>`budget_quick_sections_v1_${getKey()}`;   // sektioner

    function cloudEnabled(){ return !!CLOUD.endpoint && !!cloudKey(); }
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),wait); }; }
    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    const fmt = new Intl.NumberFormat('sv-SE',{style:'currency',currency:'SEK',maximumFractionDigits:0});

    /* ====== UI REFS ====== */
    const tbody = document.getElementById('tbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const shareBtn = document.getElementById('shareBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareImageBtn = document.getElementById('shareImageBtn');
    const resetBtn = document.getElementById('resetBtn');
    const lockBtn = document.getElementById('lockBtn');

    const chipsWrap = document.getElementById('chips');
    const addChipBtn = document.getElementById('addChipBtn');
    const sortChipsBtn = document.getElementById('sortChipsBtn');
    const addSectionBtn = document.getElementById('addSectionBtn');
    const chipSections = document.getElementById('chipSections');

    const totalIncomeEl   = document.getElementById('totalIncome');
    const totalExpenseEl  = document.getElementById('totalExpense');
    const balanceEl       = document.getElementById('balance');
    const salaryInput     = document.getElementById('salaryInput');
    const salaryLeftEl    = document.getElementById('salaryLeft');
    const salaryDisplayEl = document.getElementById('salaryDisplay');
    const bufferEl        = document.getElementById('buffer');

    const liveLinkInput = document.getElementById('liveLink');
    const copyLiveLinkBtn = document.getElementById('copyLiveLinkBtn');
    const cloudInfo = document.getElementById('cloudInfo');

    const clearMemBtn = document.getElementById('clearMemBtn');
    const categoryMemoryList = document.getElementById('categoryMemory');

    /* Modal */
    const chipModal = document.getElementById('chipModal');
    const chipTitle = document.getElementById('chipTitle');
    const mLabel = document.getElementById('mLabel');
    const mAmount = document.getElementById('mAmount');
    const mType = document.getElementById('mType');
    const mPay = document.getElementById('mPay');
    const mSection = document.getElementById('mSection');
    const mNote = document.getElementById('mNote');
    const mMirror = document.getElementById('mMirror');
    const mCancel = document.getElementById('mCancel');
    const mSave = document.getElementById('mSave');

    /* ====== DATA ====== */
    let rows = [];
    let salary = 0;

    /* ====== LÅS ====== */
    const LOCK = { pin:'8987', timeoutMs: 60*60*1000 };
    const lockEl = document.getElementById('lock');
    const pinInputs = [ 'pin1','pin2','pin3','pin4' ].map(id=>document.getElementById(id));
    const pinOk = document.getElementById('pinOk');
    const pinClear = document.getElementById('pinClear');
    const lockTsKey = ()=>'budget_lock_ts_' + getKey();
    function now(){ return Date.now(); }
    function setUnlockTs(){ localStorage.setItem(lockTsKey(), String(now())); }
    function getUnlockTs(){ const v=localStorage.getItem(lockTsKey()); return v?Number(v):0; }
    function needLock(){ const ts = getUnlockTs(); return !ts || (now()-ts) > LOCK.timeoutMs; }
    function openLock(){ lockEl.classList.add('open'); pinInputs[0].focus(); }
    function closeLock(){ lockEl.classList.remove('open'); setUnlockTs(); }
    function tryUnlock(){
      const val = pinInputs.map(i=>i.value).join('');
      if(val === LOCK.pin){ closeLock(); pinInputs.forEach(i=>i.value=''); }
      else { pinInputs.forEach(i=>i.value=''); pinInputs[0].focus(); alert('Fel PIN'); }
    }
    pinOk.onclick = tryUnlock;
    pinClear.onclick = ()=>{ pinInputs.forEach(i=>i.value=''); pinInputs[0].focus(); };
    lockBtn.onclick = openLock;
    lockEl.querySelectorAll('[data-k]').forEach(b=> b.addEventListener('click', (e)=>{
      const k = e.currentTarget.getAttribute('data-k');
      for(const inp of pinInputs){ if(inp.value===''){ inp.value=k; break; } }
    }));
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden') setUnlockTs();
    });
    if(needLock()) openLock();

    /* ====== DELNING ====== */
    function updateShareLink(){ liveLinkInput.value = location.href; }
    copyLiveLinkBtn.onclick = ()=>{
      const t = liveLinkInput.value;
      (navigator.clipboard ? navigator.clipboard.writeText(t) : Promise.reject())
        .then(()=>alert('Länk kopierad.'))
        .catch(()=>prompt('Kopiera manuellt:', t));
    };
    shareBtn.onclick = ()=> copyLiveLinkBtn.click();
    copyBtn.onclick = ()=> copyLiveLinkBtn.click();
    updateShareLink();

    /* ====== KATEGORI-MINNE ====== */
    function loadCategoryMemory(){
      let arr = []; try{ arr = JSON.parse(localStorage.getItem(LS_MEMCAT())||'[]'); }catch(_){}
      if(!Array.isArray(arr)) arr = [];
      categoryMemoryList.innerHTML = arr.map(v=>`<option value="${escapeHtml(v)}"></option>`).join('');
      return arr;
    }
    function saveCategoryToMemory(s){
      const label = String(s||'').trim();
      if(!label) return;
      const arr = loadCategoryMemory();
      if(!arr.includes(label)){
        arr.push(label);
        localStorage.setItem(LS_MEMCAT(), JSON.stringify(arr));
        loadCategoryMemory();
      }
    }
    function clearCategoryMemory(){ localStorage.removeItem(LS_MEMCAT()); loadCategoryMemory(); }
    clearMemBtn.onclick = ()=>{ if(confirm('Rensa endast kategori-minnet? (påverkar inte dina rader)')) clearCategoryMemory(); };

    /* ====== SEKTIONER ====== */
    function uid(){ return 'sec_' + Math.random().toString(36).slice(2,9); }
    function loadSections(){
      let secs=[]; try{ secs = JSON.parse(localStorage.getItem(LS_SECTS())||'[]'); }catch(_){}
      if(!Array.isArray(secs)) secs=[];
      if(secs.length===0){ secs=[{id:'sec_default', name:'Snabbknappar'}]; localStorage.setItem(LS_SECTS(), JSON.stringify(secs)); }
      return secs;
    }
    // SPARA sektioner + trigga moln
    function saveSections(secs){
      localStorage.setItem(LS_SECTS(), JSON.stringify(secs));
      cloudSaveDebounced(); // autospara till moln
    }

    /* ====== CHIP-MODAL (ny + redigera) ====== */
    let editingChipAbs = -1; // absolut index i listan, -1 = ny
    function openChipModal(absIndex){
      const list = JSON.parse(localStorage.getItem(LS_QUICK())||'[]');
      ensureSectionOptions(mSection);
      editingChipAbs = (typeof absIndex==='number' && absIndex>=0) ? absIndex : -1;
      if(editingChipAbs >= 0 && list[editingChipAbs]){
        const c = list[editingChipAbs];
        chipTitle.textContent = 'Redigera snabbknapp';
        mLabel.value = c.label || '';
        mAmount.value = Number(c.amount||0) || '';
        mType.value = (c.type==='Inkomst'?'Inkomst':'Utgift');
        mPay.value = c.pay || '';
        mSection.value = c.sec || 'sec_default';
        mMirror.checked = false;
        mNote.value = c.note || '';
      }else{
        chipTitle.textContent = 'Ny snabbknapp';
        mLabel.value=''; mAmount.value=''; mType.value='Utgift'; mPay.value='';
        mSection.value = 'sec_default';
        mMirror.checked=false; mNote.value='';
      }
      chipModal.classList.add('open');
      mLabel.focus();
    }
    function closeChipModal(){ chipModal.classList.remove('open'); }
    document.getElementById('addChipBtn').addEventListener('click', ()=>openChipModal(-1));
    mCancel.addEventListener('click', closeChipModal);
    chipModal.addEventListener('click', (e)=>{ if(e.target===chipModal) closeChipModal(); });
    mMirror.addEventListener('change', ()=>{ if(mMirror.checked) mNote.value = mPay.value || ''; });
    mPay.addEventListener('change', ()=>{ if(mMirror.checked) mNote.value = mPay.value || ''; });

    function ensureSectionOptions(selectEl){
      const secs = loadSections();
      selectEl.innerHTML = secs.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
    }

    mSave.addEventListener('click', ()=>{
      const label = mLabel.value.trim();
      if(!label){ alert('Skriv en kategori.'); mLabel.focus(); return; }
      const obj = {
        label,
        amount: Number(mAmount.value)||0,
        type: mType.value==='Inkomst' ? 'Inkomst' : 'Utgift',
        pay: mPay.value || '',
        sec: mSection.value || 'sec_default',
        note: (mMirror.checked ? (mPay.value||'') : mNote.value.trim())
      };
      const list = JSON.parse(localStorage.getItem(LS_QUICK())||'[]') || [];
      if(editingChipAbs >= 0 && list[editingChipAbs]){
        list[editingChipAbs] = obj;
      }else{
        list.push(obj);
      }
      localStorage.setItem(LS_QUICK(), JSON.stringify(list));
      cloudSaveDebounced(); // NYTT: synka moln
      saveCategoryToMemory(label);
      loadChips();
      closeChipModal();
    });

    /* ====== SNABBKNAPPAR: render, DnD, sort-läge, sektioner ====== */
    let ph = null; // placeholder element
    let dragFromAbs = null; // absolut index i listan
    function makePlaceholder(){ const e=document.createElement('div'); e.className='chip placeholder'; e.textContent=' '; return e; }

    function items(){
      let a=[]; try{ a=JSON.parse(localStorage.getItem(LS_QUICK())||'[]'); }catch(_){a=[]}
      if(!Array.isArray(a)) a=[];
      a.forEach(it=>{ if(!it.sec) it.sec='sec_default'; });
      return a;
    }
    // SPARA chips + trigga moln
    function saveItems(a){
      localStorage.setItem(LS_QUICK(), JSON.stringify(a));
      cloudSaveDebounced(); // NYTT
    }

    function absoluteInsertIndexForSection(secId, secIndex, list){
      let count=0;
      for(let i=0;i<list.length;i++){
        if(list[i].sec===secId){
          if(count===secIndex) return i;
          count++;
        }
      }
      let last=-1;
      for(let i=0;i<list.length;i++) if(list[i].sec===secId) last=i;
      return (last>=0)? (last+1) : list.length;
    }

    function secIndexOfAbs(absIndex, list){
      const sec = list[absIndex].sec;
      let idx=0;
      for(let i=0;i<absIndex;i++){
        if(list[i].sec===sec) idx++;
      }
      return { sec, index: idx };
    }

    function moveChip(absFrom, toSecId, toSecIndex){
      let list = items();
      if(absFrom<0 || absFrom>=list.length) return;
      const [item] = list.splice(absFrom,1);
      item.sec = toSecId;
      const insertAt = absoluteInsertIndexForSection(toSecId, toSecIndex, list);
      list.splice(insertAt, 0, item);
      saveItems(list);
      loadChips();
    }

    function moveChipBy(absFrom, deltaWithinSec){
      let list = items();
      const {sec, index} = secIndexOfAbs(absFrom, list);
      const chipsInSec = list.filter(x=>x.sec===sec).length;
      const newIndex = Math.max(0, Math.min(chipsInSec-1, index+deltaWithinSec));
      moveChip(absFrom, sec, newIndex);
    }

    // flytta upp/ner mellan sektioner
    function moveChipToAdjacentSection(absFrom, dir){
      const list = items();
      const secs = loadSections();
      const {sec, index} = secIndexOfAbs(absFrom, list);
      let si = secs.findIndex(s=>s.id===sec); if(si<0) si=0;
      const newSi = dir==='up' ? si-1 : si+1;
      if(newSi<0 || newSi>=secs.length) return; // utanför gräns
      const newSecId = secs[newSi].id;
      const targetCount = list.filter(x=>x.sec===newSecId).length;
      const toIndex = Math.min(index, targetCount); // behåll ungefär samma position
      moveChip(absFrom, newSecId, toIndex);
    }

    function renderSection(sec){
      const box = document.createElement('div');
      box.className='chip-section';
      box.setAttribute('data-sec', sec.id);

      const head = document.createElement('div');
      head.className='sec-head';
      head.innerHTML = `<h4>${escapeHtml(sec.name)}</h4>`;
      const tools = document.createElement('div');
      tools.className='sec-tools';
      const btnRename = document.createElement('button'); btnRename.textContent='Byt namn';
      const btnDelete = document.createElement('button'); btnDelete.textContent='Ta bort';
      tools.appendChild(btnRename); tools.appendChild(btnDelete);
      head.appendChild(tools);
      box.appendChild(head);

      const bin = document.createElement('div');
      bin.className='chip-bin empty';
      bin.setAttribute('data-sec', sec.id);
      box.appendChild(bin);

      // DnD exakt placering
      bin.addEventListener('dragover', (e)=>{
        e.preventDefault();
        const chips = [...bin.querySelectorAll('.chip[data-abs]')];
        if(chips.length) bin.classList.remove('empty');
        const x = e.clientX, y = e.clientY;
        let after = null;
        for(const child of chips){
          const rect = child.getBoundingClientRect();
          if(x>=rect.left && x<=rect.right && y>=rect.top && y<=rect.bottom){
            const mid = rect.left + rect.width/2;
            after = (x >= mid) ? child.nextSibling : child;
            break;
          }
        }
        if(!ph) ph = makePlaceholder();
        if(after) bin.insertBefore(ph, after);
        else bin.appendChild(ph);
      });
      bin.addEventListener('drop', (e)=>{
        e.preventDefault();
        if(dragFromAbs==null) return;
        const toSec = bin.getAttribute('data-sec');
        let toIndex = 0;
        for(const child of bin.children){
          if(child===ph) break;
          if(child.classList && child.classList.contains('chip') && child.hasAttribute('data-abs')) toIndex++;
        }
        moveChip(dragFromAbs, toSec, toIndex);
        cleanupPlaceholder();
      });

      // tools
      btnRename.onclick = ()=>{
        const name = prompt('Nytt namn på sektion:', sec.name);
        if(!name) return;
        const secs = loadSections();
        const i = secs.findIndex(s=>s.id===sec.id);
        if(i>-1){ secs[i].name = name.trim(); saveSections(secs); loadChips(); }
      };
      btnDelete.onclick = ()=>{
        const list = items();
        if(list.some(x=>x.sec===sec.id)){ alert('Sektionen är inte tom. Flytta eller ta bort snabbknappar först.'); return; }
        const secs = loadSections().filter(s=>s.id!==sec.id);
        if(secs.length===0){ alert('Minst en sektion krävs.'); return; }
        saveSections(secs); loadChips();
      };

      return box;
    }

    function cleanupPlaceholder(){
      if(ph && ph.parentNode) ph.parentNode.removeChild(ph);
      ph=null; dragFromAbs=null;
    }

    function loadChips(){
      chipSections.innerHTML='';
      const secs = loadSections();
      secs.forEach(sec=> chipSections.appendChild(renderSection(sec)));

      const list = items();
      list.forEach((c,absIdx)=>{
        const bin = chipSections.querySelector(`.chip-bin[data-sec="${c.sec||'sec_default'}"]`) || chipSections.querySelector('.chip-bin[data-sec="sec_default"]');
        if(bin) bin.classList.remove('empty');
        const el = document.createElement('div');
        el.className='chip';
        el.setAttribute('draggable','true');
        el.setAttribute('data-abs', String(absIdx));

        const tags = [c.type||'Utgift', c.pay||'−'].filter(Boolean).join(' · ');
        el.innerHTML = `
          <span class="handle" title="Dra för att flytta">≡</span>
          <span class="label">${escapeHtml(c.label)} <small>(${escapeHtml(tags)})</small></span>
          <span class="mv" data-mv="left"  title="Flytta vänster (inom sektion)">←</span>
          <span class="mv" data-mv="right" title="Flytta höger (inom sektion)">→</span>
          <span class="mv" data-mv="up"    title="Flytta till sektionen ovan">↑</span>
          <span class="mv" data-mv="down"  title="Flytta till sektionen nedan">↓</span>
          <span class="edit" title="Redigera">✎</span>
          <span class="x" title="Ta bort">×</span>
        `;

        // klick = lägg till rad
        el.addEventListener('click',(ev)=>{
          const t = ev.target;
          if(t.classList.contains('x') || t.classList.contains('edit') || t.classList.contains('handle') || t.classList.contains('mv')) return;
          rows.push({ category:c.label||'', amount:Number(c.amount||0), type:(c.type||'Utgift'), pay:(c.pay||''), note:(c.note||'') });
          render(); updateTotals(); saveLocal(); cloudSaveDebounced();
        });

        // ta bort
        el.querySelector('.x').addEventListener('click',(ev)=>{
          ev.stopPropagation();
          const arr = items();
          arr.splice(absIdx,1); saveItems(arr); loadChips();
        });

        // redigera
        el.querySelector('.edit').addEventListener('click',(ev)=>{
          ev.stopPropagation();
          openChipModal(absIdx);
        });

        // pilar
        el.querySelectorAll('.mv').forEach(btn=>{
          btn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const dir = btn.getAttribute('data-mv');
            if(dir==='left')  return moveChipBy(absIdx, -1);
            if(dir==='right') return moveChipBy(absIdx, +1);
            if(dir==='up')    return moveChipToAdjacentSection(absIdx, 'up');
            if(dir==='down')  return moveChipToAdjacentSection(absIdx, 'down');
          });
        });

        // DnD
        el.addEventListener('dragstart', (e)=>{
          dragFromAbs = absIdx;
          el.classList.add('dragging');
          try{ e.dataTransfer.setData('text/plain', String(absIdx)); }catch(_){}
          e.dataTransfer.effectAllowed='move';
        });
        el.addEventListener('dragend', ()=>{
          el.classList.remove('dragging');
          cleanupPlaceholder();
        });

        bin && bin.appendChild(el);
      });

      chipSections.querySelectorAll('.chip-bin').forEach(b=>{
        if(!b.querySelector('.chip')) b.classList.add('empty');
      });
    }

    // Sortläge: visa pilar
    sortChipsBtn.addEventListener('click', ()=>{
      sortChipsBtn.classList.toggle('active');
      chipsWrap.classList.toggle('sort-mode');     // ev. chips i toolbar
      chipSections.classList.toggle('sort-mode');  // pilar i sektioner
    });

    // Ny sektion
    addSectionBtn.addEventListener('click', ()=>{
      const name = prompt('Namn på ny sektion:', 'Ny sektion');
      if(!name) return;
      const secs = loadSections();
      secs.push({id:uid(), name:name.trim()});
      saveSections(secs); // triggar moln
      loadChips();
    });

    /* ====== MOLN (AUTOSAVE) ====== */
    let isLoadingFromCloud = false;
    function payload(){
      return {
        rows,
        salary: Number(salary)||0,
        quick: items(),           // snabbknappar
        sections: loadSections(), // sektioner
        updatedAt: Date.now()
      };
    }

    async function cloudSave(){
      if(!cloudEnabled() || isLoadingFromCloud) return;
      try{
        const form = new URLSearchParams();
        form.set('op','save');
        form.set('key', cloudKey());
        form.set('secret', CLOUD.secret||'');
        form.set('data', JSON.stringify(payload()));
        const res = await fetch(CLOUD.endpoint, { method:'POST', body: form });
        await res.text();
        cloudInfo.textContent = 'Autosparat ✔︎';
      }catch(err){
        cloudInfo.textContent = 'Kunde inte autospara';
      }
    }
    const cloudSaveDebounced = debounce(cloudSave, 1000);

    async function cloudLoad(){
      if(!cloudEnabled()) return;
      isLoadingFromCloud = true;
      try{
        const url = `${CLOUD.endpoint}?op=load&key=${encodeURIComponent(cloudKey())}&secret=${encodeURIComponent(CLOUD.secret||'')}`;
        const res = await fetch(url, { method:'GET' });
        const text = await res.text();
        let json; try{ json = JSON.parse(text); }catch(_){}
        const data = (json && json.ok && json.data) ? json.data : json;

        if(data && Array.isArray(data.rows)){
          rows = data.rows.map(r=>({
            category:r.category||'',
            amount:Number(r.amount)||0,
            type:r.type==='Inkomst'?'Inkomst':'Utgift',
            pay:(typeof r.pay==='string')?r.pay:'',
            note:r.note||''
          }));
          salary = Number(data.salary)||0;
          salaryInput.value = salary || '';
          cloudInfo.textContent = 'Moln laddat';
        }else{
          cloudInfo.textContent = 'Ingen molndata (än)';
        }

        // NYTT: hämta snabbknappar + sektioner till localStorage
        if (data && Array.isArray(data.quick)) {
          localStorage.setItem(LS_QUICK(), JSON.stringify(data.quick));
        }
        if (data && Array.isArray(data.sections)) {
          localStorage.setItem(LS_SECTS(), JSON.stringify(data.sections));
        }

      }catch(err){
        console.warn('Moln load fel:', err);
        cloudInfo.textContent = 'Molnfel vid laddning';
      }finally{
        render(); updateTotals(); loadChips(); // se till att UI visar chips/sektioner från molnet
        isLoadingFromCloud = false;
      }
    }

    /* ====== LOCAL SAVE ====== */
    function saveLocal(){
      localStorage.setItem(LS_ROWS(), JSON.stringify(rows));
      localStorage.setItem(LS_SALARY(), String(Number(salary)||0));
    }
    function loadLocal(){
      try{ const r = JSON.parse(localStorage.getItem(LS_ROWS())||'[]'); if(Array.isArray(r)) rows = r; }catch(_) {}
      salary = Number(localStorage.getItem(LS_SALARY())||0) || 0;
      salaryInput.value = salary || '';
    }

    /* ====== INIT ====== */
    function init(){
      loadCategoryMemory();
      loadLocal();
      loadChips();     // rita ev. lokala chips direkt
      cloudLoad();     // och ersätt med moln om sådant finns
      render(); updateTotals();

      salaryInput.addEventListener('input', ()=>{
        salary = Number(salaryInput.value)||0;
        saveLocal(); cloudSaveDebounced(); updateTotals();
      });
      document.addEventListener('visibilitychange', ()=>{
        if(document.visibilityState==='hidden'){ saveLocal(); cloudSave(); setUnlockTs(); }
      });
      cloudInfo.textContent = `Moln-nyckel: ${cloudKey()}`;
    }

    /* ====== RENDER TABELL ====== */
    function autoGrow(el){
      el.style.height = 'auto';
      const h = Math.min(200, Math.max(48, el.scrollHeight+2));
      el.style.height = h + 'px';
    }

    function render(){
      tbody.innerHTML = '';
      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="padding:18px;color:#6b8a90;text-align:center"><em>Inga rader ännu — klicka <strong>+ Lägg till rad</strong> eller använd en snabbknapp.</em></td>`;
        tbody.appendChild(tr);
        return;
      }
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" data-i="${i}" data-col="category" value="${escapeHtml(r.category)}" placeholder="Kategori" list="categoryMemory"></td>
          <td class="right"><input type="number" data-i="${i}" data-col="amount" value="${Number(r.amount)||0}" step="1" inputmode="decimal" placeholder="0"></td>
          <td>
            <select data-i="${i}" data-col="type">
              <option ${r.type==='Utgift'?'selected':''}>Utgift</option>
              <option ${r.type==='Inkomst'?'selected':''}>Inkomst</option>
            </select>
          </td>
          <td>
            <select data-i="${i}" data-col="pay">
              <option value="" ${(!r.pay||r.pay==='')?'selected':''}>-</option>
              <option value="Autogiro" ${r.pay==='Autogiro'?'selected':''}>Autogiro</option>
              <option value="E-faktura" ${r.pay==='E-faktura'?'selected':''}>E-faktura</option>
              <option value="Pappersfaktura" ${r.pay==='Pappersfaktura'?'selected':''}>Pappersfaktura</option>
              <option value="Annat" ${r.pay==='Annat'?'selected':''}>Annat</option>
            </select>
          </td>
          <td class="col-note">
            <textarea class="note-input" data-i="${i}" data-col="note" placeholder="Anteckningar (valfritt) – större fält">${escapeHtml(r.note||'')}</textarea>
          </td>
          <td class="row-actions">
            <button data-action="up" data-i="${i}" title="Flytta upp">↑</button>
            <button data-action="down" data-i="${i}" title="Flytta ner">↓</button>
            <button data-action="neg" data-i="${i}" title="Växla +/−">±</button>
            <button data-action="del" data-i="${i}" title="Ta bort" class="danger">Ta bort</button>
          </td>`;
        tbody.appendChild(tr);
      });
      attachEvents();
      tbody.querySelectorAll('textarea.note-input').forEach(t=>autoGrow(t));
    }

    function attachEvents(){
      tbody.querySelectorAll('input[data-col], select[data-col], textarea[data-col]').forEach(el=>{
        const handler = ()=>{
          const i = +el.dataset.i, col = el.dataset.col;
          if(!rows[i]) return;
          if(col==='amount') rows[i][col] = Number(el.value)||0;
          else rows[i][col] = el.value;
          if(col==='category') saveCategoryToMemory(el.value);
          saveLocal(); cloudSaveDebounced(); updateTotals();
          if(el.tagName==='TEXTAREA') autoGrow(el);
        };
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
        if(el.dataset.col==='amount'){
          el.onfocus = ()=>{ if(el.value==='0'||el.value==='') el.value=''; };
          el.onblur = ()=>{ if(el.value===''||isNaN(Number(el.value))){ el.value='0'; handler(); } };
        }
      });

      tbody.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.dataset.i, act = btn.dataset.action;
          if(act==='del'){ rows.splice(i,1); render(); }
          else if(act==='neg'){ rows[i].amount = -rows[i].amount; render(); }
          else if(act==='up'){ if(i>0) moveRow(i,i-1); }
          else if(act==='down'){ if(i<rows.length-1) moveRow(i,i+1); }
          saveLocal(); cloudSaveDebounced(); updateTotals();
        };
      });
    }

    function moveRow(from,to){
      if(from<0||to<0||from>=rows.length||to>=rows.length) return;
      const item = rows.splice(from,1)[0]; rows.splice(to,0,item); render();
    }

    addRowBtn.onclick = ()=>{
      rows.push({category:'', amount:0, type:'Utgift', pay:'', note:''});
      render(); updateTotals(); saveLocal(); cloudSaveDebounced();
      const lastInput = document.querySelector('#tbody tr:last-child td:first-child input');
      if(lastInput) lastInput.focus();
    };

    function updateTotals(){
      let sumIncome = 0, sumExpense = 0;
      rows.forEach(r=>{
        const amt = Number(r.amount)||0;
        if(r.type==='Inkomst') sumIncome += amt; else sumExpense += amt;
      });
      totalIncomeEl.textContent  = fmt.format(Math.round(sumIncome));
      totalExpenseEl.textContent = fmt.format(Math.round(sumExpense));
      const s = Number(salary)||0;
      salaryDisplayEl.textContent = fmt.format(Math.round(s));
      const salaryLeft = Math.round(s - sumExpense);
      salaryLeftEl.textContent = fmt.format(salaryLeft);
      const balance = Math.round(s + sumIncome - sumExpense);
      balanceEl.textContent = fmt.format(balance);
      bufferEl.textContent = fmt.format(balance);

      salaryLeftEl.classList.toggle('bad', salaryLeft<0);
      salaryLeftEl.classList.toggle('good', salaryLeft>=0);
      balanceEl.classList.toggle('bad', balance<0);
      balanceEl.classList.toggle('good', balance>=0);
      bufferEl.classList.toggle('bad', balance<0);
      bufferEl.classList.toggle('good', balance>=0);
    }

    async function ensureHtml2Canvas(){
      if(window.html2canvas) return;
      await new Promise((res, rej)=>{
        const s = document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('Kunde inte ladda html2canvas'));
        document.head.appendChild(s);
      });
    }
    function buildImageSourceElement(){
      const tmp=document.createElement('div');
      tmp.style.position='fixed'; tmp.style.left='-99999px'; tmp.style.top='0';
      tmp.style.padding='12px'; tmp.style.background='#ffffff';
      tmp.style.width=(document.querySelector('.table-wrap')?.offsetWidth||800)+'px';
      const title=document.createElement('div');
      title.style.font='600 18px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial';
      title.style.margin='0 0 8px'; title.textContent='Budgetöversikt';
      tmp.appendChild(title);
      const tableClone=document.querySelector('.table-wrap')?.cloneNode(true);
      const sumClone=document.querySelector('.sum-grid')?.cloneNode(true);
      if(tableClone) tmp.appendChild(tableClone);
      if(sumClone){ sumClone.style.marginTop='8px'; tmp.appendChild(sumClone); }
      document.body.appendChild(tmp); return tmp;
    }
    function dataURLFromCanvas(c){ try{ return c.toDataURL('image/png'); }catch(_){ return null; } }
    shareImageBtn.onclick = async ()=>{
      try{
        await ensureHtml2Canvas();
        const src=buildImageSourceElement();
        const canvas=await html2canvas(src,{backgroundColor:'#ffffff',scale:window.devicePixelRatio>1?2:1,useCORS:true});
        document.body.removeChild(src);
        const url=dataURLFromCanvas(canvas);
        if(!url) throw new Error('PNG misslyckades');
        const a=document.createElement('a'); a.download='budget.png'; a.href=url; document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ alert('Kunde inte skapa bild: ' + e.message); }
    };

    resetBtn.onclick = ()=>{
      if(!confirm('Nollställa rader + lön? (Kategori-minne och snabbknappar påverkas inte)')) return;
      rows=[]; salary=0; salaryInput.value='';
      saveLocal(); render(); updateTotals(); cloudSave();
    };

    /* GO */
    init();
  })();
  </script>
</body>
</html>
