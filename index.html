<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Budgetmall</title>
  <style>
    :root{
      --bg:#f5fbfd; --bg2:#e9f4f7;
      --text:#073642; --text-soft:#1c4a53; --text-invert:#f3fcff;
      --accent:#0d6c77; --muted:#88a8ad; --good:#1b8f4a; --bad:#d23b3b;
      --card:#ffffff; --card-border:#d6e9eb; --table-head:#0b5a64;
      --card-text:#073642; --card-text-soft:#24515a;
    }
    body{
      margin:0; color:var(--text);
      font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 800px at 15% -10%, rgba(8, 90, 100,.10), transparent 60%),
        radial-gradient(1100px 900px at 110% 110%, rgba(5, 55, 70,.10), transparent 62%),
        radial-gradient(900px 700px at 50% 120%, rgba(19, 60, 70,.09), transparent 65%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px;align-items:center}
    button{
      background:var(--card); color:var(--card-text);
      border:1px solid var(--card-border);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      box-shadow:0 1px 1px rgba(0,0,0,.04); min-height:44px; font-size:16px
    }
    button.primary{background:var(--accent);color:#fff;border:0}
    .danger{background:#ffd7d7;border:1px solid #f1bcbc}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 14px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--card-border);background:#fff;cursor:pointer}
    .chip .x{font-weight:900;opacity:.55;cursor:pointer}

    .salary-box{display:flex;gap:12px;align-items:center;margin:8px 0 14px}
    .salary-box input{font-size:16px;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;width:220px;min-height:44px;background:#fff;color:var(--card-text)}

    .table-wrap{overflow:auto;background:var(--card);padding:8px;border-radius:12px;border:1px solid var(--card-border)}
    table{width:100%;border-collapse:collapse;min-width:1180px;background:#fff;border-radius:10px;overflow:hidden;color:var(--card-text)}
    th,td{padding:10px 8px;border:1px solid #cfe6e9;text-align:left;vertical-align:middle}
    th{background:var(--table-head);color:#fff;font-weight:800;white-space:nowrap}
    .right{text-align:right}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .row-actions button{padding:8px 10px;min-height:40px}

    /* BRED OCH LÄTTLÄST ANTECKNING */
    th.col-note{width:520px}
    td.col-note textarea.note-input{
      width:100%; min-height:48px; max-height:160px; resize:vertical;
      box-sizing:border-box; border:1px solid var(--card-border); border-radius:10px;
      padding:10px 12px; font-size:16px; line-height:1.35; background:#fff; color:var(--card-text);
      overflow:auto; white-space:pre-wrap
    }

    /* övriga inputs */
    td input[type="text"],
    td input[type="number"],
    td select{
      width:100%; box-sizing:border-box;
      border:1px solid var(--card-border);
      background:#fff; color:var(--card-text);
      border-radius:10px; padding:10px 12px;
      font-size:16px; line-height:1.25; min-height:44px;
      appearance:none;
    }
    td input::placeholder{color:#86a6ab}
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
    input[type=number]{ -moz-appearance:textfield; }

    .sum-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:14px;margin-top:10px}
    .card{
      background:linear-gradient(180deg,#fff,#f7ffff);
      color:var(--card-text); border-radius:16px; padding:14px;
      border:1px solid var(--card-border); box-shadow:0 8px 24px rgba(0,0,0,.10)
    }
    .card .small{font-size:14px;font-weight:700;color:var(--card-text-soft);margin-bottom:4px}
    .big{font-size:22px;font-weight:900;letter-spacing:.2px}
    .good{color:var(--good)} .bad{color:var(--bad)}
    .c-salary{background:#ffeef0;border-color:#f3c2c6}
    .c-left{background:#fff5e7;border-color:#f6d9b5}
    .c-income{background:#e9f8ee;border-color:#c2e9c9}
    .c-expense{background:#ffe8ea;border-color:#f3b4b8}
    .c-balance{background:#f6f7ff;border-color:#d7defa}
    .c-buffer{background:#f1f7ff;border-color:#cfe3ff}

    /* LÅS */
    .lock{position:fixed;inset:0;display:none;place-items:center;z-index:100000;
      backdrop-filter:blur(8px);background:rgba(10,25,30,.78)}
    .lock.open{display:grid}
    .lock-card{width:min(92vw,560px);background:#fff;color:#0b3b4c;border:1px solid rgba(214,233,235,.9);
      border-radius:22px;padding:22px;box-shadow:0 18px 60px rgba(0,0,0,.24)}
    .pinbox{display:flex;gap:8px;justify-content:center;margin:6px 0 12px}
    .pinbox input{width:54px;height:54px;border-radius:12px;text-align:center;font-size:22px;letter-spacing:2px;border:2px solid #cfe3e6;background:#fff}
    .kbd{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0}
    .kbd button{font-size:18px;min-height:52px;border-radius:14px}
    .hint{font-size:12px;color:#777}

    /* DELNINGSRAD */
    .live-link{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px}
    .live-link input{flex:1;min-width:260px;padding:10px 12px;border:1px solid var(--card-border);border-radius:10px;background:#fff;color:var(--card-text);min-height:44px}

    /* MODAL: snabbknapp */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:100001}
    .modal.open{display:flex}
    .modal-card{width:min(92vw,560px);background:#fff;border:1px solid var(--card-border);border-radius:16px;padding:16px 16px 12px}
    .modal h3{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid .full{grid-column:1/-1}
    .modal input, .modal select, .modal textarea{
      width:100%;box-sizing:border-box;border:1px solid var(--card-border);border-radius:10px;padding:10px 12px;font-size:16px;min-height:44px
    }
    .modal textarea{min-height:72px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .modal label{font-size:13px;color:#586e75;display:block;margin:4px 0}
    .modal .row{display:flex;align-items:center;gap:8px;margin-top:4px}
    @media (max-width:600px){ .wrap{padding:14px} .sum-grid{grid-template-columns:1fr} table{min-width:980px} }
  </style>
</head>
<body>
  <div class="wrap" aria-live="polite">
    <div class="controls">
      <button class="primary" id="addRowBtn">+ Lägg till rad</button>
      <button id="shareBtn">Dela länk</button>
      <button id="shareImageBtn">Dela bild</button>
      <button id="copyBtn">Kopiera</button>
      <button id="lockBtn">Lås</button>
      <button id="resetBtn" class="danger">Nollställ</button>
      <button id="clearMemBtn">Nollställ minne</button>
    </div>

    <!-- Snabbknappar -->
    <div class="chips" id="chips">
      <button id="addChipBtn" title="Lägg till snabbknapp">+ Lägg till snabbknapp</button>
    </div>

    <!-- Delningslänk -->
    <div class="live-link">
      <span class="small">Delningslänk:</span>
      <input id="liveLink" type="text" readonly />
      <button id="copyLiveLinkBtn">Kopiera länk</button>
      <span class="small" id="cloudInfo"></span>
    </div>

    <!-- Lön -->
    <div class="card salary-box">
      <div>
        <div class="small">Månadslön (netto)</div>
        <input id="salaryInput" type="number" step="1" min="0" placeholder="t.ex. 36 000" />
      </div>
      <div class="small">Saldot = <strong>(lön + övriga inkomster) − utgifter</strong></div>
    </div>

    <!-- Tabell -->
    <div class="table-wrap card">
      <table id="budgetTable" aria-label="Budgettabell">
        <thead>
          <tr>
            <th style="width:260px">Kategori</th>
            <th style="width:140px">Belopp</th>
            <th style="width:140px">Typ</th>
            <th style="width:170px">Betalsätt</th>
            <th class="col-note">Anteckningar</th>
            <th style="width:220px">Åtgärd</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" style="padding:18px;color:#6b8a90;text-align:center"><em>Inga rader ännu — klicka <strong>+ Lägg till rad</strong> eller använd en snabbknapp.</em></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Kategori-minne -->
    <datalist id="categoryMemory"></datalist>

    <!-- Sumboxar -->
    <div class="sum-grid">
      <div class="card c-salary">
        <div class="small">Månadslön</div>
        <div id="salaryDisplay" class="big">0 kr</div>
      </div>
      <div class="card c-left">
        <div class="small">Kvar av lönen (utan övriga inkomster)</div>
        <div id="salaryLeft" class="big">0 kr</div>
      </div>
      <div class="card c-income">
        <div class="small">Totala inkomster (övriga)</div>
        <div id="totalIncome" class="big good">0 kr</div>
      </div>
      <div class="card c-expense">
        <div class="small">Totala utgifter</div>
        <div id="totalExpense" class="big bad">0 kr</div>
      </div>
      <div class="card c-balance">
        <div class="small">Saldo (inkl. lön + övriga inkomster)</div>
        <div id="balance" class="big">0 kr</div>
      </div>
      <div class="card c-buffer">
        <div class="small">Buffert (möjlig att spara)</div>
        <div id="buffer" class="big">0 kr</div>
      </div>
    </div>
  </div>

  <!-- Lås -->
  <div class="lock" id="lock">
    <div class="lock-card">
      <h3 style="margin:0 0 6px">Skyddad budget</h3>
      <div class="small" style="margin-bottom:10px">Skriv PIN för att öppna (session: 60 min)</div>
      <div class="pinbox">
        <input id="pin1" inputmode="numeric" maxlength="1" />
        <input id="pin2" inputmode="numeric" maxlength="1" />
        <input id="pin3" inputmode="numeric" maxlength="1" />
        <input id="pin4" inputmode="numeric" maxlength="1" />
      </div>
      <div class="kbd">
        <button data-k="1">1</button><button data-k="2">2</button><button data-k="3">3</button>
        <button data-k="4">4</button><button data-k="5">5</button><button data-k="6">6</button>
        <button data-k="7">7</button><button data-k="8">8</button><button data-k="9">9</button>
        <button id="pinClear">C</button><button data-k="0">0</button><button id="pinOk">OK</button>
      </div>
      <div class="hint">Du blir automatiskt utloggad efter inaktivitet.</div>
    </div>
  </div>

  <!-- Modal: skapa snabbknapp -->
  <div class="modal" id="chipModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="chipTitle">
      <h3 id="chipTitle">Ny snabbknapp</h3>
      <div class="grid">
        <div class="full">
          <label>Kategori (t.ex. “Hyra” eller “Eon”)</label>
          <input id="mLabel" type="text" placeholder="Kategori" />
        </div>
        <div>
          <label>Belopp (kr)</label>
          <input id="mAmount" type="number" inputmode="decimal" placeholder="0" />
        </div>
        <div>
          <label>Typ</label>
          <select id="mType">
            <option>Utgift</option>
            <option>Inkomst</option>
          </select>
        </div>
        <div>
          <label>Betalsätt</label>
          <select id="mPay">
            <option value="">-</option>
            <option>Autogiro</option>
            <option>E-faktura</option>
            <option>Pappersfaktura</option>
            <option>Annat</option>
          </select>
        </div>
        <div class="full">
          <div class="row">
            <label style="margin:0">Anteckningar</label>
            <label style="margin-left:auto"><input id="mMirror" type="checkbox" /> Använd betalsätt som anteckning</label>
          </div>
          <textarea id="mNote" placeholder="Valfritt: t.ex. kundnummer, månad, etc."></textarea>
        </div>
      </div>
      <div class="actions">
        <button id="mCancel">Avbryt</button>
        <button class="primary" id="mSave">Spara snabbknapp</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    /* ====== KONFIG ====== */
    const CLOUD = {
      endpoint: 'https://script.google.com/macros/s/AKfycbyb9-JeFY_aefmYHzSUnUmuMZhy_HkrXGjpYMTrX36BrtP2mhbETHTRFH6iVW8CFdB4/exec',
      secret: ''
    };

    /* ====== HJÄLPARE ====== */
    function getKey(){
      const u = new URL(location.href);
      let k = (u.searchParams.get('key')||'').trim();
      if(!k){
        k = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2,10));
        u.searchParams.set('key', k);
        history.replaceState(null,'',u);
      }
      return k;
    }
    function cloudEnabled(){ return !!CLOUD.endpoint && !!getKey(); }
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),wait); }; }
    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    const fmt = new Intl.NumberFormat('sv-SE',{style:'currency',currency:'SEK',maximumFractionDigits:0});

    /* ====== UI REFS ====== */
    const tbody = document.getElementById('tbody');
    const addRowBtn = document.getElementById('addRowBtn');
    const shareBtn = document.getElementById('shareBtn');
    const copyBtn = document.getElementById('copyBtn');
    const shareImageBtn = document.getElementById('shareImageBtn');
    const resetBtn = document.getElementById('resetBtn');
    const lockBtn = document.getElementById('lockBtn');

    const chipsWrap = document.getElementById('chips');
    const addChipBtn = document.getElementById('addChipBtn');

    const totalIncomeEl   = document.getElementById('totalIncome');
    const totalExpenseEl  = document.getElementById('totalExpense');
    const balanceEl       = document.getElementById('balance');
    const salaryInput     = document.getElementById('salaryInput');
    const salaryLeftEl    = document.getElementById('salaryLeft');
    const salaryDisplayEl = document.getElementById('salaryDisplay');
    const bufferEl        = document.getElementById('buffer');

    const liveLinkInput = document.getElementById('liveLink');
    const copyLiveLinkBtn = document.getElementById('copyLiveLinkBtn');
    const cloudInfo = document.getElementById('cloudInfo');

    const clearMemBtn = document.getElementById('clearMemBtn');
    const categoryMemoryList = document.getElementById('categoryMemory');

    /* Modal */
    const chipModal = document.getElementById('chipModal');
    const mLabel = document.getElementById('mLabel');
    const mAmount = document.getElementById('mAmount');
    const mType = document.getElementById('mType');
    const mPay = document.getElementById('mPay');
    const mNote = document.getElementById('mNote');
    const mMirror = document.getElementById('mMirror');
    const mCancel = document.getElementById('mCancel');
    const mSave = document.getElementById('mSave');

    /* ====== DATA ====== */
    let rows = [];
    let salary = 0;

    /* ====== LÅS ====== */
    const LOCK = { pin:'8987', timeoutMs: 60*60*1000 };
    const lockEl = document.getElementById('lock');
    const pinInputs = [ 'pin1','pin2','pin3','pin4' ].map(id=>document.getElementById(id));
    const pinOk = document.getElementById('pinOk');
    const pinClear = document.getElementById('pinClear');
    const lockTsKey = ()=>'budget_lock_ts_' + getKey();
    function now(){ return Date.now(); }
    function setUnlockTs(){ localStorage.setItem(lockTsKey(), String(now())); }
    function getUnlockTs(){ const v=localStorage.getItem(lockTsKey()); return v?Number(v):0; }
    function needLock(){ const ts = getUnlockTs(); return !ts || (now()-ts) > LOCK.timeoutMs; }
    function openLock(){ lockEl.classList.add('open'); pinInputs[0].focus(); }
    function closeLock(){ lockEl.classList.remove('open'); setUnlockTs(); }
    function tryUnlock(){
      const val = pinInputs.map(i=>i.value).join('');
      if(val === LOCK.pin){ closeLock(); pinInputs.forEach(i=>i.value=''); }
      else { pinInputs.forEach(i=>i.value=''); pinInputs[0].focus(); alert('Fel PIN'); }
    }
    pinOk.onclick = tryUnlock;
    pinClear.onclick = ()=>{ pinInputs.forEach(i=>i.value=''); pinInputs[0].focus(); };
    lockBtn.onclick = openLock;
    lockEl.querySelectorAll('[data-k]').forEach(b=> b.addEventListener('click', (e)=>{
      const k = e.currentTarget.getAttribute('data-k');
      for(const inp of pinInputs){ if(inp.value===''){ inp.value=k; break; } }
    }));
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden') setUnlockTs();
    });
    if(needLock()) openLock();

    /* ====== DELNING ====== */
    function updateShareLink(){ liveLinkInput.value = location.href; }
    copyLiveLinkBtn.onclick = ()=>{
      const t = liveLinkInput.value;
      (navigator.clipboard ? navigator.clipboard.writeText(t) : Promise.reject())
        .then(()=>alert('Länk kopierad.'))
        .catch(()=>prompt('Kopiera manuellt:', t));
    };
    shareBtn.onclick = ()=> copyLiveLinkBtn.click();
    copyBtn.onclick = ()=> copyLiveLinkBtn.click();
    updateShareLink();

    /* ====== KATEGORI-MINNE ====== */
    const MEM_KEY = 'budget_cat_memory_v1';
    function loadCategoryMemory(){
      let arr = []; try{ arr = JSON.parse(localStorage.getItem(MEM_KEY)||'[]'); }catch(_){}
      if(!Array.isArray(arr)) arr = [];
      categoryMemoryList.innerHTML = arr.map(v=>`<option value="${escapeHtml(v)}"></option>`).join('');
      return arr;
    }
    function saveCategoryToMemory(s){
      const label = String(s||'').trim();
      if(!label) return;
      const arr = loadCategoryMemory();
      if(!arr.includes(label)){
        arr.push(label);
        localStorage.setItem(MEM_KEY, JSON.stringify(arr));
        loadCategoryMemory();
      }
    }
    function clearCategoryMemory(){ localStorage.removeItem(MEM_KEY); loadCategoryMemory(); }
    clearMemBtn.onclick = ()=>{ if(confirm('Rensa endast kategori-minnet? (påverkar inte dina rader)')) clearCategoryMemory(); };

    /* ====== SNABBKNAPPAR ====== */
    function openChipModal(){
      mLabel.value = ''; mAmount.value=''; mType.value='Utgift'; mPay.value=''; mNote.value='';
      mMirror.checked = false;
      chipModal.classList.add('open');
      mLabel.focus();
    }
    function closeChipModal(){ chipModal.classList.remove('open'); }
    addChipBtn.addEventListener('click', openChipModal);
    mCancel.addEventListener('click', closeChipModal);
    chipModal.addEventListener('click', (e)=>{ if(e.target===chipModal) closeChipModal(); });
    mMirror.addEventListener('change', ()=>{
      if(mMirror.checked) mNote.value = mPay.value || '';
    });
    mPay.addEventListener('change', ()=>{
      if(mMirror.checked) mNote.value = mPay.value || '';
    });
    mSave.addEventListener('click', ()=>{
      const label = mLabel.value.trim();
      if(!label){ alert('Skriv en kategori.'); mLabel.focus(); return; }
      const obj = {
        label,
        amount: Number(mAmount.value)||0,
        type: mType.value==='Inkomst' ? 'Inkomst' : 'Utgift',
        pay: mPay.value || '',
        note: (mMirror.checked ? (mPay.value||'') : mNote.value.trim())
      };
      const list = JSON.parse(localStorage.getItem('budget_quick_items')||'[]');
      list.push(obj);
      localStorage.setItem('budget_quick_items', JSON.stringify(list));
      saveCategoryToMemory(label);
      loadChips();
      closeChipModal();
    });

    function loadChips(){
      const list = JSON.parse(localStorage.getItem('budget_quick_items')||'[]');
      chipsWrap.querySelectorAll('.chip').forEach(e=>e.remove());
      list.forEach((c,idx)=>{
        const el = document.createElement('div');
        el.className = 'chip';
        const tags = [c.type||'Utgift', c.pay||'−'].filter(Boolean).join(' · ');
        el.innerHTML = `<span>${escapeHtml(c.label)} <small style="opacity:.7">(${escapeHtml(tags)})</small></span><span class="x" title="Ta bort" data-i="${idx}">×</span>`;
        el.addEventListener('click',(ev)=>{
          if(ev.target.classList.contains('x')) return;
          rows.push({ category:c.label||'', amount:Number(c.amount||0), type:(c.type||'Utgift'), pay:(c.pay||''), note:(c.note||'') });
          render(); updateTotals(); saveLocal(); cloudSaveDebounced();
        });
        el.querySelector('.x').addEventListener('click',(ev)=>{
          ev.stopPropagation();
          const arr = JSON.parse(localStorage.getItem('budget_quick_items')||'[]');
          arr.splice(idx,1); localStorage.setItem('budget_quick_items', JSON.stringify(arr));
          loadChips();
        });
        chipsWrap.insertBefore(el, addChipBtn);
      });
    }

    /* ====== MOLN (AUTOSAVE) ====== */
    let isLoadingFromCloud = false;
    function payload(){ return { rows, salary: Number(salary)||0, updatedAt: Date.now() }; }
    async function cloudSave(){
      if(!cloudEnabled() || isLoadingFromCloud) return;
      try{
        const form = new URLSearchParams();
        form.set('op','save'); form.set('key', getKey()); form.set('secret', CLOUD.secret||'');
        form.set('data', JSON.stringify(payload()));
        const res = await fetch(CLOUD.endpoint, { method:'POST', body: form });
        await res.text();
        cloudInfo.textContent = 'Autosparat ✔︎';
      }catch(err){ cloudInfo.textContent = 'Kunde inte autospara'; }
    }
    const cloudSaveDebounced = debounce(cloudSave, 1000);

    async function cloudLoad(){
      if(!cloudEnabled()) return;
      isLoadingFromCloud = true;
      try{
        const form = new URLSearchParams();
        form.set('op','load'); form.set('key', getKey()); form.set('secret', CLOUD.secret||'');
        const res = await fetch(CLOUD.endpoint, { method:'POST', body: form });
        const text = await res.text();
        let json; try{ json = JSON.parse(text); }catch(_){}
        const data = json && (json.data || json);
        if(data && Array.isArray(data.rows)){
          rows = data.rows.map(r=>({
            category:r.category||'',
            amount:Number(r.amount)||0,
            type:r.type==='Inkomst'?'Inkomst':'Utgift',
            pay:(typeof r.pay==='string')?r.pay:'',
            note:r.note||''
          }));
          salary = Number(data.salary)||0;
          salaryInput.value = salary || '';
        }
      }catch(err){ console.warn('Moln load fel:', err); }
      finally{ render(); updateTotals(); isLoadingFromCloud = false; }
    }

    /* ====== LOCAL SAVE ====== */
    function saveLocal(){
      localStorage.setItem('budget_rows_v1', JSON.stringify(rows));
      localStorage.setItem('budget_salary_v1', String(Number(salary)||0));
    }
    function loadLocal(){
      try{ const r = JSON.parse(localStorage.getItem('budget_rows_v1')||'[]'); if(Array.isArray(r)) rows = r; }catch(_) {}
      salary = Number(localStorage.getItem('budget_salary_v1')||0) || 0;
      salaryInput.value = salary || '';
    }

    /* ====== INIT ====== */
    function init(){
      loadCategoryMemory();
      loadChips();
      loadLocal();
      cloudLoad();
      render(); updateTotals();

      salaryInput.addEventListener('input', ()=>{
        salary = Number(salaryInput.value)||0;
        saveLocal(); cloudSaveDebounced(); updateTotals();
      });

      document.addEventListener('visibilitychange', ()=>{
        if(document.visibilityState==='hidden'){ saveLocal(); cloudSave(); setUnlockTs(); }
      });
    }

    /* ====== RENDER ====== */
    function autoGrow(el){
      el.style.height = 'auto';
      const h = Math.min(160, Math.max(48, el.scrollHeight+2));
      el.style.height = h + 'px';
    }

    function render(){
      tbody.innerHTML = '';
      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" style="padding:18px;color:#6b8a90;text-align:center"><em>Inga rader ännu — klicka <strong>+ Lägg till rad</strong> eller använd en snabbknapp.</em></td>`;
        tbody.appendChild(tr);
        return;
      }
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" data-i="${i}" data-col="category" value="${escapeHtml(r.category)}" placeholder="Kategori" list="categoryMemory"></td>
          <td class="right"><input type="number" data-i="${i}" data-col="amount" value="${Number(r.amount)||0}" step="1" inputmode="decimal" placeholder="0"></td>
          <td>
            <select data-i="${i}" data-col="type">
              <option ${r.type==='Utgift'?'selected':''}>Utgift</option>
              <option ${r.type==='Inkomst'?'selected':''}>Inkomst</option>
            </select>
          </td>
          <td>
            <select data-i="${i}" data-col="pay">
              <option value="" ${(!r.pay||r.pay==='')?'selected':''}>-</option>
              <option value="Autogiro" ${r.pay==='Autogiro'?'selected':''}>Autogiro</option>
              <option value="E-faktura" ${r.pay==='E-faktura'?'selected':''}>E-faktura</option>
              <option value="Pappersfaktura" ${r.pay==='Pappersfaktura'?'selected':''}>Pappersfaktura</option>
              <option value="Annat" ${r.pay==='Annat'?'selected':''}>Annat</option>
            </select>
          </td>
          <td class="col-note">
            <textarea class="note-input" data-i="${i}" data-col="note" placeholder="Anteckningar (valfritt) – större fält">${escapeHtml(r.note||'')}</textarea>
          </td>
          <td class="row-actions">
            <button data-action="up" data-i="${i}" title="Flytta upp">↑</button>
            <button data-action="down" data-i="${i}" title="Flytta ner">↓</button>
            <button data-action="neg" data-i="${i}" title="Växla +/−">±</button>
            <button data-action="del" data-i="${i}" title="Ta bort" class="danger">Ta bort</button>
          </td>`;
        tbody.appendChild(tr);
      });
      attachEvents();
      // auto-gro alla textarea
      tbody.querySelectorAll('textarea.note-input').forEach(t=>autoGrow(t));
    }

    function attachEvents(){
      tbody.querySelectorAll('input[data-col], select[data-col], textarea[data-col]').forEach(el=>{
        const handler = ()=>{
          const i = +el.dataset.i, col = el.dataset.col;
          if(!rows[i]) return;
          if(col==='amount') rows[i][col] = Number(el.value)||0;
          else rows[i][col] = el.value;
          if(col==='category') saveCategoryToMemory(el.value);
          saveLocal(); cloudSaveDebounced(); updateTotals();
          if(el.tagName==='TEXTAREA') autoGrow(el);
        };
        el.addEventListener('input', handler);
        el.addEventListener('change', handler);
        if(el.dataset.col==='amount'){
          el.onfocus = ()=>{ if(el.value==='0'||el.value==='') el.value=''; };
          el.onblur = ()=>{ if(el.value===''||isNaN(Number(el.value))){ el.value='0'; handler(); } };
        }
      });

      tbody.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.dataset.i, act = btn.dataset.action;
          if(act==='del'){ rows.splice(i,1); render(); }
          else if(act==='neg'){ rows[i].amount = -rows[i].amount; render(); }
          else if(act==='up'){ if(i>0) moveRow(i,i-1); }
          else if(act==='down'){ if(i<rows.length-1) moveRow(i,i+1); }
          saveLocal(); cloudSaveDebounced(); updateTotals();
        };
      });
    }

    function moveRow(from,to){
      if(from<0||to<0||from>=rows.length||to>=rows.length) return;
      const item = rows.splice(from,1)[0]; rows.splice(to,0,item); render();
    }

    /* Lägg till rad-knapp */
    addRowBtn.onclick = ()=>{
      rows.push({category:'', amount:0, type:'Utgift', pay:'', note:''});
      render(); updateTotals(); saveLocal(); cloudSaveDebounced();
      const lastInput = document.querySelector('#tbody tr:last-child td:first-child input');
      if(lastInput) lastInput.focus();
    };

    /* Totals */
    function updateTotals(){
      let sumIncome = 0, sumExpense = 0;
      rows.forEach(r=>{
        const amt = Number(r.amount)||0;
        if(r.type==='Inkomst') sumIncome += amt; else sumExpense += amt;
      });
      totalIncomeEl.textContent  = fmt.format(Math.round(sumIncome));
      totalExpenseEl.textContent = fmt.format(Math.round(sumExpense));
      const s = Number(salary)||0;
      salaryDisplayEl.textContent = fmt.format(Math.round(s));
      const salaryLeft = Math.round(s - sumExpense);
      salaryLeftEl.textContent = fmt.format(salaryLeft);
      const balance = Math.round(s + sumIncome - sumExpense);
      balanceEl.textContent = fmt.format(balance);
      bufferEl.textContent = fmt.format(balance);

      salaryLeftEl.classList.toggle('bad', salaryLeft<0);
      salaryLeftEl.classList.toggle('good', salaryLeft>=0);
      balanceEl.classList.toggle('bad', balance<0);
      balanceEl.classList.toggle('good', balance>=0);
      bufferEl.classList.toggle('bad', balance<0);
      bufferEl.classList.toggle('good', balance>=0);
    }

    /* Dela som bild */
    async function ensureHtml2Canvas(){
      if(window.html2canvas) return;
      await new Promise((res, rej)=>{
        const s = document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('Kunde inte ladda html2canvas'));
        document.head.appendChild(s);
      });
    }
    function buildImageSourceElement(){
      const tmp=document.createElement('div');
      tmp.style.position='fixed'; tmp.style.left='-99999px'; tmp.style.top='0';
      tmp.style.padding='12px'; tmp.style.background='#ffffff';
      tmp.style.width=(document.querySelector('.table-wrap')?.offsetWidth||800)+'px';
      const title=document.createElement('div');
      title.style.font='600 18px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial';
      title.style.margin='0 0 8px'; title.textContent='Budgetöversikt';
      tmp.appendChild(title);
      const tableClone=document.querySelector('.table-wrap')?.cloneNode(true);
      const sumClone=document.querySelector('.sum-grid')?.cloneNode(true);
      if(tableClone) tmp.appendChild(tableClone);
      if(sumClone){ sumClone.style.marginTop='8px'; tmp.appendChild(sumClone); }
      document.body.appendChild(tmp); return tmp;
    }
    function dataURLFromCanvas(c){ try{ return c.toDataURL('image/png'); }catch(_){ return null; } }
    shareImageBtn.onclick = async ()=>{
      try{
        await ensureHtml2Canvas();
        const src=buildImageSourceElement();
        const canvas=await html2canvas(src,{backgroundColor:'#ffffff',scale:window.devicePixelRatio>1?2:1,useCORS:true});
        document.body.removeChild(src);
        const url=dataURLFromCanvas(canvas);
        if(!url) throw new Error('PNG misslyckades');
        const a=document.createElement('a'); a.download='budget.png'; a.href=url; document.body.appendChild(a); a.click(); a.remove();
      }catch(e){ alert('Kunde inte skapa bild: ' + e.message); }
    };

    /* Nollställ (påverkar ej snabbknappar/minne) */
    resetBtn.onclick = ()=>{
      if(!confirm('Nollställa rader + lön? (Kategori-minne och snabbknappar påverkas inte)')) return;
      rows=[]; salary=0; salaryInput.value='';
      saveLocal(); render(); updateTotals(); cloudSave();
    };

    /* GO */
    loadChips();
    init();
  })();
  </script>
</body>
</html>
