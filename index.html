<!-- ======= BUDGET-APP (FAST LÄNK MED key=, INGEN ID) ======= -->
<div id="budgetApp">
 <style>
  /* ===== GRUND-CSS ===== */
  #budgetApp{
    --bg:#e9f6f8;
    --accent:#0b3b4c;
    --muted:#a0b7bb;
    --good:#1b8f4a;
    --bad:#d23b3b;
    --card:#ffffff;

    font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
    color:#042b33;
  }

  /* Dölj innehåll när låst */
  #budgetApp.locked .wrap{ display:none; }

  #budgetApp .wrap{max-width:1100px;margin:0 auto;padding:16px;}
  #budgetApp .controls{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;}
  #budgetApp button{background:var(--card); border:1px solid #cfe3e6; padding:8px 10px; border-radius:8px; cursor:pointer;}
  #budgetApp button.primary{background:#0d6c77;color:white;border:0}
  #budgetApp .danger{background:#ffd7d7;border:1px solid #f1bcbc}
  #budgetApp .table-wrap{overflow:auto;background:var(--card); padding:8px; border-radius:10px; border:1px solid #d6e9eb;}
  #budgetApp table{width:100%; border-collapse:collapse; min-width:860px;}
  #budgetApp th, #budgetApp td{padding:10px 8px; border:1px solid #cfe6e9; text-align:left; vertical-align:middle;}
  #budgetApp th{background:#07232b;color:white; font-weight:700;}
  #budgetApp td input[type="text"], 
  #budgetApp td input[type="number"], 
  #budgetApp td select {width:100%; border:0; background:transparent; padding:6px; font-size:14px;}
  #budgetApp .right{text-align:right;}
  #budgetApp .sum-box{display:flex; flex-direction:column; gap:10px; align-items:flex-start; margin-top:12px;}
  #budgetApp .card{background:linear-gradient(180deg,#ffffff, #f7ffff); border-radius:10px; padding:10px; border:1px solid #d6e9eb; min-width:220px}
  #budgetApp .big{font-size:18px;font-weight:700;}
  #budgetApp .good{color:var(--good);} 
  #budgetApp .bad{color:var(--bad);} 
  #budgetApp .small{font-size:13px;color:#2b4c52;}
  #budgetApp .row-actions{display:flex; gap:6px;}
  #budgetApp .hint{font-size:13px;color:#2b4c52;margin-top:8px}
  #budgetApp .salary-box{display:flex; gap:12px; align-items:center; margin:8px 0 14px}
  #budgetApp .salary-box input{font-size:16px; padding:8px 10px; border:1px solid #cfe3e6; border-radius:8px; width:220px}
  #budgetApp .drag-handle{cursor:grab; user-select:none; padding:0 6px; display:inline-flex; align-items:center; justify-content:center}
  #budgetApp tr.dragging{opacity:0.6}
  #budgetApp tr.drag-over{outline:2px dashed #0d6c77}
  #budgetApp .empty-row{color:#6b8a90; font-style:italic; text-align:center;}
  #budgetApp .empty-cell{padding:18px;}
  #budgetApp .card.salary   { background:#e6f1ff; border-color:#c6ddff; }
  #budgetApp .card.income   { background:#e6ffe6; border-color:#c2e9c2; }
  #budgetApp .card.expense  { background:#ffe6e6; border-color:#f1bcbc; }
  #budgetApp .card.salaryLeft { background:#fff9e6; border-color:#f6e9b5; }
  #budgetApp .card.balance,
  #budgetApp .card.buffer   { background:#e6f7ff; border-color:#bde0f6; }
  #budgetApp details.helpbox { background:#fff; border:1px solid #d6e9eb; border-radius:10px; padding:10px; margin-top:10px; }
  #budgetApp details.helpbox[open]{ background:#f7fbff; }
  #budgetApp details.helpbox summary{ list-style:none; cursor:pointer; font-weight:700; display:flex; align-items:center; justify-content:space-between; }
  #budgetApp details.helpbox summary::-webkit-details-marker{ display:none; }
  #budgetApp .helpbox-content{ color:#2b4c52; font-size:14px; }
  #budgetApp .live-link{display:flex; gap:8px; align-items:center; margin:8px 0 0; flex-wrap:wrap}
  #budgetApp .live-link input[type=text]{flex:1; min-width:260px; padding:8px 10px; border:1px solid #cfe3e6; border-radius:8px; background:#fff}
  #budgetApp .live-note{font-size:12px; color:#6b8a90}
  #cloudControls{display:flex; gap:8px; flex-wrap:wrap; margin:8px 0;}
  #cloudControls input[type=text]{min-width:170px; padding:8px 10px; border:1px solid #cfe3e6; border-radius:8px; background:#fff}
  #cloudInfo{font-size:12px; color:#6b8a90}

  /* ===== PREMIUM LOCK OVERLAY ===== */
  #budgetApp .lock-overlay{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 800px at 20% 10%, rgba(13,108,119,.18), transparent 60%),
      radial-gradient(1000px 900px at 80% 90%, rgba(9,59,76,.20), transparent 65%),
      rgba(10,25,30,.82);
    display:flex; align-items:center; justify-content:center; z-index:99999;
    backdrop-filter: blur(6px);
    padding:32px;
  }
  #budgetApp .lock-card{
    background:rgba(255,255,255,.9);
    border:1px solid rgba(214,233,235,.85);
    border-radius:22px; 
    padding:28px; width:100%; max-width:560px;
    box-shadow:0 18px 60px rgba(0,0,0,.28);
    text-align:center;                /* ← ser till att h3/p centreras */
    backdrop-filter: blur(8px);
  }

  /* Brand-rad: Budgetmall + lås */
  .brand{
    display:flex; align-items:center; justify-content:center; gap:10px;
    margin:2px auto 14px;
  }
  .brand .brand-lock{ width:28px; height:28px; opacity:.9; }
  .brand .brand-text{
    font-weight:800; font-size:20px; letter-spacing:.3px;
    background:linear-gradient(135deg,#0b3b4c,#0d6c77);
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  #budgetApp .lock-card h3{margin:0 0 8px; font-size:24px; color:#0b3b4c; letter-spacing:.2px;}
  #budgetApp .lock-card p{margin:0 0 18px; font-size:15px; color:#2b4c52;}

  .pin-row{display:flex; gap:12px; margin:0 auto 16px; justify-content:center; max-width:360px;}
  .pin-input-wrap{position:relative; flex:1;}
  .pin-input{
    width:100%;
    padding:16px 54px 16px 16px;
    border:2px solid #cfe3e6; border-radius:14px; 
    font-size:24px; letter-spacing:3px; text-align:center;
    outline:none; background:#ffffff;
    transition:border-color .2s, box-shadow .2s, transform .1s;
  }
  .pin-input:focus{ border-color:#0d6c77; box-shadow:0 0 0 6px rgba(13,108,119,.12); }

  .eye-btn{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    border:0; background:transparent; cursor:pointer; padding:6px 8px; border-radius:8px;
    color:#0b3b4c; opacity:.8;
  }
  .eye-btn:hover{ opacity:1; }

  .lock-actions{display:flex; gap:10px; justify-content:center; margin-top:4px;}
  .lock-actions .primary{padding:12px 18px; font-size:16px; border-radius:10px;}
  .lock-error{color:#d23b3b; font-size:14px; min-height:20px; margin-top:10px;}

  /* Shake vid fel PIN */
  @keyframes shake {
    10%, 90% { transform: translateX(-2px); }
    20%, 80% { transform: translateX(4px); }
    30%, 50%, 70% { transform: translateX(-6px); }
    40%, 60% { transform: translateX(6px); }
  }
  .pin-error .pin-input { animation: shake .35s both; border-color:#d23b3b; }

  /* Dark mode (premium lock) */
  #budgetApp.dark .lock-card{
    background:rgba(26,41,51,.88);
    border-color:#244248; color:#f2f7f8;
  }
  #budgetApp.dark .pin-input{ background:#1f3338; color:#f2f7f8; border-color:#244248; }
  #budgetApp.dark .pin-input:focus{ border-color:#7ec9d3; box-shadow:0 0 0 6px rgba(126,201,211,.15); }
  #budgetApp.dark .eye-btn{ color:#dbe7ea; }
  #budgetApp.dark .brand .brand-text{
    background:linear-gradient(135deg,#e6f7ff,#7ec9d3);
    -webkit-background-clip:text; background-clip:text; color:transparent;
  }

  /* ===== MOBIL ===== */
  @media (max-width: 600px) {
    #budgetApp .wrap { padding: 8px; }
    #budgetApp table { font-size: 13px; min-width: 100%; }
    #budgetApp th, #budgetApp td { padding: 6px; }
    #budgetApp .controls { flex-direction: column; gap: 6px; }
    #budgetApp .controls button { width: 100%; }
    #budgetApp .salary-box { flex-direction: column; align-items: stretch; }
    #budgetApp .salary-box input { width: 100%; }
    #budgetApp .sum-box { flex-direction: column; gap: 8px; width: 100%; }
    #budgetApp .card { min-width: unset; width: 100%; }
    #budgetApp .live-link { flex-direction: column; align-items: stretch; }
    #cloudControls { flex-direction: column; align-items: stretch; }
    .pin-row{ max-width: none; }
    .pin-input{ font-size:22px; }
  }
 </style>

  <div class="wrap" aria-live="polite">
    <div class="controls">
      <button class="primary" id="addRowBtn">+ Lägg till rad</button>
      <button id="shareBtn">Dela länk</button>
      <button id="copyBtn">Kopiera</button>
      <button id="shareImageBtn">Dela bild</button>
      <button id="resetBtn" class="danger" title="Nollställ allt till 0">Nollställ</button>
      <button id="darkModeBtn" title="Växla tema">Mörkt läge</button>
      <button id="lockBtn" title="Lås nu">Lås</button>
    </div>

    <!-- Fast delningslänk -->
    <div class="live-link" id="liveLinkWrap">
      <span class="small">Delningslänk (alltid samma):</span>
      <input id="liveLink" type="text" readonly value="" />
      <button id="copyLiveLinkBtn" title="Kopiera delningslänk">Kopiera länk</button>
      <div class="live-note" id="liveLinkNote">Detta är er permanenta länk. Dela samma länk mellan enheter.</div>
    </div>

    <!-- Moln -->
    <div id="cloudControls">
      <button id="cloudSaveBtn" title="Spara till molnet">Spara (moln)</button>
      <input id="cloudIdInput" type="text" placeholder="Nyckel (t.ex. budgetdb)" />
      <button id="cloudLoadBtn" title="Öppna från molnet">Öppna (nyckel)</button>
      <div id="cloudInfo"></div>
    </div>

    <!-- Månadslön -->
    <div class="card salary-box">
      <div>
        <div class="small">Månadslön (netto)</div>
        <input id="salaryInput" type="number" step="1" min="0" placeholder="t.ex. 36 000" />
      </div>
      <div class="small">Används i saldot: <strong>(lön + övriga inkomster) − utgifter</strong></div>
    </div>

    <!-- Tabell -->
    <div class="table-wrap card">
      <table id="budgetTable" aria-label="Budgettabell">
        <thead>
          <tr>
            <th style="width:34px">↕︎</th>
            <th style="width:260px">Kategori</th>
            <th style="width:140px">Belopp</th>
            <th style="width:120px">Typ</th>
            <th style="width:150px">Betalsätt</th>
            <th>Anteckningar</th>
            <th style="width:140px">Åtgärd</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="empty-cell"><div class="empty-row">Inga rader ännu — klicka <strong>+ Lägg till rad</strong> för att börja.</div></td></tr>
        </tbody>
      </table>
    </div>

    <!-- Förslag till Anteckningar -->
    <datalist id="noteCategories">
      <option value="Livsmedel"></option>
      <option value="Drivmedel"></option>
      <option value="Hyra"></option>
      <option value="Gästgivarevägen"></option>
      <option value="Studievägen"></option>
      <option value="DNB Finans"></option>
      <option value="Abonnemang"></option>
      <option value="Hus"></option>
      <option value="Folksam"></option>
      <option value="Försäkring"></option>
      <option value="Sparande"></option>
      <option value="Sjukhus"></option>
      <option value="Räkningar"></option>
      <option value="Lån"></option>
      <option value="Telia tv sport"></option>
      <option value="Telia"></option>
      <option value="Fritid"></option>
      <option value="Swedbank"></option>
      <option value="Bank"></option>
      <option value="Klarna"></option>
      <option value="Övrigt"></option>
    </datalist>

    <!-- Summor -->
    <div class="sum-box">
      <div class="card salary">
        <div class="small">Månadslön</div>
        <div id="salaryDisplay" class="big">0 kr</div>
      </div>

      <div class="card salaryLeft">
        <div class="small">Kvar av lönen (utan övriga inkomster)</div>
        <div id="salaryLeft" class="big">0 kr</div>
      </div>

      <div class="card income">
        <div class="small">Totala inkomster (övriga)</div>
        <div id="totalIncome" class="big good">0 kr</div>
      </div>

      <div class="card expense">
        <div class="small">Totala utgifter</div>
        <div id="totalExpense" class="big bad">0 kr</div>
      </div>

      <div class="card balance">
        <div class="small">Saldo (inkl. lön + övriga inkomster)</div>
        <div id="balance" class="big">0 kr</div>
      </div>

      <div class="card buffer">
        <div class="small">Buffert (möjlig att spara)</div>
        <div id="buffer" class="big">0 kr</div>
      </div>
    </div>

    <!-- Hjälp & förklaringar -->
    <details class="helpbox">
      <summary>
        Hjälp & förklaringar
        <span class="chev">▾</span>
      </summary>
      <div class="helpbox-content">
        <p><strong>Så använder ni:</strong> Börja med att fylla i er månadslön, lägg sedan till rader för inkomster och utgifter. Ni kan flytta rader med ≡ eller ↑/↓.</p>
        <ul>
          <li><strong>Månadslön:</strong> Den totala lönen ni får in under månaden.</li>
          <li><strong>Kvar av lönen (utan övriga inkomster):</strong> Hur mycket av lönen som återstår när utgifterna dragits.</li>
          <li><strong>Totala inkomster (övriga):</strong> Alla inkomster utöver lönen, t.ex. barnbidrag eller extrajobb.</li>
          <li><strong>Totala utgifter:</strong> Summan av alla kostnader ni lagt in.</li>
          <li><strong>Saldo:</strong> Lön + övriga inkomster − utgifter.</li>
          <li><strong>Buffert:</strong> Hur mycket ni kan spara.</li>
        </ul>
      </div>
    </details>

    <div class="hint">
      Tips: Börja med lönen, lägg sen till rader. Flytta rader med ≡ eller ↑/↓.
    </div>
  </div>

  <script>
  (function(){
    const root = document.getElementById('budgetApp');

    /* ===== LÅS-KONFIG ===== */
    const LOCK = {
      enabled: true,
      pin: '8987',                 // PIN på klientsidan
      timeoutMs: 60 * 60 * 1000    // 60 minuter
    };

    // ===== KONFIG: Apps Script =====
    const CLOUD = {
      endpoint: 'https://script.google.com/macros/s/AKfycbxG3zENX_dIBGbn1zzNWJo9UnZikx-TofN7VjqaYmkQv0ghaPXJ_xB5jhd_3WQOsQ_R/exec',
      secret: ''
    };

    // UI refs
    const tbody           = root.querySelector('#tbody');
    const addRowBtn       = root.querySelector('#addRowBtn');
    const shareBtn        = root.querySelector('#shareBtn');
    const copyBtn         = root.querySelector('#copyBtn');
    const shareImageBtn   = root.querySelector('#shareImageBtn');
    const resetBtn        = root.querySelector('#resetBtn');
    const darkModeBtn     = root.querySelector('#darkModeBtn');
    const lockBtn         = root.querySelector('#lockBtn');

    const liveLinkInput   = root.querySelector('#liveLink');
    const copyLiveLinkBtn = root.querySelector('#copyLiveLinkBtn');
    const liveLinkNote    = root.querySelector('#liveLinkNote');

    // Moln
    const cloudSaveBtn  = root.querySelector('#cloudSaveBtn');
    const cloudLoadBtn  = root.querySelector('#cloudLoadBtn');
    const cloudIdInput  = root.querySelector('#cloudIdInput');
    const cloudInfo     = root.querySelector('#cloudInfo');

    // Summor
    const totalIncomeEl   = root.querySelector('#totalIncome');
    const totalExpenseEl  = root.querySelector('#totalExpense');
    const balanceEl       = root.querySelector('#balance');
    const salaryInput     = root.querySelector('#salaryInput');
    const salaryLeftEl    = root.querySelector('#salaryLeft');
    const salaryDisplayEl = root.querySelector('#salaryDisplay');
    const bufferEl        = root.querySelector('#buffer');

    const STORAGE_KEY = 'budget_app_v1';
    const STORAGE_SALARY_KEY = 'budget_app_salary_v1';

    const fmt = new Intl.NumberFormat('sv-SE', { style: 'currency', currency: 'SEK', maximumFractionDigits: 0 });

    let rows = [];
    let salary = 0;

    // ---- KEY-länk ----
    function getKey(){
      try{
        const p = new URLSearchParams(location.search);
        const k = (p.get('key')||'').trim().toLowerCase();
        return k || 'budgetdb';
      }catch(_){ return 'budgetdb'; }
    }
    function shareLinkForKey(){
      const base = location.origin + location.pathname;
      return `${base}?key=${encodeURIComponent(getKey())}`;
    }
    function updateShareInAddressBar(){
      const link = shareLinkForKey();
      try{ history.replaceState(null, '', link); }catch(_){}
      liveLinkInput.value = link;
      liveLinkNote.textContent = 'Detta är er permanenta länk. Dela samma länk mellan enheter.';
    }

    // -------- LÅS: state & utils --------
    const LOCK_TS_KEY = ()=>`budget_lock_ts_${getKey()}`;
    function now(){ return Date.now(); }
    function setUnlockTs(t){ localStorage.setItem(LOCK_TS_KEY(), String(t)); }
    function getUnlockTs(){ const v = localStorage.getItem(LOCK_TS_KEY()); return v?Number(v):0; }
    function clearUnlockTs(){ localStorage.removeItem(LOCK_TS_KEY()); }

    function needLock(){
      if(!LOCK.enabled) return false;
      const ts = getUnlockTs();
      if(!ts) return true;                       
      return (now() - ts) > LOCK.timeoutMs;      
    }

    function setLockedUI(isLocked){
      root.classList.toggle('locked', !!isLocked);
    }

    let lockOverlayEl = null;
    function showLockOverlay(){
      if(lockOverlayEl) return;
      setLockedUI(true);
      lockOverlayEl = document.createElement('div');
      lockOverlayEl.className = 'lock-overlay';
      lockOverlayEl.innerHTML = `
        <div class="lock-card" role="dialog" aria-modal="true" aria-label="Lås upp">
          <div class="brand">
            <svg class="brand-lock" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 10V7a5 5 0 1 1 10 0v3" stroke="#0b3b4c" stroke-width="1.7" stroke-linecap="round"/>
              <rect x="4" y="10" width="16" height="10" rx="2.7" stroke="#0b3b4c" stroke-width="1.7"/>
              <circle cx="12" cy="15" r="1.6" fill="#0b3b4c"/>
            </svg>
            <div class="brand-text">Budgetmall</div>
          </div>
          <h3>Skyddad budget</h3>
          <p>Skriv din PIN-kod för att låsa upp.</p>
          <div class="pin-row">
            <div class="pin-input-wrap" id="pinWrap">
              <input id="pinInput" class="pin-input" type="password" inputmode="numeric" autocomplete="off" maxlength="10" placeholder="••••" aria-label="PIN-kod">
              <button class="eye-btn" id="togglePin" aria-label="Visa/dölj PIN">👁️</button>
            </div>
          </div>
          <div class="lock-actions">
            <button id="unlockBtn" class="primary">Lås upp</button>
          </div>
          <div id="lockError" class="lock-error" aria-live="polite"></div>
        </div>`;
      /* VIKTIGT: lägg overlayen i root så att #budgetApp-scopad CSS gäller */
      root.appendChild(lockOverlayEl);

      const pinInput  = lockOverlayEl.querySelector('#pinInput');
      const unlockBtn = lockOverlayEl.querySelector('#unlockBtn');
      const lockError = lockOverlayEl.querySelector('#lockError');
      const pinWrap   = lockOverlayEl.querySelector('#pinWrap');
      const togglePin = lockOverlayEl.querySelector('#togglePin');

      function tryUnlock(){
        const val = (pinInput.value||'').trim();
        if(val === LOCK.pin){
          setUnlockTs(now());
          hideLockOverlay();
          afterUnlock();
        }else{
          lockError.textContent = 'Fel PIN. Försök igen.';
          pinWrap.classList.remove('pin-error'); 
          void pinWrap.offsetWidth;              
          pinWrap.classList.add('pin-error');    
          pinInput.focus();
          pinInput.select();
        }
      }
      function toggleVisibility(){
        pinInput.type = (pinInput.type === 'password') ? 'text' : 'password';
        pinInput.focus();
      }

      togglePin.addEventListener('click', toggleVisibility);
      unlockBtn.addEventListener('click', tryUnlock);
      pinInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryUnlock(); });
      setTimeout(()=> pinInput.focus(), 0);
    }
    function hideLockOverlay(){
      if(!lockOverlayEl) return;
      lockOverlayEl.remove();
      lockOverlayEl = null;
      setLockedUI(false);
      markActivity();
    }
    function forceLock(){
      clearUnlockTs();
      showLockOverlay(); 
    }

    // Auto-lock timer
    let idleTimer = null;
    function resetIdleTimer(){
      if(idleTimer) clearTimeout(idleTimer);
      if(!LOCK.enabled) return;
      idleTimer = setTimeout(()=> { forceLock(); }, LOCK.timeoutMs);
    }
    function markActivity(){
      if(root.classList.contains('locked')) return;
      if(!LOCK.enabled) return;
      setUnlockTs(now());
      resetIdleTimer();
    }
    function setupAutoLock(){
      if(!LOCK.enabled) return;
      ['click','keydown','mousemove','wheel','touchstart','scroll'].forEach(evt=>{
        window.addEventListener(evt, markActivity, {passive:true});
      });
      resetIdleTimer();
    }

    // -------- INIT --------
    function init(){
      cloudIdInput.value = getKey();

      // Lön från localStorage
      const rawSalary = localStorage.getItem(STORAGE_SALARY_KEY);
      if(rawSalary) salary = Number(rawSalary) || 0;
      salaryInput.value = salary || '';
      salaryInput.addEventListener('input', ()=>{
        salary = Number(salaryInput.value)||0;
        localStorage.setItem(STORAGE_SALARY_KEY, String(salary));
        updateTotals();
      });

      setupAutoLock();

      // Lås direkt vid laddning om nödvändigt
      if(needLock()){
        showLockOverlay();
      }else{
        afterUnlock();
      }

      // Dark mode
      if(localStorage.getItem('budget_app_dark')==='1'){
        root.classList.add('dark');
        if(darkModeBtn) darkModeBtn.textContent = 'Ljust läge';
      }

      updateShareInAddressBar();
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); }

    // -------- Render --------
    function render(){
      tbody.innerHTML = '';
      if(rows.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="7" class="empty-cell"><div class="empty-row">Inga rader ännu — klicka <strong>+ Lägg till rad</strong> för att börja.</div></td>`;
        tbody.appendChild(tr);
        updateTotals(); save();
        return;
      }
      rows.forEach((r, i)=>{
        const tr = document.createElement('tr');
        tr.dataset.index = i;
        tr.innerHTML = `
          <td><span class="drag-handle" draggable="true" title="Dra för att flytta">≡</span></td>
          <td><input type="text"   data-i="${i}" data-col="category" value="${escapeHtml(r.category)}" placeholder="Kategori"></td>
          <td class="right"><input type="number" data-i="${i}" data-col="amount"   value="${r.amount}" step="1" placeholder="0" inputmode="decimal"></td>
          <td>
            <select data-i="${i}" data-col="type">
              <option ${r.type==='Utgift'?'selected':''}>Utgift</option>
              <option ${r.type==='Inkomst'?'selected':''}>Inkomst</option>
            </select>
          </td>
          <td>
            <select data-i="${i}" data-col="pay">
              <option value="" ${(!r.pay || r.pay==='')?'selected':''}>-</option>
              <option value="Autogiro" ${r.pay==='Autogiro'?'selected':''}>Autogiro</option>
              <option value="E-faktura" ${r.pay==='E-faktura'?'selected':''}>E-faktura</option>
              <option value="Pappersfaktura" ${r.pay==='Pappersfaktura'?'selected':''}>Pappersfaktura</option>
              <option value="Annat" ${r.pay==='Annat'?'selected':''}>Annat</option>
            </select>
          </td>
          <td><input type="text" data-i="${i}" data-col="note" value="${escapeHtml(r.note||'')}" list="noteCategories" placeholder="Anteckning eller välj kategori"></td>
          <td class="row-actions">
            <button data-action="up"   data-i="${i}" title="Flytta upp">↑</button>
            <button data-action="down" data-i="${i}" title="Flytta ner">↓</button>
            <button data-action="neg"  data-i="${i}" title="Växla positiv/negativ">±</button>
            <button data-action="del"  data-i="${i}" title="Ta bort" style="background:#ffdede">Ta bort</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      attachEvents();
      attachDragAndDrop();
      updateTotals();
      save();
    }

    // -------- Händelser --------
    function attachEvents(){
      tbody.querySelectorAll('input, select').forEach(el=>{
        el.onchange = ()=>{
          const i = +el.dataset.i;
          const col = el.dataset.col;
          if(col==='amount') rows[i][col] = Number(el.value) || 0; else rows[i][col] = el.value;
          render();
        };
        // UX: ta bort start-0 när man börjar skriva i belopp
        if(el.dataset.col === 'amount'){
          el.onfocus = ()=>{
            if(el.value === '0' || el.value === '') el.value = '';
          };
          el.onblur = ()=>{
            if(el.value === '' || isNaN(Number(el.value))){ 
              el.value = '0';
              const i = +el.dataset.i;
              rows[i].amount = 0;
              updateTotals(); save();
            }
          };
        }
      });

      tbody.querySelectorAll('button[data-action]').forEach(btn=>{
        btn.onclick = ()=>{
          const i = +btn.dataset.i;
          const act = btn.dataset.action;
          if(act==='del'){ rows.splice(i,1); render(); }
          else if(act==='neg'){ rows[i].amount = -rows[i].amount; render(); }
          else if(act==='up'){ if(i>0) moveRow(i, i-1); }
          else if(act==='down'){ if(i<rows.length-1) moveRow(i, i+1); }
        };
      });

      // Moln
      cloudSaveBtn.onclick = ()=> { cloudIdInput.value = getKey(); cloudSave(); };
      cloudLoadBtn.onclick = ()=>{
        const key = (cloudIdInput.value||'').trim().toLowerCase();
        if(!key) return alert('Skriv in en nyckel, t.ex. budgetdb');
        const base = location.origin + location.pathname;
        try{ history.replaceState(null,'', `${base}?key=${encodeURIComponent(key)}`); }catch(_){}
        cloudLoadFromKey(key);
        updateShareInAddressBar();
      };

      // Delning
      shareBtn.onclick = ()=>{
        const link = shareLinkForKey();
        (navigator.clipboard ? navigator.clipboard.writeText(link) : Promise.reject())
          .then(()=> alert('Fast delningslänk kopierad.'))
          .catch(()=> prompt('Kopiera länk:', link));
      };
      copyBtn.onclick = ()=>{
        const link = shareLinkForKey();
        (navigator.clipboard ? navigator.clipboard.writeText(link) : Promise.reject())
          .then(()=> alert('Länk kopierad.'))
          .catch(()=> prompt('Kopiera manuellt:', link));
      };
      copyLiveLinkBtn.onclick = ()=>{
        const text = liveLinkInput.value;
        (navigator.clipboard ? navigator.clipboard.writeText(text) : Promise.reject())
          .then(()=> alert('Länk kopierad.'))
          .catch(()=> prompt('Kopiera manuellt:', text));
      };
    }

    // Lägg till rad
    addRowBtn.onclick = ()=>{
      rows.push({category:'', amount:0, type:'Utgift', pay:'', note:''});
      render();
      const lastInput = root.querySelector('#tbody tr:last-child td:nth-child(2) input');
      if(lastInput) lastInput.focus();
    };

    // -------- Drag & drop --------
    let draggedIndex = null;
    function attachDragAndDrop(){
      tbody.addEventListener('dragstart', (e)=>{
        if(!e.target.closest('.drag-handle')) return;
        const tr = e.target.closest('tr');
        draggedIndex = +tr.dataset.index;
        tr.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        try{ e.dataTransfer.setData('text/plain', String(draggedIndex)); }catch(_){}
      });
      tbody.addEventListener('dragend', ()=>{
        draggedIndex = null;
        tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('dragging','drag-over'));
      });
      tbody.addEventListener('dragover', (e)=>{
        if(draggedIndex==null) return;
        e.preventDefault();
        const tr = e.target.closest('tr'); if(!tr) return;
        tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('drag-over'));
        tr.classList.add('drag-over');
        try{ e.dataTransfer.dropEffect = 'move'; }catch(_){}
      });
      tbody.addEventListener('drop', (e)=>{
        if(draggedIndex==null) return;
        e.preventDefault();
        const tr = e.target.closest('tr');
        tbody.querySelectorAll('tr').forEach(r=>r.classList.remove('drag-over'));
        if(!tr) return;
        const destIndex = +tr.dataset.index;
        if(destIndex===draggedIndex) return;
        moveRow(draggedIndex, destIndex);
        draggedIndex = null;
      });
    }

    function moveRow(from, to){
      if(from<0||to<0||from>=rows.length||to>=rows.length) return;
      const item = rows.splice(from,1)[0];
      rows.splice(to,0,item);
      render();
    }

    // -------- Summeringar --------
    function updateTotals(){
      let sumIncome = 0, sumExpense = 0;
      rows.forEach(r=>{
        const amt = Number(r.amount)||0;
        if(r.type === 'Inkomst') sumIncome += amt; else sumExpense += amt;
      });
      totalIncomeEl.textContent  = fmt.format(Math.round(sumIncome));
      totalExpenseEl.textContent = fmt.format(Math.round(sumExpense));
      const s = Number(salary)||0;
      salaryDisplayEl.textContent = fmt.format(Math.round(s));
      const salaryLeft = Math.round(s - sumExpense);
      salaryLeftEl.textContent = fmt.format(salaryLeft);
      const balance = Math.round(s + sumIncome - sumExpense);
      balanceEl.textContent = fmt.format(balance);
      bufferEl.textContent = fmt.format(balance);
      balanceEl.classList.toggle('bad', balance < 0);
      balanceEl.classList.toggle('good', balance >= 0);
      salaryLeftEl.classList.toggle('bad', salaryLeft < 0);
      salaryLeftEl.classList.toggle('good', salaryLeft >= 0);
      bufferEl.classList.toggle('bad', balance < 0);
      bufferEl.classList.toggle('good', balance >= 0);

      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      markActivity();
    }

    // -------- Helpers --------
    function escapeHtml(s){
      return (s||'').toString()
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    /* ======= DELA SOM BILD ======= */
    async function ensureHtml2Canvas(){
      if(window.html2canvas) return;
      await new Promise((res, rej)=>{
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        s.onload = res;
        s.onerror = ()=>rej(new Error('Kunde inte ladda html2canvas'));
        document.head.appendChild(s);
      });
    }
    function buildImageSourceElement(){
      const tmp = document.createElement('div');
      tmp.style.position = 'fixed';
      tmp.style.left = '-99999px';
      tmp.style.top = '0';
      tmp.style.padding = '12px';
      tmp.style.background = '#ffffff';
      tmp.style.width = (root.querySelector('.table-wrap')?.offsetWidth || 800) + 'px';
      const title = document.createElement('div');
      title.style.font = '600 18px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial';
      title.style.margin = '0 0 8px';
      title.textContent = 'Budgetöversikt';
      tmp.appendChild(title);
      const tableClone = root.querySelector('.table-wrap')?.cloneNode(true);
      const sumClone   = root.querySelector('.sum-box')?.cloneNode(true);
      if(tableClone) tmp.appendChild(tableClone);
      if(sumClone){ sumClone.style.marginTop = '8px'; tmp.appendChild(sumClone); }
      document.body.appendChild(tmp);
      return tmp;
    }
    function dataURLFromCanvas(canvas){
      try{ return canvas.toDataURL('image/png'); }catch(_){ return null; }
    }
    function triggerDownloadFromUrlOrBlob(name, src){
      try{
        const a = document.createElement('a');
        a.download = name;
        if(typeof src === 'string'){ a.href = src; }
        else { const url = URL.createObjectURL(src); a.href = url; a._revokeUrl = url; }
        document.body.appendChild(a); a.click(); a.remove();
        if(a._revokeUrl) URL.revokeObjectURL(a._revokeUrl);
        return true;
      }catch(_){ return false; }
    }
    function openInNewTab(name, src){
      try{
        const url = (typeof src === 'string') ? src : URL.createObjectURL(src);
        const win = window.open(url, '_blank');
        if(!win){ alert('Popup blockerad. Tillåt popups eller prova igen.'); }
        if(typeof src !== 'string'){ setTimeout(()=> URL.revokeObjectURL(url), 5000); }
        return true;
      }catch(_){ return false; }
    }
    shareImageBtn.onclick = async ()=>{
      try{
        await ensureHtml2Canvas();
        const src = buildImageSourceElement();
        const canvas = await html2canvas(src, { backgroundColor:'#ffffff', scale: window.devicePixelRatio>1?2:1, useCORS:true });
        document.body.removeChild(src);
        const done = async (blobOrDataUrl)=>{
          if(blobOrDataUrl instanceof Blob){
            const file = new File([blobOrDataUrl], 'budget.png', { type:'image/png' });
            if(navigator.canShare && navigator.canShare({ files:[file] })){
              try{ await navigator.share({ files:[file], title:'Budget', text:'Min budgetöversikt' }); return; }catch(_){}
            }
          }
          if(navigator.clipboard && window.ClipboardItem){
            try{
              const item = blobOrDataUrl instanceof Blob
                ? new ClipboardItem({ 'image/png': blobOrDataUrl })
                : new ClipboardItem({ 'image/png': await (await fetch(blobOrDataUrl)).blob() });
              await navigator.clipboard.write([item]);
              alert('Bild kopierad till urklipp.'); return;
            }catch(_){}
          }
          if(blobOrDataUrl instanceof Blob){
            if(triggerDownloadFromUrlOrBlob('budget.png', blobOrDataUrl)) return;
            openInNewTab('budget.png', blobOrDataUrl); return;
          } else {
            if(triggerDownloadFromUrlOrBlob('budget.png', blobOrDataUrl)) return;
            openInNewTab('budget.png', blobOrDataUrl); return;
          }
        };
        if(canvas.toBlob){
          canvas.toBlob(async (blob)=>{ if(blob) await done(blob); else { const url=dataURLFromCanvas(canvas); if(!url) throw new Error('PNG misslyckades'); await done(url);} }, 'image/png');
        } else {
          const url = dataURLFromCanvas(canvas); if(!url) throw new Error('PNG misslyckades'); await done(url);
        }
      }catch(e){ alert('Kunde inte skapa bild: ' + e.message); }
    };
    /* ======= /DELA SOM BILD ======= */

    // ======== MOLN via Google Apps Script (PER KEY) ========
    function payload(){ return { rows, salary: Number(salary)||0 }; }

    async function cloudSave(){
      if(!CLOUD.endpoint){
        alert('Moln är inte konfigurerat.');
        return;
      }
      try{
        const form = new URLSearchParams();
        form.set('op', 'save');
        form.set('key', getKey());
        form.set('secret', CLOUD.secret || '');
        form.set('data', JSON.stringify(payload()));

        const res = await fetch(CLOUD.endpoint, { method:'POST', body: form });
        const text = await res.text();
        let json; 
        try{ json = JSON.parse(text); }
        catch(_){ throw new Error('Fel från servern: ' + text.slice(0,200)); }
        if(!json.ok) throw new Error(json.error||'Sparning misslyckades');

        cloudInfo.textContent = `Sparat för nyckel: ${getKey()}`;
        updateShareInAddressBar();
        alert('Sparat i molnet.');
      }catch(e){
        alert('Molnfel: ' + e.message);
      }
    }

    async function cloudLoadFromKey(key, quiet=false){
      if(!CLOUD.endpoint){
        alert('Moln är inte konfigurerat.');
        return;
      }
      try{
        const url = `${CLOUD.endpoint}?op=load&key=${encodeURIComponent(key)}`;
        const res = await fetch(url, { method:'GET' });
        const text = await res.text();
        let json; 
        try{ json = JSON.parse(text); }
        catch(_){ 
          console.error('Server raw response:', text);
          throw new Error('Servern svarade inte med JSON. Kolla att du använder exec-URL och rätt behörighet.');
        }

        if(!json.ok){
          if(json.error && json.error.toLowerCase() !== 'not found' && !quiet){
            alert('Molnfel: ' + json.error);
          }
          rows = []; render(); updateTotals(); updateShareInAddressBar();
          cloudInfo.textContent = `Ingen data hittad för nyckel: ${key}`;
          return;
        }

        const d = json.data;
        rows = Array.isArray(d.rows) ? d.rows.map(r=>({
          category:r.category||'',
          amount:Number(r.amount)||0,
          type:r.type||'Utgift',
          pay:(typeof r.pay==='string')?r.pay:'',
          note:r.note||''
        })) : [];
        salary = Number(d.salary)||0; salaryInput.value = salary || '';
        localStorage.setItem(STORAGE_SALARY_KEY, String(salary));
        render(); updateTotals();
        cloudInfo.textContent = `Öppnat nyckel: ${key}`;
        updateShareInAddressBar();
        if(!quiet) alert('Öppnat från molnet.');
      }catch(e){
        console.error(e);
        alert('Molnfel: ' + e.message);
      }
    }
    // ======== /MOLN ========

    // ---- Nollställ ----
    resetBtn.onclick = ()=>{
      if(!confirm('Nollställa ALLT (rader + lön) till 0?')) return;
      rows = [];
      salary = 0;
      salaryInput.value = '';
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(STORAGE_SALARY_KEY);
      try{
        const base = location.origin + location.pathname;
        history.replaceState(null, '', `${base}?key=${encodeURIComponent(getKey())}`);
      }catch(_){}
      render(); updateTotals();
      updateShareInAddressBar();
      alert('Allt är nollställt.');
    };

    // ---- Mörkt läge ----
    darkModeBtn.onclick = ()=>{
      root.classList.toggle('dark');
      const isDark = root.classList.contains('dark');
      localStorage.setItem('budget_app_dark', isDark ? '1' : '0');
      darkModeBtn.textContent = isDark ? 'Ljust läge' : 'Mörkt läge';
    };

    // ---- Lås (manuellt) ----
    lockBtn.onclick = ()=> { forceLock(); };

    // Körs när lås öppnas
    function afterUnlock(){
      cloudLoadFromKey(getKey(), true);
      render();
      updateTotals();
    }

    // GO
    init();
  })();
  </script>
</div>
<!-- ======= /BUDGET-APP ======= -->
